<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DigitalOptic - Logiciel Optique</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4361ee;
            --primary-dark: #3a56d4;
            --secondary-color: #3f37c9;
            --accent-color: #4895ef;
            --light-accent: #4cc9f0;
            --success-color: #4ade80;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-color: #1e293b;
            --light-color: #f8fafc;
            --gray-color: #94a3b8;
            --sidebar-bg: #1e293b;
            --sidebar-text: #e2e8f0;
            --sidebar-hover: #334155;
            --sidebar-active: #4361ee;
            --card-bg: #ffffff;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --border-radius: 8px;
            --transition: all 0.3s ease;
        }
        .notifications-container {
    position: relative;
    display: inline-block;
}

.notifications-icon {
    cursor: pointer;
    position: relative;
}

.notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background-color: #ff4757;
    color: white;
    border-radius: 50%;
    padding: 3px 6px;
    font-size: 10px;
}

.notifications-dropdown {
    display: none;
    position: absolute;
    right: 0;
    width: 300px;
    background: white;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-radius: 5px;
    z-index: 1000;
    max-height: 400px;
    overflow-y: auto;
}

.notifications-dropdown.show {
    display: block;
}

.notifications-header {
    padding: 10px;
    border-bottom: 1px solid #eee;
}

.notifications-list {
    padding: 0;
}

.notification-item {
    padding: 10px;
    border-bottom: 1px solid #f1f1f1;
    color: #ff4757;
    font-size: 13px;
}

.notification-item:last-child {
    border-bottom: none;
}

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Montserrat', sans-serif;
        }

        body {
            background-color: #f1f5f9;
            color: #334155;
        }

        .dashboard {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            width: 280px;
            padding: 1.5rem 1rem;
            transition: var(--transition);
            position: relative;
            z-index: 10;
        }

.logo-container {
    display: flex;
    align-items: center;
}

.logo {
    display: flex;
    align-items: center;
    gap: 10px;
}

.logo-image {
    height: 40px; /* Ajustez selon la taille désirée */
    width: auto; /* Maintient les proportions */
}

.logo span {
    font-weight: bold;
    font-size: 1.2rem;
}
/* Pour un logo avec fond arrondi */
.logo-image {
    height: 40px;
    width: 40px;
    object-fit: contain;
    border-radius: 90%;

}

/* Pour un effet au survol */
.logo:hover .logo-image {
    transform: scale(1.05);
    transition: transform 0.3s ease;
}

        .menu {
            margin-top: 1rem;
        }

        .menu-item {
            margin-bottom: 0.25rem;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .menu-link {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 0.75rem 1rem;
            color: var(--sidebar-text);
            text-decoration: none;
            transition: var(--transition);
            font-weight: 500;
        }

        .menu-link:hover {
            background-color: var(--sidebar-hover);
            color: white;
        }

        .menu-link i:first-child {
            margin-right: 0.75rem;
            width: 20px;
            text-align: center;
        }

        .menu-link .chevron {
            transition: transform 0.3s;
            font-size: 0.8rem;
        }

        .submenu {
            display: none;
            flex-direction: column;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }

        .submenu a {
            font-size: 0.9rem;
            padding: 0.65rem 1rem 0.65rem 2.5rem;
            color: var(--sidebar-text);
            text-decoration: none;
            transition: var(--transition);
            display: flex;
            align-items: center;
        }

        .submenu a i {
            margin-right: 0.75rem;
            font-size: 0.7rem;
            opacity: 0.7;
        }

        .submenu a:hover {
            background-color: var(--sidebar-hover);
            color: white;
            padding-left: 2.75rem;
        }

        .menu-item.active .submenu {
            display: flex;
        }

        .menu-item.active .menu-link .chevron {
            transform: rotate(180deg);
        }

        .menu-item.active .menu-link {
            background-color: var(--sidebar-active);
            color: white;
        }
        .product-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.product-table th, .product-table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

.product-table th {
    background-color: #f8f9fa;
    font-weight: 600;
    position: sticky;
    top: 0;
}

.product-table tr:hover {
    background-color: #f5f5f5;
}

.table-responsive {
    max-height: 70vh;
    overflow-y: auto;
}

.loading-row {
    text-align: center;
    padding: 20px;
}

.loading-row .spinner-border {
    width: 2rem;
    height: 2rem;
}
/* Style pour les filtres */
.filters {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.filter-group {
    display: flex;
    align-items: center;
    gap: 10px;
}

.date-filters {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}

.date-input-group {
    display: flex;
    align-items: center;
    position: relative;
    background: white;
    border-radius: 6px;
    border: 1px solid #ddd;
    padding: 5px;
}

.date-icon {
    padding: 0 10px;
    color: #6c757d;
}

.date-separator {
    padding: 0 5px;
    color: #6c757d;
    font-size: 0.9em;
}

.date-input {
    border: none;
    padding: 8px 12px;
    width: 140px;
}

.date-input:focus {
    outline: none;
    box-shadow: none;
}

.btn-filter {
    background-color: #4e73df;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 6px;
    transition: all 0.3s;
}

.btn-filter:hover {
    background-color: #3a5ec0;
    transform: translateY(-1px);
}

.btn-reset {
    background-color: #f8f9fa;
    color: #6c757d;
    border: 1px solid #ddd;
    padding: 8px 15px;
    border-radius: 6px;
    transition: all 0.3s;
}

.btn-reset:hover {
    background-color: #e9ecef;
}

/* Style pour le tableau */
.table {
    margin-top: 20px;
    border-collapse: separate;
    border-spacing: 0;
}

.table-header {
    background-color: #4e73df;
    color: white;
}

.table-header th {
    padding: 12px 15px;
    font-weight: 500;
}

.table-hover tbody tr:hover {
    background-color: rgba(78, 115, 223, 0.05);
}



.filters-card {
    background: #f8fafc;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.filter-row {
    display: flex;
    gap: 20px;
    align-items: flex-end;
    flex-wrap: wrap;
}

.filter-group {
    flex: 1;
    min-width: 250px;
}

.filter-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #4a5568;
}

.filter-group label i {
    margin-right: 8px;
    color: #4e73df;
}

.date-range {
    display: flex;
    align-items: center;
    gap: 10px;
}

.date-separator {
    color: #718096;
}

.filter-actions {
    display: flex;
    gap: 10px;
}

.table-card {
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.entrees-table {
    width: 100%;
    border-collapse: collapse;
}

.entrees-table th {
    background-color: #4e73df;
    color: white;
    padding: 12px 15px;
    text-align: left;
}

.entrees-table td {
    padding: 12px 15px;
    border-bottom: 1px solid #edf2f7;
}

.entrees-table tr:hover {
    background-color: #f8fafc;
}

.text-right {
    text-align: right;
}

.badge {
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 0.8em;
    font-weight: 500;
}
}
/* Style pour le select d'agence */
.form-control {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    width: 100%;
}

select.form-control {
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 15px;
    padding-right: 30px;
}

.filter-actions {
    display: flex;
    gap: 10px;
    align-items: flex-end;
}

/* Responsive */
@media (max-width: 768px) {
    .filter-row {
        flex-direction: column;
    }
    
    .filter-group {
        width: 100%;
    }
}


/* --- Styles pour le panneau de filtres --- */
.filters-panel {
    background-color: #f0f4f8; /* Un fond léger pour le panneau de filtres */
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 25px;
    display: flex;
    flex-wrap: wrap; /* Permet aux éléments de passer à la ligne */
    gap: 15px; /* Espacement entre les groupes de filtres */
    align-items: flex-end; /* Alignement des boutons de filtre en bas */
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); /* Petite ombre interne */
}

.filter-group {
    flex: 1; /* Permet aux groupes de filtres de prendre de l'espace */
    min-width: 180px; /* Largeur minimale pour chaque groupe */
}

.filter-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #495057;
    font-size: 0.9rem;
}

/* Styles pour les selects (à adapter si vous utilisez un framework CSS comme Bootstrap) */
.form-select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ced4da;
    border-radius: 5px;
    font-size: 1rem;
    background-color: #fff;
    appearance: none; /* Cache la flèche par défaut pour customiser */
    background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%20viewBox%3D%220%200%20292.4%20292.4%22%3E%3Cpath%20fill%3D%22%23000%22%20d%3D%22M287%20197.3L159.9%2069.2c-3.7-3.6-7.8-5.4-12.1-5.4s-8.4%201.8-12.1%205.4L5.4%20197.3c-3.6%203.6-5.4%207.8-5.4%2012.1s1.8%208.4%205.4%2012.1L147.8%20287c3.6%203.6%207.8%205.4%2012.1%205.4s8.4-1.8%2012.1-5.4L287%20221.5c3.6-3.7%205.4-7.8%205.4-12.1s-1.8-8.4-5.4-12.1z%22%2F%3E%3C%2Fsvg%3E'); /* Flèche personnalisée */
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 12px;
    cursor: pointer;
}

.form-select:focus {
    border-color: #80bdff;
    outline: 0;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.filter-actions {
    display: flex;
    gap: 10px;
    align-items: flex-end; /* Aligne les boutons au bas du groupe */
    padding-top: 20px; /* Espace au-dessus des boutons */
}

/* Styles pour les boutons (inspirés de Bootstrap) */
.btn {
    padding: 10px 18px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.2s ease;
    text-align: center;
    white-space: nowrap;
}

.btn-primary {
    background-color: #007bff;
    color: #fff;
    border: 1px solid #007bff;
}

.btn-primary:hover {
    background-color: #0056b3;
    border-color: #004085;
}

.btn-outline-secondary {
    background-color: transparent;
    color: #6c757d;
    border: 1px solid #6c757d;
}

.btn-outline-secondary:hover {
    color: #fff;
    background-color: #6c757d;
}

.btn-success { /* Pour le bouton de sélection dans le tableau */
    background-color: #28a745;
    color: #fff;
    border: 1px solid #28a745;
}

.btn-success:hover {
    background-color: #218838;
    border-color: #1e7e34;
}

.btn-icon { /* Style pour les boutons avec icônes */
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px; /* Espacement entre l'icône et le texte */
}

/* --- Styles pour le tableau --- */
.table-container {
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08); /* Ombre plus prononcée pour la table */
    overflow: hidden; /* Assure que les bordures arrondies sont respectées */
}

.table-responsive {
    max-height: 400px; /* Hauteur maximale pour le tableau scrollable */
    overflow-y: auto; /* Permet le défilement vertical du tableau */
    border-radius: 8px; /* Bordures arrondies pour le conteneur scrollable */
}

.verre-catalogue-table {
    width: 100%;
    border-collapse: collapse; /* Supprime les espacements entre les cellules */
    margin: 0; /* Supprime la marge par défaut des tables */
}

.verre-catalogue-table thead th {
    background-color: #495057; /* Couleur foncée pour l'en-tête */
    color: #fff;
    padding: 12px 15px;
    text-align: left;
    font-size: 0.95rem;
    border-bottom: 2px solid #343a40; /* Ligne plus épaisse sous l'en-tête */
    position: sticky; /* Fige l'en-tête lors du défilement */
    top: 0;
    z-index: 1; /* Assure que l'en-tête est au-dessus du contenu défilant */
}

.verre-catalogue-table tbody td {
    padding: 10px 15px;
    border-bottom: 1px solid #e9ecef; /* Ligne de séparation légère entre les lignes */
    vertical-align: middle; /* Aligne le contenu des cellules au milieu */
}

.verre-catalogue-table tbody tr:hover {
    background-color: #f2f7fc; /* Changement de couleur au survol */
}

.verre-catalogue-table tbody tr:last-child td {
    border-bottom: none; /* Pas de bordure sous la dernière ligne */
}

.text-right {
    text-align: right;
}
.text-center {
    text-align: center;
}

/* Spinner de chargement */
.spinner-border {
    width: 3rem;
    height: 3rem;
    margin: 30px auto;
    display: block;
    color: #007bff; /* Couleur du spinner */
    border: 0.25em solid currentColor;
    border-right-color: transparent;
    border-radius: 50%;
    animation: spinner-border .75s linear infinite;
}

@keyframes spinner-border {
    to { transform: rotate(360deg); }
}

/* Messages d'information */
.alert {
    padding: 15px;
    border-radius: 5px;
    margin-top: 15px;
    font-size: 0.95rem;
}

.alert-info {
    background-color: #e0f2f7; /* Couleur de fond légère pour info */
    color: #007bff; /* Couleur de texte pour info */
    border: 1px solid #bee5eb;
}

    .filters-panel {
        flex-direction: column; /* Les filtres s'empilent verticalement */
        align-items: stretch; /* Les éléments s'étirent */
    }
    .filter-group {
        min-width: unset; /* Supprime la largeur minimale */
    }
    .filter-actions {
        flex-direction: column;
        gap: 10px;
    }
    .btn {
        width: 100%; /* Les boutons prennent toute la largeur */
    }
}
/* Style pour aligner les filtres et boutons */
.compact-filters .filter-row {
    display: flex;
    flex-wrap: wrap;
    align-items: flex-end;
    gap: 12px;
    margin-bottom: 15px;
}

.compact-filters .filter-group {
    flex: 1;
    min-width: 180px;
}

.compact-filters .filter-action {
    flex: 0 0 auto;
    margin-bottom: 15px; /* Alignement vertical avec les champs */
}

.compact-filters label {
    display: block;
    margin-bottom: 5px;
    font-size: 0.9em;
    font-weight: 500;
}

.compact-filters .form-select {
    width: 100%;
}

/* Responsive */
@media (max-width: 768px) {
    .compact-filters .filter-group,
    .compact-filters .filter-action {
        min-width: 100%;
    }
    
    .compact-filters .filter-action button {
        width: 100%;
    }
}

  /* General fin */
        /* Main Content */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background-color: var(--card-bg);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: var(--dark-color);
            font-size: 1.25rem;
            margin-right: 1rem;
            cursor: pointer;
        }

        .page-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .notifications {
            position: relative;
            cursor: pointer;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: bold;
        }

        .profile-dropdown {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .profile-name {
            font-weight: 500;
        }

        .profile-img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent-color);
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--card-bg);
            min-width: 200px;
            box-shadow: var(--card-shadow);
            border-radius: var(--border-radius);
            z-index: 10;
            padding: 0.5rem 0;
        }

        .dropdown-menu a {
            color: var(--dark-color);
            padding: 0.75rem 1.5rem;
            text-decoration: none;
            display: flex;
            align-items: center;
            transition: var(--transition);
        }

        .dropdown-menu a:hover {
            background-color: #f1f5f9;
            color: var(--primary-color);
        }

        .dropdown-menu a i {
            margin-right: 0.75rem;
            width: 20px;
            text-align: center;
        }

        .profile-dropdown:hover .dropdown-menu {
            display: block;
        }

        /* Dashboard Content */
        .dashboard-section {
            padding: 1.5rem;
            flex: 1;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .dashboard-header h1 {
            font-size: 1.75rem;
            color: var(--dark-color);
            font-weight: 600;
        }

        .dashboard-buttons {
            display: flex;
            gap: 0.75rem;
        }

        .btn {
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: white;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .btn-secondary:hover {
            background-color: #f8fafc;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .quick-action-btn {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 1.5rem;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            cursor: pointer;
            border: none;
            text-align: left;
        }

        .quick-action-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .quick-action-btn i {
            font-size: 1.75rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 50%;
            background-color: rgba(72, 149, 239, 0.1);
            color: var(--accent-color);
        }

        .quick-action-btn .btn-text {
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 0.25rem;
        }

        .quick-action-btn .btn-desc {
            font-size: 0.85rem;
            color: var(--gray-color);
        }

        /* Client Table Section */
        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title i {
            color: var(--accent-color);
        }

        .search-container {
            position: relative;
        }

        .search-container i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
        }

        .search-container input {
            padding: 0.5rem 1rem 0.5rem 2.25rem;
            border: 1px solid #e2e8f0;
            border-radius: var(--border-radius);
            width: 250px;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .search-container input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(72, 149, 239, 0.2);
        }

        /* Table Styles */
        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            background-color: #f8fafc;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            cursor: pointer;
            position: relative;
            white-space: nowrap;
        }

        th:hover {
            background-color: #f1f5f9;
        }

        th.sorted-asc::after {
            content: " \25B2";
            font-size: 0.7em;
            margin-left: 5px;
            color: var(--accent-color);
        }

        th.sorted-desc::after {
            content: " \25BC";
            font-size: 0.7em;
            margin-left: 5px;
            color: var(--accent-color);
        }

        tr:hover {
            background-color: #f8fafc;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-active {
            background-color: rgba(74, 222, 128, 0.1);
            color: var(--success-color);
        }

        .status-inactive {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }

        .client-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
        }

        .client-link:hover {
            color: var(--primary-dark);
            text-decoration: underline;
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--gray-color);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: var(--transition);
        }

        .action-btn:hover {
            color: var(--primary-color);
            background-color: #f1f5f9;
        }

        /* Pagination */
        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1.5rem;
            padding: 0.75rem 0;
        }

        .pagination-info {
            font-size: 0.9rem;
            color: var(--gray-color);
        }

        .pagination-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .pagination-btn {
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
            background-color: white;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .pagination-btn:hover:not(:disabled) {
            background-color: #f1f5f9;
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .items-per-page {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .items-per-page select {
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
            background-color: white;
        }

        /* Loading and Error States */
        .loading-indicator {
            text-align: center;
            padding: 2rem;
            display: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f1f5f9;
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: var(--danger-color);
            text-align: center;
            padding: 2rem;
            display: none;
            background-color: rgba(239, 68, 68, 0.05);
            border-radius: var(--border-radius);
            margin: 1rem 0;
        }

        .no-clients-message {
            text-align: center;
            padding: 2rem;
            color: var(--gray-color);
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            margin: 1rem 0;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                width: 240px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                bottom: 0;
                z-index: 100;
                transition: var(--transition);
            }

            .sidebar.active {
                left: 0;
            }

            .mobile-menu-btn {
                display: block;
            }

            .main {
                margin-left: 0;
            }

            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .dashboard-buttons {
                width: 100%;
                justify-content: flex-start;
            }

            .search-container input {
                width: 100%;
            }

            .quick-actions {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 576px) {
            .header {
                padding: 1rem;
            }

            .dashboard-section {
                padding: 1rem;
            }

            .quick-actions {
                grid-template-columns: 1fr;
            }

            .pagination-controls {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .profile-name {
                display: none;
            }
        }

        /* Print Styles */
        @media print {
            .sidebar, .header, .dashboard-buttons, .quick-actions, .search-container, .pagination-controls {
                display: none !important;
            }

            .dashboard-section {
                padding: 0;
            }

            table {
                width: 100%;
                border-collapse: collapse;
            }

            th, td {
                border: 1px solid #ddd;
                padding: 8px;
            }

            tr:nth-child(even) {
                background-color: #f2f2f2;
            }
        }

        /* Form Group Styles */
.form-group {
    margin-bottom: 20px; /* More space between fields */
}

.form-group label {
    display: block;
    margin-bottom: 8px; /* Space between label and input */
    font-weight: 600; /* Bolder labels */
    color: #555;
    font-size: 0.95rem;
}

.form-group .required {
    color: var(--danger-color, #dc3545); /* Use a variable for danger color */
    font-weight: normal;
}

.form-control {
    width: 100%;
    padding: 12px 15px; /* More padding inside inputs */
    border: 1px solid #ddd;
    border-radius: 8px; /* Rounded input fields */
    font-size: 1rem;
    color: #333;
    box-sizing: border-box; /* Include padding and border in the element's total width and height */
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.form-control:focus {
    border-color: var(--primary-color, #007bff); /* Highlight on focus */
    box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2); /* Soft glow */
    outline: none;
}

.form-control.invalid {
    border-color: var(--danger-color, #dc3545);
}

.select-control {
    /* Specific styles for select elements if needed */
    appearance: none; /* Remove default arrow */
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236c757d'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E"); /* Custom arrow */
    background-repeat: no-repeat;
    background-position: right 15px center;
    background-size: 16px;
    padding-right: 40px; /* Space for the custom arrow */
}

/* Button Styles (make them consistent if not already) */
.btn {
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
}

.btn-primary {
    background-color: var(--primary-color, #4361ee);
    color: #fff;
    border: 1px solid var(--primary-color, #4361ee);
}

.btn-primary:hover {
    background-color: #3650d9; /* Darker shade on hover */
    border-color: #3650d9;
}

.btn-secondary {
    background-color: #6c757d;
    color: #fff;
    border: 1px solid #6c757d;
}

.btn-secondary:hover {
    background-color: #5a6268;
    border-color: #545b62;
}
        /* Loading Spinner */
.loading-spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--primary-color, #4361ee);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 20px auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Form Message (Success/Error) */
.form-message {
    margin-top: 15px;
    padding: 10px 15px;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 500;
    text-align: center;
    opacity: 0; /* Hidden by default */
    height: 0;
    overflow: hidden;
    transition: opacity 0.3s ease, height 0.3s ease, padding 0.3s ease;
}

.form-message.success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
    opacity: 1;
    height: auto;
    padding: 10px 15px;
}

.form-message.error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
    opacity: 1;
    height: auto;
    padding: 10px 15px;
}

 /* fin depense    */   

 
        /* Styles du formulaire (simplifiés pour la modale) */
        .form-container {
            max-width: 100%;
        }

        .stepper {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            position: relative;
        }

        .stepper::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #e2e8f0;
            z-index: 1;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e2e8f0;
            color: #64748b;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 0.5rem;
            border: 3px solid white;
        }

        .step.active .step-number {
            background-color: #4361ee;
            color: white;
        }

        .step.completed .step-number {
            background-color: #4ade80;
            color: white;
        }

        .step-label {
            font-size: 0.85rem;
            color: #64748b;
            text-align: center;
            max-width: 100px;
        }

        .step.active .step-label {
            color: #4361ee;
            font-weight: 500;
        }

        .step.completed .step-label {
            color: #4ade80;
        }

        .form-section {
            display: none;
        }

        .form-section.active {
            display: block;
        }

        .section-title {
            color: #4361ee;
            border-bottom: 2px solid #4361ee;
            padding-bottom: 0.5rem;
            margin: 1rem 0;
            font-size: 1.1rem;
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #1e293b;
        }

        .required-field::after {
            content: ' *';
            color: #ef4444;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 1rem;
        }

        .prescription-table-container {
            overflow-x: auto;
            margin: 1rem 0;
        }

        .prescription-table {
            width: 100%;
            border-collapse: collapse;
        }

        .prescription-table th {
            background-color: #4361ee;
            color: white;
            padding: 0.75rem;
            text-align: center;
        }

        .prescription-table td {
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            text-align: center;
        }

        .form-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }

        .btn {
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background-color: #4361ee;
            color: white;
        }

        .btn-secondary {
            background-color: white;
            color: #4361ee;
            border: 1px solid #4361ee;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .form-group {
                min-width: 100%;
            }
            
            .stepper {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .step {
                flex: none;
                width: calc(50% - 0.25rem);
            }
        }
    </style>
        <style>
/* ================================
   MODAL - STYLE UNIFIÉ
   ================================ */

/* Overlay sombre */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    z-index: 1000;
    padding: 20px; /* espace pour mobile */
    pointer-events: none;
}

.modal-overlay.active {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
}

/* Contenu principal */
.modal-content {
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    width: 90%;
    max-width: auto;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    transform: translateY(-20px);
    transition: transform 0.3s ease;
    overflow: hidden;
}

.modal-overlay.active .modal-content {
    transform: translateY(0);
}

/* Variante pour modals larges */
.modal-content.large-modal {
    max-width: 1200px;
    width: 95%;
}

/* Header */
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 18px 25px;
    border-bottom: 1px solid #eee;
    background-color: #f8f9fa;
    flex-shrink: 0;
}

.modal-title {
    margin: 0;
    font-size: 1.3rem;
    font-weight: 600;
    color: #333;
    display: flex;
    align-items: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.modal-title i {
    margin-right: 10px;
    color: #007bff;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.8rem;
    color: #999;
    cursor: pointer;
    padding: 5px;
    transition: color 0.2s ease;
}

.modal-close:hover {
    color: #dc3545;
}

/* Corps */
.modal-body {
    flex: 1;
    padding: 25px;
    overflow-y: auto;
}

/* Pied */
.modal-footer {
    display: flex;
    justify-content: flex-end;
    padding: 15px 25px;
    border-top: 1px solid #eee;
    background-color: #f8f9fa;
    gap: 80px;
    flex-shrink: 0;
    border-bottom-left-radius: 12px;
    border-bottom-right-radius: 12px;
}

/* Bouton de fermeture personnalisé */
.btn-close-modal {
    background-color: #6c757d;
    color: white;
    border: none;
    padding: 8px 20px;
    border-radius: 6px;
}

.btn-close-modal:hover {
    background-color: #5a6268;
}

/* Responsive */
@media (max-width: 768px) {
    .modal-overlay {
        padding: 10px;
    }
    .modal-content {
        width: 100%;
        height: 95vh;
    }
    .modal-title {
        font-size: 1.1rem;
    }
}

@media (max-width: 576px) {
    .modal-title {
        font-size: 1rem;
    }
    .modal-close {
        font-size: 1.5rem;
    }
}


/* Proforma */
#proformaModal.modal-overlay {
    display: none; /* caché par défaut */
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    z-index: 2000;
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.3s ease-out;
}

/* Quand le modal est actif */
#proformaModal.active {
    display: flex;
}

/* Conteneur du contenu */
#proformaModal .modal-container {
    background: #fff;
    border-radius: 12px;
    width: 80%;
    max-width: 900px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    animation: slideDown 0.3s ease-out;
    padding: 1rem;
}

/* Header */
#proformaModal .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px solid #f0f0f0;
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
}

#proformaModal .modal-title {
    font-size: 1.4rem;
    font-weight: bold;
    color: #333;
}

#proformaModal .modal-close {
    background: transparent;
    border: none;
    font-size: 1.8rem;
    cursor: pointer;
    color: #888;
}

#proformaModal .modal-close:hover {
    color: #e74c3c;
}

/* Body */
#proformaModal .modal-body {
    padding: 0.5rem 0;
}

/* Stepper */
#proformaModal .stepper {
    display: flex;
    justify-content: space-between;
    margin-bottom: 1.5rem;
}

#proformaModal .step {
    text-align: center;
    flex: 1;
    position: relative;
}

#proformaModal .step-number {
    background: #ccc;
    color: white;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: auto;
}

#proformaModal .step.active .step-number {
    background: #3498db;
}

#proformaModal .step-label {
    font-size: 0.85rem;
    margin-top: 0.3rem;
}

/* Sections */
#proformaModal .form-section {
    display: none;
}

#proformaModal .form-section.active {
    display: block;
}

/* Navigation */
#proformaModal .form-navigation {
    margin-top: 1rem;
    display: flex;
    justify-content: space-between;
    gap: 0.5rem;
}

#proformaModal .btn {
    padding: 0.5rem 1rem;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-weight: 500;
}

#proformaModal .btn-primary {
    background: #3498db;
    color: white;
}

#proformaModal .btn-primary:hover {
    background: #2980b9;
}

#proformaModal .btn-secondary {
    background: #bdc3c7;
    color: #333;
}

#proformaModal .btn-secondary:hover {
    background: #95a5a6;
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideDown {
    from { transform: translateY(-20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
.loader-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 9999;
    display: none;
    justify-content: center;
    align-items: center;
}

.loader-overlay.active {
    display: flex;
}

.loader-content {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    text-align: center;
}

.loader-spinner {
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
/* Fin proforma */

        /* Ajout vente */
        :root {
            --primary-color: #4361ee;
            --primary-dark: #3a56d4;
            --secondary-color: #3f37c9;
            --accent-color: #4895ef;
            --light-accent: #4cc9f0;
            --success-color: #4ade80;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-color: #1e293b;
            --light-color: #f8fafc;
            --gray-color: #94a3b8;
            --card-bg: #ffffff;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --border-radius: 8px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Montserrat', sans-serif;
        }

 
        /* Rest of your existing form styles... */
        /* (Keep all your existing form styles from the original code) */
        
        /* Indicateur d'étapes */
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            position: relative;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--gray-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 0.5rem;
            transition: var(--transition);
        }

        .step.active .step-number {
            background-color: var(--primary-color);
        }

        .step.completed .step-number {
            background-color: var(--success-color);
        }

        .step-label {
            font-size: 0.85rem;
            color: var(--gray-color);
            text-align: center;
            transition: var(--transition);
        }

        .step.active .step-label {
            color: var(--primary-color);
            font-weight: 500;
        }

        .step.completed .step-label {
            color: var(--success-color);
        }

        .step-progress {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 4px;
            background-color: #e2e8f0;
            z-index: 1;
        }

        .step-progress-bar {
            height: 100%;
            background-color: var(--success-color);
            width: 0%;
            transition: var(--transition);
        }

        /* Contenu des étapes */
        .form-step {
            display: none;
            background-color: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            margin-bottom: 1.5rem;
        }

        .form-step.active {
            display: block;
        }

        /* Grille de formulaire */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark-color);
        }

        .required-field::after {
            content: ' *';
            color: var(--danger-color);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-control:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(72, 149, 239, 0.2);
        }

        /* Tableau de prescription */
        .prescription-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            background-color: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }

        .prescription-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: 600;
        }

        .prescription-table td {
            padding: 1rem;
            border: 1px solid #e2e8f0;
            text-align: center;
        }

        .prescription-table select,
        .prescription-table input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            background-color: white;
        }

        /* Section paiement */
        .payment-card {
            background-color: #f8fafc;
            padding: 1rem;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
            margin-bottom: 1rem;
        }

        .payment-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .payment-group {
            flex: 1;
            min-width: 200px;
        }

        .payment-label {
            font-size: 0.85rem;
            color: var(--gray-color);
            margin-bottom: 0.25rem;
        }

        .payment-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .discount-selector {
            display: flex;
            gap: 0.5rem;
        }

        .discount-selector input {
            flex: 2;
        }

        .discount-selector select {
            flex: 1;
        }

        /* Navigation entre les étapes */
        .step-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e2e8f0;
            gap: 0.75rem; /* Ajout d'un espacement entre les boutons */
            flex-wrap: wrap; /* Permettre le retour à la ligne sur petits écrans */
        }

        .btn {
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: white;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .btn-secondary:hover {
            background-color: #f8fafc;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        /* Loader */
        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loader-content {
            background-color: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .loader {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        .loader-message {
            color: var(--dark-color);
            margin-top: 1rem;
            font-size: 1.1rem;
            font-weight: 500;
        }

        .loader-details {
            color: var(--gray-color);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .loader-visible {
            opacity: 1;
            visibility: visible;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            background-color: var(--success-color);
            color: white;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 15px;
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .error-message {
            background-color: var(--danger-color);
            color: white;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 15px;
            display: none;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .payment-row {
                flex-direction: column;
            }
            
            .step-navigation {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .step-navigation .btn {
                width: 100%;
            }
        }
        .select-with-input {
    position: relative;
}

.btn-small {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
    background-color: #f8fafc;
    border: 1px solid #e2e8f0;
}

.btn-small:hover {
    background-color: #e2e8f0;
}


@keyframes buttonHighlight {
  0% {
    transform: scale(1);
    box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
  }
  50% {
    transform: scale(1.05);
    box-shadow: 0 0 10px 5px rgba(40, 167, 69, 0);
  }
  100% {
    transform: scale(1);
    box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
  }
}

.btn-success.highlight {
  animation: buttonHighlight 3s ease-out;
}


.confirmation-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
}

.confirmation-box {
    background: white;
    padding: 25px;
    border-radius: 8px;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    text-align: center;
}

.confirmation-box h3 {
    margin-top: 0;
    color: #333;
}

.confirmation-box p {
    margin-bottom: 20px;
    color: #666;
}

.confirmation-buttons {
    display: flex;
    justify-content: center;
    gap: 10px;
}

.btn-confirm {
    background-color: #4CAF50;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
}

.btn-cancel {
    background-color: #f44336;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
}

.btn-confirm:hover {
    background-color: #45a049;
}

.btn-cancel:hover {
    background-color: #d32f2f;
}

.status-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.status-content {
    background: white;
    padding: 25px;
    border-radius: 8px;
    text-align: center;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.status-spinner {
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
}

.status-content.success {
    border: 2px solid #4CAF50;
}

.status-icon {
    color: #4CAF50;
    font-size: 3rem;
    margin-bottom: 1rem;
    display: block;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
    </style>
</head>
<body>
    <div class="dashboard">
          <!-- Barre lateral unique debut -->
        <aside class="sidebar">
<div class="logo-container">
    <div class="logo">
        <img src="logo.png" alt="Digital Optic Logo" class="logo-image">
        <span>DIGITAL OPTIC</span>
    </div>
</div>

            <nav class="menu">
                <div class="menu-item">
                    <a class="menu-link">
                        <i class="fas fa-home"></i>
                        <span>Tableau de bord</span>
                        <i class="fas fa-chevron-down chevron"></i>
                    </a>
                    <div class="submenu">
                        <a href="#" onclick="openVueGlobale()"><i class="fas fa-chart-line"></i> Vue Globale</a>
                        <a href="#" onclick="openLooker()"><i class="fas fa-chart-pie"></i> Statistiques</a>
                        
                    </div>
                </div>

                <div class="menu-item active">
                    <a class="menu-link">
                        <i class="fas fa-shopping-cart"></i>
                        <span>Gestion des Ventes</span>
                        <i class="fas fa-chevron-down chevron"></i>
                    </a>
                    <div class="submenu">
                        <a href="#" onclick="openNewSale()"><i class="fas fa-plus-circle"></i> Nouvelle Vente</a>
                        <div id="vente-loader" style="display:none;">
    <div class="loader-spinner"></div>
    <span id="vente-status">Chargement...</span>
</div>

                        <a href="#" onclick="openDevis()"><i class="fas fa-file-invoice"></i> Proforma</a>
                    </div>
                </div>

                <div class="menu-item">
                    <a class="menu-link">
                        <i class="fas fa-boxes"></i>
                        <span>Gestion Stock</span>
                        <i class="fas fa-chevron-down chevron"></i>
                    </a>
                    <div class="submenu">
                        <a href="#" onclick="openProductEntryForm()"><i class="fas fa-plus"></i> Entrée Produit</a>
                        <a href="#"><i class="fas fa-minus"></i> Destockage</a>
                        <a href="#" onclick="openListeProduit()"><i class="fas fa-glasses"></i> Liste des Produits</a>
                    </div>
                </div>

                <div class="menu-item">
                    <a class="menu-link">
                        <i class="fas fa-shield-alt"></i>
                        <span>Assurances</span>
                        <i class="fas fa-chevron-down chevron"></i>
                    </a>
                    <div class="submenu">
                        <a href="#" onclick="openDealsAssurance()"><i class="fas fa-building"></i> Deals Assurance</a>
                        <a href="#"><i class="fas fa-truck"></i> Facturation</a>
                        <a href="#" onclick="openPointFacturation()"><i class="fas fa-file-contract"></i> Point des Facturation</a>
                    </div>
                </div>

                <div class="menu-item">
                    <a class="menu-link">
                        <i class="fas fa-boxes"></i>
                        <span>Catalogue Produit</span>
                        <i class="fas fa-chevron-down chevron"></i>
                    </a>
                    <div class="submenu">
                         <a href="#" onclick="openListeMonture()"><i class="fas fa-glasses"></i> Montures</a>
                        <a href="#" onclick="openListeVerre('verre')"><i class="fas fa-eye"></i> Verres</a>
                        <a href="#" onclick="openCatalogueVerre('catalogueVerre')"><i class="fas fa-eye"></i> Catalogue Produit</a>
                    </div>
                </div>

                <div class="menu-item">
                    <a class="menu-link">
                        <i class="fas fa-cash-register"></i>
                        <span>Gestion de Caisse</span>
                        <i class="fas fa-chevron-down chevron"></i>
                    </a>
                    <div class="submenu">
                        <a href="#" onclick="openEntreesJournal()">
                            <i class="fas fa-sign-in-alt"></i> Journal des Entrées
                        </a>
                        <a href="#" onclick="openDepensesJournal()">
                            <i class="fas fa-sign-out-alt"></i> Journal des Dépenses
                        </a>
                    </div>
                </div>


                <div class="menu-item">
                    <a class="menu-link">
                        <i class="fas fa-users-cog"></i>
                        <span>Administration</span>
                        <i class="fas fa-chevron-down chevron"></i>
                    </a>
                    <div class="submenu">
                        <a href="#" onclick="openAddUserForm()"><i class="fas fa-user-plus"></i> Ajouter un Utilisateur</a>
                    </div>
                </div>
            </nav>
        </aside>

        <div class="main">
            <header class="header">
                <div class="header-left">
                    <button class="mobile-menu-btn" id="mobileMenuBtn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title">Mon Espace</h1>
                </div>
                
                <div class="user-info">
<div class="notifications-container">
    <div class="notifications-icon">
        <i class="fas fa-bell"></i>
        <span class="notification-badge">0</span>
    </div>
    <div class="notifications-dropdown">
        <div class="notifications-header">
            <h4>Historique des Erreurs</h4>
        </div>
        <div class="notifications-list">
            <!-- Les erreurs seront ajoutées ici dynamiquement -->
        </div>
    </div>
</div>
                    
                    <div class="profile-dropdown">
                        <span class="profile-name" id="username-display"></span>
                        <img src="https://ui-avatars.com/api/?name=John+Doe&background=4361ee&color=fff" alt="Profile" class="profile-img">
                        <div class="dropdown-menu">
                            <a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Déconnexion</a>
                        </div>
                    </div>
                </div>
            </header>
<script>
    function openLooker() {
    if (!hasAdminRights()) {
        alert("⛔ Accès refusé");
        return;
    }

    window.open(
        'https://lookerstudio.google.com/u/0/reporting/555ea25c-4117-4351-b083-d770072292dd/page/TlJ0C',
        '_blank'
    );
}
    // Fonction combinée pour la gestion des menus et l'ouverture de nouvelle vente
    (function() {
        // Gestion des menus déroulants
        document.querySelectorAll('.menu-link').forEach(link => {
            link.addEventListener('click', function(e) {
                // Empêche le comportement par default si c'est un lien
                if (e.target.href) e.preventDefault();

                const currentItem = this.parentElement;

                // Fermer toutes les autres sections
                document.querySelectorAll('.menu-item').forEach(item => {
                    if (item !== currentItem) item.classList.remove('active');
                });

                // Basculer l'état de la section cliquée
                currentItem.classList.toggle('active');
            });
        });

        // Fonction pour ouvrir Acceuil
        window.openVueGlobale = function() {
            try {
                const salePath = 'Accueil.html';
                window.location.href = salePath;
            } catch (error) {
                console.error("Erreur d'ouverture:", error);
                alert("Impossible d'ouvrir la page. Contactez l'administrateur.");
            }
        };
    })();
// ouvrir le catalogue Verre
window.openCatalogueVerre = function() {
    const pdfPath = 'Catalogue.pdf';
    window.open(pdfPath, '_blank');
};
    
window.openProductEntryForm = function() {
    const modalContainer = document.getElementById('modal-container');

    const modalHTML = `
        <div class="modal-overlay" id="productModal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3 class="modal-title">Entrée de Produit</h3>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
        <div class="form-group">
            <label for="productCategory">Catégorie</label>
            <div class="select-with-input">
                <select name="productCategory" id="productCategory" class="form-control">
                                <option value="">-- Sélectionnez une catégorie --</option>
                                <option value="monture">Monture</option>
                                <option value="verre">Verre</option>
                                <option value="etui">Etuis</option>
                                <option value="nettoyant">Nettoyant</option>
                </select>
                <input type="text" id="productCategory_input" class="form-control" style="display: none; margin-top: 5px;" 
                       placeholder="Ajouter">
            </div>
            <button type="button" class="btn btn-small" onclick="toggleInput('productCategory')" 
                    style="margin-top: 5px; padding: 0.25rem 0.5rem;">
                <i class="fas fa-plus"></i> Ajouter
            </button>
        </div>
                        
                        <div id="dynamicFields"></div>
                        
                        <div class="form-group">
                            <label for="productQuantity">Quantité <span class="required">*</span></label>
                            <input type="number" id="productQuantity" class="form-control" min="1" required>
                        </div>
                        
                        <div id="product-message" class="form-message"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="submitProductForm()">Enregistrer</button>
                </div>
            </div>
        </div>
    `;

    modalContainer.innerHTML = modalHTML;

    setTimeout(() => {
        document.getElementById('productModal').classList.add('active');
    }, 10);
};

// Fonction pour mettre à jour les champs en fonction de la catégorie sélectionnée
function updateProductFields() {
    const category = document.getElementById('productCategory').value;
    const dynamicFields = document.getElementById('dynamicFields');
    
    let fieldsHTML = '';
    
    switch(category) {
        case 'monture':
            fieldsHTML = `
                <div class="form-group">
                    <label for="montureReference">Référence Monture <span class="required">*</span></label>
                    <input type="text" id="montureReference" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="montureColor">Code Couleur <span class="required">*</span></label>
                    <input type="text" id="montureColor" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="montureSupplier">Fournisseur <span class="required">*</span></label>
                    <select id="montureSupplier" class="form-control" required>
                        <option value="">-- Sélectionnez --</option>
                        <option value="SIVO">SIVO</option>
                        <option value="Tokai">Tokai</option>
                    </select>
                </div>
            `;
            break;
            
        case 'verre':
            fieldsHTML = `
                <div class="form-group">
                    <label for="verreSphere">SPHERE <span class="required">*</span></label>
                    <input type="text" id="verreSphere" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="verreCylindre">CYLINDRE <span class="required">*</span></label>
                    <input type="text" id="verreCylindre" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="verreAdd">ADD <span class="required">*</span></label>
                    <input type="text" id="verreAdd" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="verreDiametre">Diamètre <span class="required">*</span></label>
                    <input type="text" id="verreDiametre" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="verreSupplier">Fournisseur <span class="required">*</span></label>
                    <input type="text" id="verreSupplier" class="form-control" required>
                </div>
            `;
            break;
            
        case 'etui':
            fieldsHTML = `
                <div class="form-group">
                    <label for="etuiReference">Référence <span class="required">*</span></label>
                    <input type="text" id="etuiReference" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="etuiSupplier">Fournisseur <span class="required">*</span></label>
                    <input type="text" id="etuiSupplier" class="form-control" required>
                </div>
            `;
            break;
            
        case 'nettoyant':
            fieldsHTML = `
                <div class="form-group">
                    <label for="nettoyantSupplier">Fournisseur <span class="required">*</span></label>
                    <input type="text" id="nettoyantSupplier" class="form-control" required>
                </div>
            `;
            break;
            
        case 'autre':
            fieldsHTML = `
                <div class="form-group">
                    <label for="autreReference">Référence</label>
                    <input type="text" id="autreReference" class="form-control">
                </div>
                <div class="form-group">
                    <label for="autreInfo">Informations utiles</label>
                    <textarea id="autreInfo" class="form-control" rows="2"></textarea>
                </div>
            `;
            break;
            
        default:
            fieldsHTML = '';
    }
    
    dynamicFields.innerHTML = fieldsHTML;
}

// Fonction pour soumettre le formulaire de produit
async function submitProductForm() {
    const form = document.getElementById('productForm');
    const formMessage = document.getElementById('product-message');
    formMessage.textContent = '';
    formMessage.className = 'form-message';

    if (!form.checkValidity()) {
        form.reportValidity();
        formMessage.textContent = 'Veuillez remplir tous les champs obligatoires.';
        formMessage.classList.add('error');
        return;
    }

    const category = document.getElementById('productCategory').value;
    const quantity = document.getElementById('productQuantity').value;
    
    let productData = {
        category: category,
        quantity: quantity
    };

    // Ajouter les champs spécifiques à la catégorie
    switch(category) {
        case 'monture':
            productData.reference = document.getElementById('montureReference').value;
            productData.color = document.getElementById('montureColor').value;
            productData.supplier = document.getElementById('montureSupplier').value;
            break;
            
        case 'verre':
            productData.sphere = document.getElementById('verreSphere').value;
            productData.cylindre = document.getElementById('verreCylindre').value;
            productData.add = document.getElementById('verreAdd').value;
            productData.diametre = document.getElementById('verreDiametre').value;
            productData.supplier = document.getElementById('verreSupplier').value;
            break;
            
        case 'etui':
            productData.reference = document.getElementById('etuiReference').value;
            productData.supplier = document.getElementById('etuiSupplier').value;
            break;
            
        case 'nettoyant':
            productData.supplier = document.getElementById('nettoyantSupplier').value;
            break;
            
        case 'autre':
            productData.reference = document.getElementById('autreReference').value;
            productData.info = document.getElementById('autreInfo').value;
            break;
    }

    const submitButton = document.querySelector('#productModal .btn-primary');
    submitButton.disabled = true;
    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enregistrement...';

    try {
        const apiUrl = "https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=addProduct";

        await fetch(apiUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(productData)
        });

        formMessage.textContent = '✅ Produit enregistré avec succès!';
        formMessage.classList.add('success');

        form.reset();
        document.getElementById('dynamicFields').innerHTML = '';

        setTimeout(() => {
            closeModal();
        }, 1500);

    } catch (error) {
        console.error("Erreur:", error);
        formMessage.innerHTML = `❌ ${error.message || "Une erreur est survenue lors de l'enregistrement"}`;
        formMessage.classList.add('error');
    } finally {
        submitButton.disabled = false;
        submitButton.textContent = 'Enregistrer';
    }
}
    // Fonction pour ouvrir le tableau des produits par catégorie
function openProductTable(category) {
    const modalContainer = document.getElementById('modal-container');
    
    const modalHTML = `
        <div class="modal-overlay" id="productTableModal">
            <div class="modal-content" style="max-width: 90%; width: 900px;">
                <div class="modal-header">
                    <h3 class="modal-title">Stock: ${capitalizeFirstLetter(category)}</h3>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="product-table" id="productTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Référence</th>
                                    ${category === 'verre' ? '<th>Sphere</th><th>Cylindre</th><th>Add</th><th>Diamètre</th>' : ''}
                                    ${category === 'monture' ? '<th>Couleur</th>' : ''}
                                    <th>Quantité</th>
                                    <th>Fournisseur</th>
                                    ${category === 'autre' ? '<th>Informations</th>' : ''}
                                </tr>
                            </thead>
                            <tbody id="productTableBody">
                                <tr>
                                    <td colspan="${category === 'verre' ? 8 : category === 'monture' ? 6 : category === 'autre' ? 5 : 4}" class="loading-row">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="sr-only">Chargement...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Fermer</button>
                </div>
            </div>
        </div>
    `;

    modalContainer.innerHTML = modalHTML;
    document.getElementById('productTableModal').classList.add('active');
    
    // Charger les données
    loadProductData(category);
}

// Fonction pour charger les données des produits
async function loadProductData(category) {
    try {
        const response = await fetch(`https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=getProducts&category=${category}`);
        const products = await response.json();
        
        const tableBody = document.getElementById('productTableBody');
        tableBody.innerHTML = '';
        
        if (products.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="${category === 'verre' ? 8 : category === 'monture' ? 6 : category === 'autre' ? 5 : 4}">
                        Aucun produit trouvé dans cette catégorie
                    </td>
                </tr>
            `;
            return;
        }
        
        products.forEach(product => {
            const row = document.createElement('tr');
            
            // Formatage de la date
            const date = new Date(product.date);
            const formattedDate = date.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            row.innerHTML = `
                <td>${formattedDate}</td>
                <td>${product.reference || '-'}</td>
                ${category === 'verre' ? 
                    `<td>${product.sphere || '-'}</td>
                     <td>${product.cylindre || '-'}</td>
                     <td>${product.add || '-'}</td>
                     <td>${product.diametre || '-'}</td>` : ''}
                ${category === 'monture' ? `<td>${product.color || '-'}</td>` : ''}
                <td>${product.quantity}</td>
                <td>${product.supplier || '-'}</td>
                ${category === 'autre' ? `<td>${product.info || '-'}</td>` : ''}
            `;
            
            tableBody.appendChild(row);
        });
    } catch (error) {
        console.error("Erreur lors du chargement des produits:", error);
        document.getElementById('productTableBody').innerHTML = `
            <tr>
                <td colspan="${category === 'verre' ? 8 : category === 'monture' ? 6 : category === 'autre' ? 5 : 4}">
                    Erreur lors du chargement des données
                </td>
            </tr>
        `;
    }
}

// Fonction utilitaire pour capitaliser la première lettre
function capitalizeFirstLetter(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
}


// Fonction pour vérifier les droits d'administration
function hasAdminRights() {
    // Récupère l'utilisateur actuel depuis sessionStorage ou localStorage
    const currentUser = sessionStorage.getItem("utilisateur") || localStorage.getItem("utilisateur");
    
    // Liste des utilisateurs autorisés
    const adminUsers = ["Admin"];
    
    // Vérifie si l'utilisateur actuel fait partie de la liste
    return adminUsers.includes(currentUser);
}

// Fonction protégée pour ajouter un utilisateur
window.openAddUserForm = function() {
    if (!hasAdminRights()) {
        alert("⛔ Accès refusé");
        return;
    }

    const modalContainer = document.getElementById('modal-container');

    const modalHTML = `
        <div class="modal-overlay" id="addUserModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Ajouter un Utilisateur</h3>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="form-group">
                            <label for="userUsername">Username <span class="required">*</span></label>
                            <input type="text" id="userUsername" class="form-control" placeholder="Nom d'utilisateur" required>
                        </div>
                        <div class="form-group">
                            <label for="userPassword">Password <span class="required">*</span></label>
                            <input type="password" id="userPassword" class="form-control" placeholder="Mot de passe" required>
                        </div>
                        <div id="user-message" class="form-message"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="submitAddUserForm()">Enregistrer</button>
                </div>
            </div>
        </div>
    `;

    modalContainer.innerHTML = modalHTML;

    setTimeout(() => {
        document.getElementById('addUserModal').classList.add('active');
    }, 10);
};

// Fonction pour soumettre le formulaire d'utilisateur
async function submitAddUserForm() {
    const form = document.getElementById('addUserForm');
    const formMessage = document.getElementById('user-message');
    const passwordInput = document.getElementById('userPassword');
    formMessage.textContent = '';
    formMessage.className = 'form-message';

    // Validation de base du formulaire
    if (!form.checkValidity()) {
        form.reportValidity();
        formMessage.textContent = 'Veuillez remplir tous les champs obligatoires.';
        formMessage.classList.add('error');
        return;
    }

    // Validation spécifique du mot de passe
    const password = passwordInput.value.trim();
    const passwordRegex = /^[A-Z][a-zA-Z]{1}\d{2}$/; // 1 majuscule + 1 lettre + 2 chiffres
    
    if (!passwordRegex.test(password)) {
        formMessage.textContent = '❌ Le mot de passe doit :\n- Commencer par une majuscule\n- Contenir 2 lettres et 2 chiffres\n- Faire exactement 4 caractères\n- Ne pas commencer par 0';
        formMessage.classList.add('error');
        passwordInput.focus();
        return;
    }

    const userData = {
        username: document.getElementById('userUsername').value.trim(),
        password: password
    };

    const submitButton = document.querySelector('#addUserModal .btn-primary');
    submitButton.disabled = true;
    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enregistrement...';

    try {
        const apiUrl = "https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=adduser";

        await fetch(apiUrl, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(userData)
        });

        formMessage.textContent = '✅ Utilisateur enregistré avec succès!';
        formMessage.classList.add('success');

        form.reset();
        setTimeout(() => {
            closeModal();
        }, 1500);


    } catch (error) {
        console.error("Erreur:", error);
        formMessage.innerHTML = `❌ ${error.message || "Une erreur est survenue lors de l'enregistrement"}`;
        formMessage.classList.add('error');
    } finally {
        submitButton.disabled = false;
        submitButton.textContent = 'Enregistrer';
    }
}
// Fonction pour ouvrir le journal des entrées
window.openEntreesJournal = function() {
    const modalContainer = document.getElementById('modal-container');
    const modalHTML = `
        <div class="modal-overlay" id="journalModal">
            <div class="modal-content" style="max-width: 1000px;">
                <div class="modal-header">
                    <h3 class="modal-title"><i class="fas fa-file-invoice-dollar"></i> Journal des Entrées</h3>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body">
                     <div class="filters-card" style="margin-bottom: 15px;">
                        <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end;">
                            
                            <div style="flex: 1; min-width: 200px;">
                                <label><i class="fas fa-calendar-alt"></i> Période</label>
                                <div style="display: flex; gap: 5px;">
                                    <input type="date" id="filterDateStart" class="form-control" style="flex: 1;">
                                    <span style="align-self: center;">à</span>
                                    <input type="date" id="filterDateEnd" class="form-control" style="flex: 1;">
                                </div>
                            </div>
                    
                            <div style="flex: 1; min-width: 200px;">
                                <label><i class="fas fa-building"></i> Agence</label>
                                <select id="filterAgence" class="form-control" style="width: 100%;">
                                    <option value="">Toutes les agences</option>
                                </select>
                            </div>
                    
                            <div style="display: flex; gap: 10px; min-width: 220px;">
                                <button class="btn btn-primary" onclick="applyEntreesFilter()">
                                    <i class="fas fa-search"></i> Filtrer
                                </button>
                                <button class="btn btn-outline-secondary" onclick="resetEntreesFilter()">
                                    <i class="fas fa-undo"></i> Réinitialiser
                                </button>
                            </div>
                    
                        </div>
                    </div>

                    
                    <div class="table-card">
                        <div class="table-responsive">
                            <table class="entrees-table" id="entreesTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Client</th>
                                        <th>ID Client</th>
                                        <th class="text-right">Montant</th>
                                        <th>Catégorie</th>
                                        <th>Agence</th>
                                    </tr>
                                </thead>
                                <tbody id="entreesData">
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="sr-only">Chargement...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="entrees-message" class="alert alert-info mt-3" style="display: none;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="printEntrees()">
                        <i class="fas fa-print"></i> Imprimer
                    </button>
                    <button type="button" class="btn btn-close-modal" onclick="closeModal()">
                        <i class="fas fa-times"></i> Fermer
                    </button>
                </div>
            </div>
        </div>
    `;

    modalContainer.innerHTML = modalHTML;

    setTimeout(() => {
        document.getElementById('journalModal').classList.add('active');
        loadEntreesData();
    }, 10);
};

// Variables globales
let allEntreesData = [];
let uniqueAgences = [];

// Chargement des données
async function loadEntreesData() {
    const entreesData = document.getElementById('entreesData');
    const messageDiv = document.getElementById('entrees-message');

    console.log('[Entrées] Initialisation du chargement des données...');

    entreesData.innerHTML = '<tr><td colspan="6" class="text-center">Chargement en cours...</td></tr>';
    messageDiv.style.display = 'none';
    messageDiv.classList.remove('alert-danger', 'alert-success');

    try {
        const apiUrl = `https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=entree`;

        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);

        const responseData = await response.json();
        console.log('[Entrées] Données brutes reçues:', responseData);

        if (!responseData?.data?.rows) {
            throw new Error('Structure de données invalide');
        }

        const headers = responseData.data.headers;

        allEntreesData = responseData.data.rows.map(row => ({
            Date: row[headers.indexOf('Date')] ? new Date(row[headers.indexOf('Date')]) : null,
            Client: row[headers.indexOf('Nom du client')] || '',
            ClientID: row[headers.indexOf('ID du client')] || '',
            Montant: parseFloat(row[headers.indexOf('Montant payé')]) || 0,
            Categorie: row[headers.indexOf('Catégorie')] || '',
            Agence: row[headers.indexOf('Agence')] || ''
        }));

        uniqueAgences = [...new Set(allEntreesData.map(item => item.Agence).filter(Boolean))];
        populateAgenceFilter();

        displayFilteredEntrees(allEntreesData);

    } catch (error) {
        console.error('[Entrées] Erreur:', error);
        showEntreesMessage(`❌ Erreur: ${error.message || 'Chargement échoué'}`, 'danger');
        entreesData.innerHTML = '<tr><td colspan="6" class="text-center">Erreur de chargement</td></tr>';
    }
}

// Fonction pour peupler le filtre des agences
function populateAgenceFilter() {
    const agenceSelect = document.getElementById('filterAgence');
    agenceSelect.innerHTML = '<option value="">Toutes les agences</option>';

    uniqueAgences.forEach(agence => {
        const option = document.createElement('option');
        option.value = agence;
        option.textContent = agence;
        agenceSelect.appendChild(option);
    });
}

// Affichage des données filtrées
function displayFilteredEntrees(data) {
    const entreesData = document.getElementById('entreesData');

    if (!data?.length) {
        entreesData.innerHTML = '<tr><td colspan="6" class="text-center">Aucune donnée disponible</td></tr>';
        return;
    }

    const html = data.map(item => {
        const dateFormatted = item.Date?.toLocaleDateString('fr-FR') || 'N/A';
        const montantFormatted = item.Montant.toLocaleString('fr-FR', {
            minimumFractionDigits: 2,
            minimumFractionDigits: 2
        });


        return `
            <tr>
                <td>${dateFormatted}</td>
                <td>${item.Client}</td>
                <td>${item.ClientID}</td>
                <td class="text-right">${montantFormatted}</td>
                <td><span class="badge bg-primary">${item.Categorie}</span></td>
                <td>${item.Agence}</td>
            </tr>
        `;
    }).join('');

    entreesData.innerHTML = html;
}

// Application des filtres
function applyEntreesFilter() {
    const startDate = document.getElementById('filterDateStart').value;
    const endDate = document.getElementById('filterDateEnd').value;
    const selectedAgence = document.getElementById('filterAgence').value;

    let filteredData = [...allEntreesData];

    if (startDate || endDate) {
        const start = startDate ? new Date(startDate) : null;
        const end = endDate ? new Date(endDate) : null;

        filteredData = filteredData.filter(item => {
            if (!item.Date) return false;
            const itemDate = item.Date;
            if (start && end) return itemDate >= start && itemDate <= end;
            if (start) return itemDate >= start;
            if (end) return itemDate <= end;
            return true;
        });
    }

    if (selectedAgence) {
        filteredData = filteredData.filter(item => item.Agence === selectedAgence);
    }

    displayFilteredEntrees(filteredData);

    const message = selectedAgence 
        ? `🔎 ${filteredData.length} entrées pour ${selectedAgence}`
        : `🔎 ${filteredData.length} entrées correspondantes`;
    showEntreesMessage(message, 'info');
}

// Réinitialisation des filtres
function resetEntreesFilter() {
    document.getElementById('filterDateStart').value = '';
    document.getElementById('filterDateEnd').value = '';
    document.getElementById('filterAgence').value = '';
    displayFilteredEntrees(allEntreesData);
    showEntreesMessage(`↻ Affichage de toutes les ${allEntreesData.length} entrées`, 'info');
}

// Affichage des messages
function showEntreesMessage(message, type) {
    const messageDiv = document.getElementById('entrees-message');
    messageDiv.textContent = message;
    messageDiv.className = `alert alert-${type}`;
    messageDiv.style.display = 'block';
}

// Fonction d'impression
function printEntrees() {
    try {
        const printWindow = window.open('', '_blank');
        const printContent = document.getElementById('entreesTable').cloneNode(true);

        let total = 0;
        const rows = printContent.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const amountCell = row.cells[3]?.textContent;
            if (amountCell) {
                const amount = parseFloat(amountCell.replace(/[^\d,.-]/g, '').replace(',', '.'));
                if (!isNaN(amount)) total += amount;
            }
        });

        const totalRow = document.createElement('tr');
        totalRow.className = 'total-row';
        totalRow.innerHTML = `
            <td colspan="3" class="text-right"><strong>Total</strong></td>
            <td class="text-right"><strong>${total.toLocaleString('fr-FR', {
                minimumFractionDigits: 2,
                minimumFractionDigits: 2
            })}</strong></td>
            <td colspan="2"></td>
        `;
        printContent.querySelector('tbody').appendChild(totalRow);

        const styles = `
            <style>
                body { font-family: Arial, sans-serif; margin: 15px; }
                h1 { color: #333; text-align: center; }
                table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; }
                .text-right { text-align: right; }
                .total-row { font-weight: bold; background-color: #f8f9fa; }
                .badge { padding: 3px 6px; border-radius: 3px; font-size: 12px; }
                @page { size: auto; margin: 10mm; }
            </style>
        `;

        const dateStart = document.getElementById('filterDateStart').value;
        const dateEnd = document.getElementById('filterDateEnd').value;
        let periodInfo = '';

        if (dateStart || dateEnd) {
            periodInfo = `Période : ${dateStart ? new Date(dateStart).toLocaleDateString('fr-FR') : 'Début'} à ${dateEnd ? new Date(dateEnd).toLocaleDateString('fr-FR') : 'Aujourd\'hui'}`;
        }

        printWindow.document.write(`
            <html>
                <head>
                    <title>Journal des Entrées</title>
                    ${styles}
                </head>
                <body>
                    <h1>Journal des Entrées</h1>
                    <p>${periodInfo}</p>
                    <p>Imprimé le ${new Date().toLocaleDateString('fr-FR')}</p>
                    ${printContent.outerHTML}
                </body>
            </html>
        `);
        printWindow.document.close();
    } catch (error) {
        console.error('Erreur d\'impression:', error);
        alert("Une erreur est survenue lors de l'impression");
    }
}

    // Fonction pour ouvrir le journal des dépenses
window.openDepensesJournal = function() {
    const modalContainer = document.getElementById('modal-container');
    const modalHTML = `
        <div class="modal-overlay" id="journalModal">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h3 class="modal-title">Journal des Dépenses</h3>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="filters mb-4">
                        <div class="filter-group">
                            <div class="date-filters">
                                <div class="date-input-group">
                                    <span class="date-icon"><i class="fas fa-calendar-alt"></i></span>
                                    <input type="date" id="filterDateStart" class="form-control date-input">
                                    <span class="date-separator">au</span>
                                    <input type="date" id="filterDateEnd" class="form-control date-input">
                                </div>
                                <button class="btn btn-filter" onclick="applyDateFilter()">
                                    <i class="fas fa-filter"></i> Appliquer
                                </button>
                                <button class="btn btn-reset" onclick="resetDateFilter()">
                                    <i class="fas fa-times"></i> Réinitialiser
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover" id="depensesTable">
                            <thead class="table-header">
                                <tr>
                                    <th>Date</th>
                                    <th>Agence</th>
                                    <th>Désignation</th>
                                    <th>Catégorie</th>
                                    <th class="text-right">Montant</th>
                                </tr>
                            </thead>
                            <tbody id="depensesData">
                                <tr>
                                    <td colspan="5" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="sr-only">Chargement...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="depenses-message" class="form-message"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="printDepenses()">
                        <i class="fas fa-print"></i> Imprimer
                    </button>
                    <button type="button" class="btn btn-close-modal" onclick="closeModal()">
                        <i class="fas fa-times"></i> Fermer
                    </button>
                </div>
            </div>
        </div>
    `;

    modalContainer.innerHTML = modalHTML;

    setTimeout(() => {
        document.getElementById('journalModal').classList.add('active');
        loadDepensesData();
    }, 10);
};
    
let allDepensesData = []; // Variable globale pour stocker toutes les données

async function loadDepensesData() {
    const depensesData = document.getElementById('depensesData');
    const messageDiv = document.getElementById('depenses-message');
    
    console.log('Début du chargement des données de dépenses...');
    
    depensesData.innerHTML = '<tr><td colspan="5" class="text-center">Chargement en cours...</td></tr>';
    messageDiv.textContent = '';
    messageDiv.classList.remove('error', 'success');

    try {
        const apiUrl2 = `https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=depense`;
        
        console.log('URL de l\'API appelée:', apiUrl2);
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        
        console.log('Envoi de la requête fetch...');
        const response = await fetch(apiUrl2, { signal: controller.signal });
        clearTimeout(timeoutId);
        
        console.log('Réponse reçue, status:', response.status);
        
        if (!response.ok) {
            throw new Error(`Erreur HTTP ! statut : ${response.status}`);
        }
        
        const responseData = await response.json();
        console.log('Données brutes reçues:', responseData);

        // Stocker toutes les données pour le filtrage
        allDepensesData = responseData.data || [];
        
        // Afficher toutes les données initialement
        displayFilteredData(allDepensesData);
        
    } catch (error) {
        console.error("Erreur lors du chargement:", error);
        messageDiv.innerHTML = `❌ Erreur lors du chargement des données : ${error.message || "Erreur inconnue"}`;
        messageDiv.classList.add('error');
        depensesData.innerHTML = '<tr><td colspan="5" class="text-center">Erreur de chargement</td></tr>';
    } finally {
        console.log('Chargement des dépenses terminé');
    }
}

// Fonction pour afficher les données filtrées
function displayFilteredData(data) {
    const depensesData = document.getElementById('depensesData');
    
    if (data && data.length > 0) {
        console.log(`Nombre d'éléments à afficher: ${data.length}`);
        let html = '';
        data.forEach((row, index) => {
            const formattedDate = row.Date ? new Date(row.Date).toLocaleDateString('fr-FR') : '';
            const formattedAmount = row.Montant ? 
                parseFloat(row.Montant).toLocaleString('fr-FR', { 
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2 
                }) + '' : '';
            
            console.log(`Ligne ${index + 1}:`, row);
            
            html += `
                <tr>
                    <td>${formattedDate}</td>
                    <td>${row.Agence || ''}</td>
                    <td>${row.Designation || ''}</td>
                    <td>${row.Categorie || ''}</td>
                    <td class="text-right">${formattedAmount}</td>
                </tr>
            `;
        });
        depensesData.innerHTML = html;
    } else {
        console.log('Aucune donnée disponible après filtrage');
        depensesData.innerHTML = '<tr><td colspan="5" class="text-center">Aucune donnée disponible pour les critères sélectionnés</td></tr>';
    }
}

// Fonction pour appliquer le filtre par date
function applyDateFilter() {
    const dateStart = document.getElementById('filterDateStart').value;
    const dateEnd = document.getElementById('filterDateEnd').value;
    
    console.log('Filtrage par date - Début:', dateStart, 'Fin:', dateEnd);
    
    if (!dateStart && !dateEnd) {
        // Aucun filtre - afficher toutes les données
        displayFilteredData(allDepensesData);
        return;
    }
    
    const filteredData = allDepensesData.filter(item => {
        const itemDate = new Date(item.Date);
        const startDate = dateStart ? new Date(dateStart) : null;
        const endDate = dateEnd ? new Date(dateEnd) : null;
        
        // Si seule la date de début est spécifiée
        if (dateStart && !dateEnd) {
            return itemDate >= startDate;
        }
        
        // Si seule la date de fin est spécifiée
        if (!dateStart && dateEnd) {
            return itemDate <= endDate;
        }
        
        // Si les deux dates sont spécifiées
        if (dateStart && dateEnd) {
            return itemDate >= startDate && itemDate <= endDate;
        }
        
        return true;
    });
    
    displayFilteredData(filteredData);
}
function resetDateFilter() {
    document.getElementById('filterDateStart').value = '';
    document.getElementById('filterDateEnd').value = '';
    displayFilteredData(allDepensesData);
}

function printDepenses() {
    try {
        const originalTable = document.getElementById('depensesTable');
        if (!originalTable) {
            alert("Impossible de trouver le tableau des dépenses à imprimer");
            return;
        }

        // Vérifier s'il y a des données à imprimer
        const dataRows = originalTable.querySelectorAll('tbody tr');
        if (dataRows.length === 0 || (dataRows.length === 1 && dataRows[0].querySelector('td[colspan="5"]'))) {
            alert("Aucune donnée disponible pour l'impression");
            return;
        }

        // Clone le tableau pour l'impression
        const printContent = originalTable.cloneNode(true);
        
        // Crée une fenêtre d'impression
        const printWindow = window.open('', '_blank');
        if (!printWindow) {
            alert("Veuillez autoriser les fenêtres pop-up pour cette fonctionnalité");
            return;
        }

        // Style amélioré pour l'impression
        const styles = `
            <style>
                body { 
                    font-family: Arial, sans-serif; 
                    margin: 0; 
                    padding: 15px; 
                    color: #333;
                    font-size: 12px;
                }
                .print-header {
                    text-align: center;
                    margin-bottom: 20px;
                    border-bottom: 1px solid #eee;
                    padding-bottom: 10px;
                }
                .print-title {
                    font-size: 18px;
                    font-weight: bold;
                    margin: 10px 0;
                }
                .print-info {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 15px;
                }
                table { 
                    width: 100%; 
                    border-collapse: collapse; 
                    margin-top: 10px;
                    font-size: 11px;
                }
                th, td { 
                    border: 1px solid #ddd; 
                    padding: 6px; 
                    text-align: left; 
                }
                th { 
                    background-color: #f2f2f2; 
                    font-weight: bold;
                }
                .text-right { 
                    text-align: right; 
                }
                .total-row { 
                    font-weight: bold; 
                    background-color: #f9f9f9;
                }
                tr:nth-child(even) {
                    background-color: #f9f9f9;
                }
                @page { 
                    size: auto;  
                    margin: 10mm;
                }
                @media print {
                    body { 
                        margin: 0; 
                        padding: 0; 
                    }
                    .no-print { 
                        display: none !important; 
                    }
                    table {
                        page-break-inside: auto;
                    }
                    tr {
                        page-break-inside: avoid;
                        page-break-after: auto;
                    }
                }
            </style>
        `;
        
        // Calcul du total
        let total = 0;
        const rows = printContent.getElementsByTagName('tbody')[0].rows;
        for (let i = 0; i < rows.length; i++) {
            const amountCell = rows[i].cells[4];
            if (amountCell && !rows[i].querySelector('td[colspan]')) {
                const amountText = amountCell.textContent
                    .replace('', '')
                    .replace(/\s/g, '')
                    .replace(',', '.');
                const amount = parseFloat(amountText);
                if (!isNaN(amount)) {
                    total += amount;
                }
            }
        }
        
        // Formatage du total
        const formattedTotal = total.toLocaleString('fr-FR', { 
            minimumFractionDigits: 2, 
            maximumFractionDigits: 2 
        }) + '';
        
        // Ajout de la ligne de total
        const tbody = printContent.getElementsByTagName('tbody')[0];
        const totalRow = document.createElement('tr');
        totalRow.className = 'total-row';
        totalRow.innerHTML = `
            <td colspan="4" class="text-right"><strong>Total</strong></td>
            <td class="text-right"><strong>${formattedTotal}</strong></td>
        `;
        tbody.appendChild(totalRow);
        
        // Informations d'en-tête
        const dateStart = document.getElementById('filterDateStart').value;
        const dateEnd = document.getElementById('filterDateEnd').value;
        let periodInfo = '';
        
        if (dateStart || dateEnd) {
            const startText = dateStart ? new Date(dateStart).toLocaleDateString('fr-FR') : 'début';
            const endText = dateEnd ? new Date(dateEnd).toLocaleDateString('fr-FR') : 'aujourd\'hui';
            periodInfo = `Période : du ${startText} au ${endText}`;
        } else {
            periodInfo = 'Toutes les dépenses';
        }
        
        // Construction du contenu HTML complet
        printWindow.document.write(`
            <html>
                <head>
                    <title>Journal des Dépenses</title>
                    ${styles}
                </head>
                <body>
                    <div class="print-header">
                        <div class="print-title">Journal des Dépenses</div>
                        <div class="print-info">
                            <span>${periodInfo}</span>
                            <span>Imprimé le ${new Date().toLocaleDateString('fr-FR')} à ${new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'})}</span>
                        </div>
                    </div>
                    ${printContent.outerHTML}
                    <script>

                </body>
            </html>
        `);
        
        printWindow.document.close();
        
    } catch (error) {
        console.error("Erreur lors de l'impression:", error);
        alert("Une erreur est survenue lors de la préparation de l'impression");
    }
}

// Fonction pour ouvrir la liste des verres avec filtrage instantané
function openListeVerre() {
    const modalContainer = document.getElementById('modal-container');
    const modalHTML = `
        <div class="modal-overlay" id="verreModal">
            <div class="modal-content large-modal">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <i class="fas fa-glasses modal-icon"></i> Catalogue des Verres
                    </h3>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="filters-panel">
                        <div class="filter-group">
                            <label for="filterGamme">Gamme</label>
                            <select id="filterGamme" class="form-select" onchange="applyVerreFilter()">
                                <option value="">Toutes les gammes</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterType">Type de Verre</label>
                            <select id="filterType" class="form-select" onchange="applyVerreFilter()">
                                <option value="">Tous les types</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterIndice">Indice</label>
                            <select id="filterIndice" class="form-select" onchange="applyVerreFilter()">
                                <option value="">Tous les indices</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterTraitement">Traitement</label>
                            <select id="filterTraitement" class="form-select" onchange="applyVerreFilter()">
                                <option value="">Tous les traitements</option>
                            </select>
                        </div>
                        <div class="filter-actions">
                            <button class="btn btn-outline-secondary btn-icon" onclick="resetVerreFilter()">
                                <i class="fas fa-undo"></i> Réinitialiser
                            </button>
                        </div>
                    </div>

                    <div class="table-container">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover verre-catalogue-table" id="verreTable">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>Gamme</th>
                                        <th>Type de Verre</th>
                                        <th>Indice</th>
                                        <th>Traitement</th>
                                        <th class="text-right">Prix (FCFA)</th>
                                    </tr>
                                </thead>
                                <tbody id="verreData">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="sr-only">Chargement...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="verre-message" class="alert alert-info mt-3" style="display: none;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-icon" onclick="printVerreList()">
                        <i class="fas fa-print"></i> Imprimer la liste
                    </button>
                    <button type="button" class="btn btn-primary btn-icon" onclick="closeModal()">
                        <i class="fas fa-times"></i> Fermer
                    </button>
                </div>
            </div>
        </div>
    `;

    modalContainer.innerHTML = modalHTML;
    document.getElementById('verreModal').classList.add('active');
    loadVerreData();
}

// Variables globales
let allVerreData = [];
let uniqueGammes = [];
let uniqueTypes = [];
let uniqueIndices = [];
let uniqueTraitements = [];

// Chargement des données
async function loadVerreData() {
    const verreData = document.getElementById('verreData');
    const messageDiv = document.getElementById('verre-message');
    
    verreData.innerHTML = '<tr><td colspan="5" class="text-center">Chargement en cours...</td></tr>';
    messageDiv.style.display = 'none';

    try {
        const apiUrl = `https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=importverre`;
        
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
        
        const responseData = await response.json();
        
        if (!responseData?.data?.rows) {
            throw new Error('Structure de données invalide');
        }
        
        // Transformation des données
        allVerreData = responseData.data.rows.map(row => {
            const headers = responseData.data.headers;
            return {
                Gamme: row[headers.indexOf('Gamme')] || '',
                Type: row[headers.indexOf('Type de Verre')] || '',
                Indice: row[headers.indexOf('Indice')] || '',
                Traitement: row[headers.indexOf('TRAITEMENT')] || '',
                Prix: parseFloat(row[headers.indexOf('PRIX')]) || 0
            };
        });

        // Récupération des valeurs uniques pour les filtres
        uniqueGammes = [...new Set(allVerreData.map(item => item.Gamme).filter(Boolean))];
        uniqueTypes = [...new Set(allVerreData.map(item => item.Type).filter(Boolean))];
        uniqueIndices = [...new Set(allVerreData.map(item => item.Indice).filter(Boolean))];
        uniqueTraitements = [...new Set(allVerreData.map(item => item.Traitement).filter(Boolean))];

        // Peuplement des filtres
        populateSelect('filterGamme', uniqueGammes);
        populateSelect('filterType', uniqueTypes);
        populateSelect('filterIndice', uniqueIndices);
        populateSelect('filterTraitement', uniqueTraitements);

        displayFilteredVerre(allVerreData);
        
    } catch (error) {
        console.error('Erreur:', error);
        showVerreMessage(`❌ Erreur: ${error.message || 'Chargement échoué'}`, 'error');
        verreData.innerHTML = '<tr><td colspan="5" class="text-center">Erreur de chargement</td></tr>';
    }
}

// Peuplement des select filters
function populateSelect(selectId, values) {
    const select = document.getElementById(selectId);
    select.innerHTML = `<option value="">Tous</option>`;
    
    values.forEach(value => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        select.appendChild(option);
    });
}

// Affichage des données filtrées
function displayFilteredVerre(data) {
    const verreData = document.getElementById('verreData');
    
    if (!data?.length) {
        verreData.innerHTML = '<tr><td colspan="5" class="text-center">Aucun verre trouvé</td></tr>';
        return;
    }
    
    let html = '';
    data.forEach(item => {
        html += `
            <tr>
                <td>${item.Gamme}</td>
                <td>${item.Type}</td>
                <td>${item.Indice}</td>
                <td>${item.Traitement}</td>
                <td class="text-right">${item.Prix.toLocaleString('fr-FR', { 
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2 })}
                </td>

            </tr>
        `;
    });
    
    verreData.innerHTML = html;
}

// Application des filtres
function applyVerreFilter() {
    const gamme = document.getElementById('filterGamme').value;
    const type = document.getElementById('filterType').value;
    const indice = document.getElementById('filterIndice').value;
    const traitement = document.getElementById('filterTraitement').value;
    
    let filteredData = allVerreData.filter(item => {
        return (!gamme || item.Gamme === gamme) &&
               (!type || item.Type === type) &&
               (!indice || item.Indice === indice) &&
               (!traitement || item.Traitement === traitement);
    });
    
    displayFilteredVerre(filteredData);
    showVerreMessage(`🔎 ${filteredData.length} verres trouvés`, 'info');
}

// Réinitialisation des filtres
function resetVerreFilter() {
    document.getElementById('filterGamme').value = '';
    document.getElementById('filterType').value = '';
    document.getElementById('filterIndice').value = '';
    document.getElementById('filterTraitement').value = '';
    
    displayFilteredVerre(allVerreData);
    showVerreMessage(`↻ Affichage de tous les ${allVerreData.length} verres`, 'info');
}

// Affichage des messages
function showVerreMessage(message, type) {
    const messageDiv = document.getElementById('verre-message');
    messageDiv.textContent = message;
    messageDiv.className = `alert alert-${type}`;
    messageDiv.style.display = 'block';
}

// Fonction d'impression
function printVerreList() {
    const printWindow = window.open('', '_blank');
    const printContent = document.getElementById('verreTable').cloneNode(true);
    
    // Styles d'impression
    const styles = `
        <style>
            body { font-family: Arial, sans-serif; margin: 15px; }
            h1 { color: #333; text-align: center; margin-bottom: 10px; }
            table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; }
            .text-right { text-align: right; }
            @page { size: auto; margin: 10mm; }
        </style>
    `;

    printWindow.document.write(`
        <html>
            <head>
                <title>Catalogue des Verres</title>
                ${styles}
            </head>
            <body>
                <h1>Catalogue des Verres</h1>
                <p>Imprimé le ${new Date().toLocaleDateString('fr-FR')}</p>
                ${printContent.outerHTML}
            </body>
        </html>
    `);
    printWindow.document.close();
}

// Fonction pour ouvrir la liste des montures

function openListeMonture() {
    const modalContainer = document.getElementById('modal-container');
    const modalHTML = `
        <div class="modal-overlay" id="montureModal">
            <div class="modal-content extra-large-modal">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <i class="fas fa-glasses modal-icon"></i> Catalogue des Montures
                    </h3>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="filters-panel compact-filters">
                        <div class="filter-row">
                            <!-- Filtre Référence -->
                            <div class="filter-group">
                                <label for="filterReference">Référence</label>
                                <select id="filterReference" class="form-select" onchange="applyMontureFilter()">
                                    <option value="">Toutes</option>
                                </select>
                            </div>
                            
                            <!-- Filtre Fournisseur -->
                            <div class="filter-group">
                                <label for="filterFournisseur">Fournisseur</label>
                                <select id="filterFournisseur" class="form-select" onchange="applyMontureFilter()">
                                    <option value="">Tous</option>
                                </select>
                            </div>
                            
                            <!-- Filtre Couleur -->
                            <div class="filter-group">
                                <label for="filterCouleur">Couleur</label>
                                <select id="filterCouleur" class="form-select" onchange="applyMontureFilter()">
                                    <option value="">Toutes</option>
                                </select>
                            </div>
                            
                            <!-- Bouton Réinitialiser -->
                            <div class="filter-action">
                                <button class="btn btn-outline-secondary btn-icon" onclick="resetMontureFilter()">
                                    <i class="fas fa-undo"></i> Réinitialiser
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover monture-catalogue-table" id="montureTable">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>Référence</th>
                                        <th>Fournisseur</th>
                                        <th>Couleur</th>
                                        <th class="text-right">Quantité</th>
                                        <th>Code Unique</th>
                                    </tr>
                                </thead>
                                <tbody id="montureData">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="sr-only">Chargement...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="monture-message" class="alert alert-info mt-3" style="display: none;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-icon" onclick="printMontureList()">
                        <i class="fas fa-print"></i> Imprimer
                    </button>
                    <button type="button" class="btn btn-primary btn-icon" onclick="closeModal()">
                        <i class="fas fa-times"></i> Fermer
                    </button>
                </div>
            </div>
        </div>
    `;

    modalContainer.innerHTML = modalHTML;
    document.getElementById('montureModal').classList.add('active');
    loadMontureData();
}
// Variables globales pour les montures
let allMontureData = [];
let uniqueReferences = [];
let uniqueFournisseurs = [];
let uniqueCouleurs = [];

// Chargement des données des montures
async function loadMontureData() {
    const montureData = document.getElementById('montureData');
    const messageDiv = document.getElementById('monture-message');
    
    montureData.innerHTML = '<tr><td colspan="5" class="text-center">Chargement en cours...</td></tr>';
    messageDiv.style.display = 'none';

    try {
        const apiUrl = `https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=importmonture`;
        
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
        
        const responseData = await response.json();
        
        if (!responseData?.data?.rows) {
            throw new Error('Structure de données invalide');
        }
        
        // Transformation des données
        allMontureData = responseData.data.rows.map(row => {
            const headers = responseData.data.headers;
            return {
                Reference: row[headers.indexOf('Référence')] || '',
                Fournisseur: row[headers.indexOf('Fournisseur')] || '',
                Couleur: row[headers.indexOf('Couleur')] || '',
                Quantite: parseInt(row[headers.indexOf('Quantité')]) || 0,
                CodeUnique: row[headers.indexOf('Code Unique')] || ''
            };
        });

        // Récupération des valeurs uniques pour les filtres
        uniqueReferences = [...new Set(allMontureData.map(item => item.Reference).filter(Boolean))];
        uniqueFournisseurs = [...new Set(allMontureData.map(item => item.Fournisseur).filter(Boolean))];
        uniqueCouleurs = [...new Set(allMontureData.map(item => item.Couleur).filter(Boolean))];

        // Peuplement des filtres
        populateSelect('filterReference', uniqueReferences);
        populateSelect('filterFournisseur', uniqueFournisseurs);
        populateSelect('filterCouleur', uniqueCouleurs);

        displayFilteredMonture(allMontureData);
        
    } catch (error) {
        console.error('Erreur:', error);
        showMontureMessage(`❌ Erreur: ${error.message || 'Chargement échoué'}`, 'error');
        montureData.innerHTML = '<tr><td colspan="5" class="text-center">Erreur de chargement</td></tr>';
    }
}

// Affichage des données filtrées pour montures
function displayFilteredMonture(data) {
    const montureData = document.getElementById('montureData');
    
    if (!data?.length) {
        montureData.innerHTML = '<tr><td colspan="5" class="text-center">Aucune monture trouvée</td></tr>';
        return;
    }
    
    let html = '';
    data.forEach(item => {
        html += `
            <tr>
                <td>${item.Reference}</td>
                <td>${item.Fournisseur}</td>
                <td>${item.Couleur}</td>
                <td class="text-right">${item.Quantite}</td>
                <td>${item.CodeUnique}</td>
            </tr>
        `;
    });
    
    montureData.innerHTML = html;
}

// Application des filtres pour montures
function applyMontureFilter() {
    const reference = document.getElementById('filterReference').value;
    const fournisseur = document.getElementById('filterFournisseur').value;
    const couleur = document.getElementById('filterCouleur').value;
    
    let filteredData = allMontureData.filter(item => {
        return (!reference || item.Reference === reference) &&
               (!fournisseur || item.Fournisseur === fournisseur) &&
               (!couleur || item.Couleur === couleur);
    });
    
    displayFilteredMonture(filteredData);
    showMontureMessage(`🔎 ${filteredData.length} montures trouvées`, 'info');
}

// Réinitialisation des filtres pour montures
function resetMontureFilter() {
    document.getElementById('filterReference').value = '';
    document.getElementById('filterFournisseur').value = '';
    document.getElementById('filterCouleur').value = '';
    
    displayFilteredMonture(allMontureData);
    showMontureMessage(`↻ Affichage de toutes les ${allMontureData.length} montures`, 'info');
}

// Affichage des messages pour montures
function showMontureMessage(message, type) {
    const messageDiv = document.getElementById('monture-message');
    messageDiv.textContent = message;
    messageDiv.className = `alert alert-${type}`;
    messageDiv.style.display = 'block';
}

// Fonction d'impression pour montures
function printMontureList() {
    const printWindow = window.open('', '_blank');
    const printContent = document.getElementById('montureTable').cloneNode(true);
    
    // Styles d'impression
    const styles = `
        <style>
            body { font-family: Arial, sans-serif; margin: 15px; }
            h1 { color: #333; text-align: center; margin-bottom: 10px; }
            table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; }
            .text-right { text-align: right; }
            @page { size: auto; margin: 10mm; }
        </style>
    `;

    printWindow.document.write(`
        <html>
            <head>
                <title>Catalogue des Montures</title>
                ${styles}
            </head>
            <body>
                <h1>Catalogue des Montures</h1>
                <p>Imprimé le ${new Date().toLocaleDateString('fr-FR')}</p>
                ${printContent.outerHTML}
            </body>
        </html>
    `);
    printWindow.document.close();
}

// Fonction pour ouvrir la liste des deals assurance avec une modal responsive
function openDealsAssurance() {
    const modalContainer = document.getElementById('modal-container');
    const modalHTML = `
        <div class="modal-overlay" id="assuranceModal">
            <div class="modal-content" style="width: 95vw; max-width: none; height: 90vh;">
                <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; border-bottom: 1px solid #ddd;">
                    <h3 class="modal-title" style="margin: 0; font-size: 1.25rem;">
                        <i class="fas fa-building me-2"></i> Gestion des Deals Assurance
                    </h3>
                    <button class="modal-close btn-close" onclick="closeModal()" aria-label="Fermer">&times;</button>
                </div>

                <div class="modal-body" style="display: flex; flex-direction: column; padding: 15px; gap: 10px; overflow: hidden;">

                    <!-- Filtres -->
                    <div class="filters-panel" style="flex-shrink: 0;">
                        <div style="display: flex; gap: 12px; align-items: end; flex-wrap: wrap;">
                            <!-- Filtre Date Début -->
                            <div style="flex: 1; min-width: 180px;">
                                <label for="filterDateStart" class="form-label small">Date de début</label>
                                <input type="date" id="filterDateStart" class="form-control form-control-sm" onchange="applyAssuranceFilter()">
                            </div>
                            <!-- Filtre Date Fin -->
                            <div style="flex: 1; min-width: 180px;">
                                <label for="filterDateEnd" class="form-label small">Date de fin</label>
                                <input type="date" id="filterDateEnd" class="form-control form-control-sm" onchange="applyAssuranceFilter()">
                            </div>
                            <div style="flex: 1; min-width: 180px;">
                                <label for="filterSociete" class="form-label small">Société</label>
                                <select id="filterSociete" class="form-select form-select-sm" onchange="applyAssuranceFilter()">
                                    <option value="">Toutes</option>
                                </select>
                            </div>
                            <div style="flex: 1; min-width: 180px;">
                                <label for="filterAssurance" class="form-label small">Assurance</label>
                                <select id="filterAssurance" class="form-select form-select-sm" onchange="applyAssuranceFilter()">
                                    <option value="">Toutes</option>
                                </select>
                            </div>
                            <div style="flex: 1; min-width: 180px;">
                                <label for="filterCompagnie" class="form-label small">Compagnie</label>
                                <select id="filterCompagnie" class="form-select form-select-sm" onchange="applyAssuranceFilter()">
                                    <option value="">Toutes</option>
                                </select>
                            </div>
                            <div style="align-self: center;">
                                <button class="btn btn-outline-secondary btn-sm" onclick="resetAssuranceFilter()">
                                    <i class="fas fa-undo me-1"></i> Réinitialiser
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- Tableau -->
                    <div class="table-container" style="flex-grow: 1; overflow-y: auto;">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover table-sm" id="assuranceTable">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th>Date</th>
                                        <th>N° Police</th>
                                        <th>Société</th>
                                        <th>Assuré</th>
                                        <th>Bénéficiaire</th>
                                        <th>Actes</th>
                                        <th class="text-end">Total</th>
                                        <th class="text-end">Part Assuré</th>
                                        <th class="text-end">Part Assureur</th>
                                        <th>Assurance</th>
                                        <th>Compagnie</th>
                                        <th>Propriétaire</th>
                                    </tr>
                                </thead>
                                <tbody id="assuranceData">
                                    <tr>
                                        <td colspan="12" class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Chargement...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Message -->
                    <div id="assurance-message" class="alert alert-info small mt-2" style="display: none;"></div>
                </div>

                <!-- Footer -->
                <div class="modal-footer d-flex justify-content-between align-items-center p-2 border-top">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="printAssuranceList()">
                        <i class="fas fa-print me-1"></i> Imprimer la liste
                    </button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="closeModal()">
                        <i class="fas fa-times me-1"></i> Fermer
                    </button>
                </div>
            </div>
        </div>
    `;

    modalContainer.innerHTML = modalHTML;
    document.getElementById('assuranceModal').classList.add('active');
    loadAssuranceData();
}

// Variables globales
let allAssuranceData = [];
let uniqueSocietes = [];

// Chargement des données
async function loadAssuranceData() {
    const assuranceData = document.getElementById('assuranceData');
    const messageDiv = document.getElementById('assurance-message');
    
    assuranceData.innerHTML = '<tr><td colspan="12" class="text-center">Chargement en cours...</td></tr>';
    messageDiv.style.display = 'none';

    try {
        const apiUrl = `https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=importassurance`;
        
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
        
        const responseData = await response.json();
        
        if (!responseData?.data?.rows) {
            throw new Error('Structure de données invalide');
        }
        
        // Transformation des données
        allAssuranceData = responseData.data.rows.map(row => {
            const headers = responseData.data.headers;
            return {
                Date: row[headers.indexOf('Date')] || '',
                Police: row[headers.indexOf('N°Police')] || '',
                Societe: row[headers.indexOf('Société')] || '',
                Assure: row[headers.indexOf('Assuré Principal')] || '',
                Beneficiaire: row[headers.indexOf('Bénéficiaire')] || '',
                Actes: row[headers.indexOf('Actes')] || '',
                MontantTotal: parseFloat(row[headers.indexOf('MONTANT TOTAL')]) || 0,
                PartAssure: parseFloat(row[headers.indexOf('PART ASSURE')]) || 0,
                PartAssureur: parseFloat(row[headers.indexOf('PART ASSUREUR')]) || 0,
                Assurance: row[headers.indexOf('Assurance')] || '',
                Compagnie: row[headers.indexOf('Compagnie')] || '',
                Proprietaire: row[headers.indexOf('Proprietaire')] || ''
            };
        });

        // Récupération des valeurs uniques pour les filtres
        uniqueSocietes = [...new Set(allAssuranceData.map(item => item.Societe).filter(Boolean))];
        uniqueAssurances = [...new Set(allAssuranceData.map(item => item.Assurance).filter(Boolean))];
        uniqueCompagnies = [...new Set(allAssuranceData.map(item => item.Compagnie).filter(Boolean))];

        // Peuplement des filtres
        populateSelect('filterSociete', uniqueSocietes);
        populateSelect('filterAssurance', uniqueAssurances);
        populateSelect('filterCompagnie', uniqueCompagnies);

        displayFilteredAssurance(allAssuranceData);
        
    } catch (error) {
        console.error('Erreur:', error);
        showAssuranceMessage(`❌ Erreur: ${error.message || 'Chargement échoué'}`, 'error');
        assuranceData.innerHTML = '<tr><td colspan="12" class="text-center">Erreur de chargement</td></tr>';
    }
}
// Peuplement des select filters
function populateSelect(selectId, values) {
    const select = document.getElementById(selectId);
    select.innerHTML = `<option value="">Tous</option>`;
    
    values.sort().forEach(value => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        select.appendChild(option);
    });
}

// Affichage des données filtrées
function displayFilteredAssurance(data) {
    const assuranceData = document.getElementById('assuranceData');
    
    if (!data?.length) {
        assuranceData.innerHTML = '<tr><td colspan="12" class="text-center">Aucun deal trouvé</td></tr>';
        return;
    }
    
    let html = '';
    data.forEach(item => {
        html += `
            <tr>
                <td>${formatDate(item.Date)}</td>
                <td>${item.Police}</td>
                <td>${item.Societe}</td>
                <td>${item.Assure}</td>
                <td>${item.Beneficiaire}</td>
                <td>${item.Actes}</td>
                <td class="text-right">${formatCurrency(item.MontantTotal)}</td>
                <td class="text-right">${formatCurrency(item.PartAssure)}</td>
                <td class="text-right">${formatCurrency(item.PartAssureur)}</td>
                <td>${item.Assurance}</td>
                <td>${item.Compagnie}</td>
                <td>${item.Proprietaire}</td>
            </tr>
        `;
    });
    
    assuranceData.innerHTML = html;
}

// Helper pour formater la date
function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return isNaN(date) ? dateString : date.toLocaleDateString('fr-FR');
}

// Helper pour formater les montants
function formatCurrency(amount) {
    return amount.toLocaleString('fr-FR', { 
        minimumFractionDigits: 2, 
        maximumFractionDigits: 2 
    });
}

// Application des filtres
// Application des filtres
function applyAssuranceFilter() {
    const dateStart = document.getElementById('filterDateStart').value;
    const dateEnd = document.getElementById('filterDateEnd').value;
    const societe = document.getElementById('filterSociete').value;
    const assurance = document.getElementById('filterAssurance').value;
    const compagnie = document.getElementById('filterCompagnie').value;
    
    let filteredData = allAssuranceData.filter(item => {
        // Conversion des dates en objets Date pour comparaison
        const itemDate = item.Date ? new Date(item.Date) : null;
        const startDate = dateStart ? new Date(dateStart) : null;
        const endDate = dateEnd ? new Date(dateEnd) : null;
        
        // Vérification de la plage de dates
        let dateMatch = true;
        if (itemDate) {
            if (startDate && endDate) {
                dateMatch = itemDate >= startDate && itemDate <= endDate;
            } else if (startDate) {
                dateMatch = itemDate >= startDate;
            } else if (endDate) {
                dateMatch = itemDate <= endDate;
            }
        }
        
        const societeMatch = !societe || item.Societe === societe;
        const assuranceMatch = !assurance || item.Assurance === assurance;
        const compagnieMatch = !compagnie || item.Compagnie === compagnie;
        
        return dateMatch && societeMatch && assuranceMatch && compagnieMatch;
    });
    
    displayFilteredAssurance(filteredData);
    updateResultCount(filteredData.length);
}

// Réinitialisation des filtres
function resetAssuranceFilter() {
    document.getElementById('filterDateStart').value = '';
    document.getElementById('filterDateEnd').value = '';
    document.getElementById('filterSociete').value = '';
    document.getElementById('filterAssurance').value = '';
    document.getElementById('filterCompagnie').value = '';
    
    displayFilteredAssurance(allAssuranceData);
    updateResultCount(allAssuranceData.length);
}

// Helper pour formater la date (ajout de la gestion des erreurs)
function formatDate(dateString) {
    if (!dateString) return '';
    try {
        const date = new Date(dateString);
        return isNaN(date.getTime()) ? dateString : date.toLocaleDateString('fr-FR');
    } catch (e) {
        return dateString;
    }
}

// Affichage des messages
function showAssuranceMessage(message, type) {
    const messageDiv = document.getElementById('assurance-message');
    messageDiv.textContent = message;
    messageDiv.className = `alert alert-${type}`;
    messageDiv.style.display = 'block';
}

// Fonction d'impression
function printAssuranceList() {
    const printWindow = window.open('', '_blank');
    const printContent = document.getElementById('assuranceTable').cloneNode(true);
    
    // Styles d'impression
    const styles = `
        <style>
            body { font-family: Arial, sans-serif; margin: 10px; font-size: 12px; }
            h1 { color: #333; text-align: center; margin-bottom: 5px; font-size: 16px; }
            table { width: 100%; border-collapse: collapse; margin-top: 5px; }
            th, td { border: 1px solid #ddd; padding: 5px; text-align: left; }
            th { background-color: #f2f2f2; }
            .text-right { text-align: right; }
            @page { size: landscape; margin: 5mm; }
            @media print {
                body { margin: 0; padding: 0; }
            }
        </style>
    `;

    printWindow.document.write(`
        <html>
            <head>
                <title>Deals Assurance</title>
                ${styles}
            </head>
            <body>
                <h1>Deals Assurance</h1>
                <p>Imprimé le ${new Date().toLocaleDateString('fr-FR')}</p>
                ${printContent.outerHTML}
            </body>
        </html>
    `);
    printWindow.document.close();
}

// Fonction pour ouvrir le point des facturations
function openPointFacturation() {
    const modalContainer = document.getElementById('modal-container');
    const modalHTML = `
        <div class="modal-overlay" id="facturationModal">
            <div class="modal-content" style="width: 95vw; max-width: none; height: 90vh;">
                <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; border-bottom: 1px solid #ddd;">
                    <h3 class="modal-title" style="margin: 0; font-size: 1.25rem;">
                        <i class="fas fa-file-contract me-2"></i> Point des Facturations
                    </h3>
                    <button class="modal-close btn-close" onclick="closeModal()" aria-label="Fermer">&times;</button>
                </div>

                <div class="modal-body" style="display: flex; flex-direction: column; padding: 15px; gap: 5px; overflow: hidden;">

                    <!-- Filtres -->
                    <div class="filters-panel" style="flex-shrink: 0;">
                        <div style="display: flex; gap: 12px; align-items: end; flex-wrap: wrap;">
                            <!-- Filtre Date Début -->
                            <div style="flex: 1; min-width: 180px;">
                                <label for="filterDateStart" class="form-label small">Date début</label>
                                <input type="date" id="filterDateStart" class="form-control form-control-sm" onchange="applyFacturationFilter()">
                            </div>
                            <!-- Filtre Date Fin -->
                            <div style="flex: 1; min-width: 180px;">
                                <label for="filterDateEnd" class="form-label small">Date fin</label>
                                <input type="date" id="filterDateEnd" class="form-control form-control-sm" onchange="applyFacturationFilter()">
                            </div>
                            <div style="flex: 1; min-width: 180px;">
                                <label for="filterAssurance" class="form-label small">Assurance</label>
                                <select id="filterAssurance" class="form-select form-select-sm" onchange="applyFacturationFilter()">
                                    <option value="">Toutes</option>
                                </select>
                            </div>
                            <div style="flex: 1; min-width: 180px;">
                                <label for="filterCompagnie" class="form-label small">Compagnie</label>
                                <select id="filterCompagnie" class="form-select form-select-sm" onchange="applyFacturationFilter()">
                                    <option value="">Toutes</option>
                                </select>
                            </div>
                            <div style="align-self: center;">
                                <button class="btn btn-outline-secondary btn-sm" onclick="resetFacturationFilter()">
                                    <i class="fas fa-undo me-1"></i> Réinitialiser
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Tableau -->
                    <div class="table-container" style="flex-grow: 1; overflow-y: auto;">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover table-sm" id="facturationTable">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th>Date début</th>
                                        <th>Date fin</th>
                                        <th>Assurance</th>
                                        <th>Compagnie</th>
                                        <th>Date dépôt</th>
                                        <th class="text-end">Montant Total</th>
                                        <th class="text-end">Part Assuré</th>
                                        <th class="text-end">Part Assureur</th>
                                        <th>Nb Factures</th>
                                        <th>PDF Récap</th>
                                        <th>PDF Détail</th>
                                    </tr>
                                </thead>
                                <tbody id="facturationData">
                                    <tr>
                                        <td colspan="11" class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Chargement...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Message -->
                    <div id="facturation-message" class="alert alert-info small mt-2" style="display: none;"></div>
                </div>

                <!-- Footer -->
                <div class="modal-footer d-flex justify-content-between align-items-center p-2 border-top">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="printFacturationList()">
                        <i class="fas fa-print me-1"></i> Imprimer
                    </button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="closeModal()">
                        <i class="fas fa-times me-1"></i> Fermer
                    </button>
                </div>
            </div>
        </div>
    `;

    modalContainer.innerHTML = modalHTML;
    document.getElementById('facturationModal').classList.add('active');
    loadFacturationData();
}

// Variables globales
let allFacturationData = [];
let uniqueAssurances = [];
let uniqueCompagnies = [];

// Chargement des données
async function loadFacturationData() {
    const facturationData = document.getElementById('facturationData');
    const messageDiv = document.getElementById('facturation-message');
    
    facturationData.innerHTML = '<tr><td colspan="11" class="text-center">Chargement en cours...</td></tr>';
    messageDiv.style.display = 'none';

    try {
        const apiUrl = `https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=pointfacturation`;
        
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
        
        const responseData = await response.json();
        
        if (!responseData?.data?.rows) {
            throw new Error('Structure de données invalide');
        }
        
        // Transformation des données
        allFacturationData = responseData.data.rows.map(row => {
            const headers = responseData.data.headers;
            return {
                DateDebut: row[headers.indexOf('Date debut')] || '',
                DateFin: row[headers.indexOf('Date fin')] || '',
                Assurance: row[headers.indexOf('Assurance')] || '',
                Compagnie: row[headers.indexOf('Compagnie')] || '',
                DateDepot: row[headers.indexOf('Date de depot')] || '',
                MontantTotal: parseFloat(row[headers.indexOf('MONTANT TOTAL')]) || 0,
                PartAssure: parseFloat(row[headers.indexOf('PART ASSURE')]) || 0,
                PartAssureur: parseFloat(row[headers.indexOf('PART ASSUREUR')]) || 0,
                NbFactures: row[headers.indexOf('Nbs')] || '',
                PdfRecap: row[headers.indexOf("lien Pdf Recaps")] || '',
                PdfDetail: row[headers.indexOf("lien Pdf Detail")] || ''
            };
        });

        // Récupération des valeurs uniques pour les filtres
        uniqueAssurances = [...new Set(allFacturationData.map(item => item.Assurance).filter(Boolean))];
        uniqueCompagnies = [...new Set(allFacturationData.map(item => item.Compagnie).filter(Boolean))];

        // Peuplement des filtres
        populateSelect('filterAssurance', uniqueAssurances);
        populateSelect('filterCompagnie', uniqueCompagnies);

        displayFilteredFacturation(allFacturationData);
        updateFacturationCount(allFacturationData.length);
        
    } catch (error) {
        console.error('Erreur:', error);
        showFacturationMessage(`❌ Erreur: ${error.message || 'Chargement échoué'}`, 'error');
        facturationData.innerHTML = '<tr><td colspan="11" class="text-center">Erreur de chargement</td></tr>';
    }
}

// Peuplement des select filters
function populateSelect(selectId, values) {
    const select = document.getElementById(selectId);
    select.innerHTML = `<option value="">Tous</option>`;
    
    values.sort().forEach(value => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        select.appendChild(option);
    });
}

// Affichage des données filtrées avec gestion améliorée des PDF
function displayFilteredFacturation(data) {
    const facturationData = document.getElementById('facturationData');
    
    if (!data?.length) {
        facturationData.innerHTML = '<tr><td colspan="11" class="text-center">Aucune donnée trouvée</td></tr>';
        return;
    }
    
    let html = '';
    data.forEach(item => {
        // Gestion des liens PDF
        const pdfRecapBtn = item.PdfRecap && isValidUrl(item.PdfRecap) 
            ? `<a href="${item.PdfRecap}" target="_blank" class="btn btn-sm btn-outline-primary">Voir</a>`
            : '<span class="text-muted">Non disponible</span>';
        
const pdfDetailBtn = item.PdfDetail
    ? `<a href="${item.PdfDetail}" target="_blank" class="btn btn-sm btn-outline-secondary">Voir</a>`
    : '<span class="text-muted">Non disponible</span>';
        html += `
            <tr>
                <td>${formatDate(item.DateDebut)}</td>
                <td>${formatDate(item.DateFin)}</td>
                <td>${item.Assurance}</td>
                <td>${item.Compagnie}</td>
                <td>${formatDate(item.DateDepot)}</td>
                <td class="text-right">${formatCurrency(item.MontantTotal)}</td>
                <td class="text-right">${formatCurrency(item.PartAssure)}</td>
                <td class="text-right">${formatCurrency(item.PartAssureur)}</td>
                <td>${item.NbFactures}</td>
                <td>${pdfRecapBtn}</td>
                <td>${pdfDetailBtn}</td>
            </tr>
        `;
    });
    
    facturationData.innerHTML = html;
}

// Vérifie si une URL est valide
function isValidUrl(string) {
    if (!string || typeof string !== 'string') return false;
    
    // Nettoyage basique de l'URL
    string = string.trim().replace(/\s+/g, '');
    
    try {
        new URL(string);
        return true;
    } catch (_) {
        // Tentative de correction pour les URLs Google Drive avec espaces
        if (string.includes('drive.google.com') && string.includes(' ')) {
            const cleanedUrl = string.replace(/\s/g, '');
            try {
                new URL(cleanedUrl);
                return true;
            } catch (_) {
                return false;
            }
        }
        return false;
    }
}

// Helper pour formater la date
function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return isNaN(date) ? dateString : date.toLocaleDateString('fr-FR');
}

// Helper pour formater les montants
function formatCurrency(amount) {
    return amount.toLocaleString('fr-FR', { 
        minimumFractionDigits: 2, 
        maximumFractionDigits: 2 
    });
}

// Application des filtres
function applyFacturationFilter() {
    const dateStart = document.getElementById('filterDateStart').value;
    const dateEnd = document.getElementById('filterDateEnd').value;
    const assurance = document.getElementById('filterAssurance').value;
    const compagnie = document.getElementById('filterCompagnie').value;
    
    let filteredData = allFacturationData.filter(item => {
        // Conversion des dates en objets Date pour comparaison
        const itemDateDebut = item.DateDebut ? new Date(item.DateDebut) : null;
        const itemDateFin = item.DateFin ? new Date(item.DateFin) : null;
        const startDate = dateStart ? new Date(dateStart) : null;
        const endDate = dateEnd ? new Date(dateEnd) : null;
        
        // Vérification de la plage de dates
        let dateMatch = true;
        if (startDate && endDate) {
            dateMatch = (itemDateDebut >= startDate && itemDateDebut <= endDate) || 
                       (itemDateFin >= startDate && itemDateFin <= endDate);
        } else if (startDate) {
            dateMatch = itemDateDebut >= startDate || itemDateFin >= startDate;
        } else if (endDate) {
            dateMatch = itemDateDebut <= endDate || itemDateFin <= endDate;
        }
        
        const assuranceMatch = !assurance || item.Assurance === assurance;
        const compagnieMatch = !compagnie || item.Compagnie === compagnie;
        
        return dateMatch && assuranceMatch && compagnieMatch;
    });
    
    displayFilteredFacturation(filteredData);
    updateFacturationCount(filteredData.length);
}

// Mise à jour du compteur de résultats
function updateFacturationCount(count) {
    const messageDiv = document.getElementById('facturation-message');
    messageDiv.textContent = `${count} facturations trouvées`;
    messageDiv.className = `alert alert-info`;
    messageDiv.style.display = 'block';
    
    // Masquer après 3 secondes
    setTimeout(() => {
        if (messageDiv.textContent.includes("trouvées")) {
            messageDiv.style.display = 'none';
        }
    }, 3000);
}

// Réinitialisation des filtres
function resetFacturationFilter() {
    document.getElementById('filterDateStart').value = '';
    document.getElementById('filterDateEnd').value = '';
    document.getElementById('filterAssurance').value = '';
    document.getElementById('filterCompagnie').value = '';
    
    displayFilteredFacturation(allFacturationData);
    updateFacturationCount(allFacturationData.length);
}

// Affichage des messages
function showFacturationMessage(message, type) {
    const messageDiv = document.getElementById('facturation-message');
    messageDiv.textContent = message;
    messageDiv.className = `alert alert-${type}`;
    messageDiv.style.display = 'block';
}

// Fonction d'impression
function printFacturationList() {
    const printWindow = window.open('', '_blank');
    const printContent = document.getElementById('facturationTable').cloneNode(true);
    
    // Traitement spécifique pour les PDF
    const pdfCells = printContent.querySelectorAll('td:nth-child(10), td:nth-child(11)');
    pdfCells.forEach(cell => {
        cell.textContent = cell.textContent.includes('Non disponible') ? 'Non disponible' : 'Disponible';
    });

    // Styles d'impression
    const styles = `
        <style>
            body { font-family: Arial, sans-serif; margin: 10px; font-size: 12px; }
            h1 { color: #333; text-align: center; margin-bottom: 5px; font-size: 16px; }
            table { width: 100%; border-collapse: collapse; margin-top: 5px; }
            th, td { border: 1px solid #ddd; padding: 5px; text-align: left; }
            th { background-color: #f2f2f2; }
            .text-right { text-align: right; }
            @page { size: landscape; margin: 5mm; }
            @media print {
                body { margin: 0; padding: 0; }
            }
        </style>
    `;

    printWindow.document.write(`
        <html>
            <head>
                <title>Point des Facturations</title>
                ${styles}
            </head>
            <body>
                <h1>Point des Facturations</h1>
                <p>Imprimé le ${new Date().toLocaleDateString('fr-FR')}</p>
                ${printContent.outerHTML}
            </body>
        </html>
    `);
    printWindow.document.close();
}

// Fonction pour ouvrir la liste des produits avec filtrage instantané
function openListeProduit() {
    const modalContainer = document.getElementById('modal-container');
    const modalHTML = `
        <div class="modal-overlay" id="produitModal">
            <div class="modal-content large-modal">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <i class="fas fa-glasses modal-icon"></i> Liste des Produits
                    </h3>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="filters-panel">
                        <div class="filter-group">
                            <label for="filterCategorie">Catégorie</label>
                            <select id="filterCategorie" class="form-select" onchange="applyProduitFilter()">
                                <option value="">Toutes les catégories</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterFournisseur">Fournisseur</label>
                            <select id="filterFournisseur" class="form-select" onchange="applyProduitFilter()">
                                <option value="">Tous les fournisseurs</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="filterCouleur">Couleur</label>
                            <select id="filterCouleur" class="form-select" onchange="applyProduitFilter()">
                                <option value="">Toutes les couleurs</option>
                            </select>
                        </div>
                        <div class="filter-actions">
                            <button class="btn btn-outline-secondary btn-icon" onclick="resetProduitFilter()">
                                <i class="fas fa-undo"></i> Réinitialiser
                            </button>
                        </div>
                    </div>

                    <div class="table-container">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover produit-catalogue-table" id="produitTable">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>Date d'ajout</th>
                                        <th>Catégorie</th>
                                        <th>Référence</th>
                                        <th>Quantité</th>
                                        <th>Fournisseur</th>
                                        <th>Couleur</th>
                                        <th>Sphere</th>
                                        <th>Cylindre</th>
                                        <th>Add</th>
                                        <th>Diamètre</th>
                                        <th>Informations</th>
                                    </tr>
                                </thead>
                                <tbody id="produitData">
                                    <tr>
                                        <td colspan="11" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="sr-only">Chargement...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="produit-message" class="alert alert-info mt-3" style="display: none;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-icon" onclick="printProduitList()">
                        <i class="fas fa-print"></i> Imprimer la liste
                    </button>
                    <button type="button" class="btn btn-primary btn-icon" onclick="closeModal()">
                        <i class="fas fa-times"></i> Fermer
                    </button>
                </div>
            </div>
        </div>
    `;

    modalContainer.innerHTML = modalHTML;
    document.getElementById('produitModal').classList.add('active');
    loadProduitData();
}

// Variables globales pour les produits
let allProduitData = [];
let uniqueCategorie = [];
let uniqueFournisseur = [];
let uniqueCouleur = [];

// Chargement des données produits
async function loadProduitData() {
    const produitData = document.getElementById('produitData');
    const messageDiv = document.getElementById('produit-message');
    
    produitData.innerHTML = '<tr><td colspan="11" class="text-center">Chargement en cours...</td></tr>';
    messageDiv.style.display = 'none';

    try {
        const apiUrl = `https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=importproduits`;
        
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
        
        const responseData = await response.json();
        
        if (!responseData?.data?.rows) {
            throw new Error('Structure de données invalide');
        }
        
        // Transformation des données
        allProduitData = responseData.data.rows.map(row => {
            const headers = responseData.data.headers;
            return {
                Date: row[headers.indexOf('Date d\'ajout')] || '',
                Categorie: row[headers.indexOf('Catégorie')] || '',
                Reference: row[headers.indexOf('Référence')] || '',
                Quantite: row[headers.indexOf('Quantité')] || 0,
                Fournisseur: row[headers.indexOf('Fournisseur')] || '',
                Couleur: row[headers.indexOf('Couleur')] || '',
                Sphere: row[headers.indexOf('Sphere')] || '',
                Cylindre: row[headers.indexOf('Cylindre')] || '',
                Add: row[headers.indexOf('Add')] || '',
                Diametre: row[headers.indexOf('Diamètre')] || '',
                Informations: row[headers.indexOf('Informations')] || ''
            };
        });

        // Récupération des valeurs uniques pour les filtres
        uniqueCategorie = [...new Set(allProduitData.map(item => item.Categorie).filter(Boolean))];
        uniqueFournisseur = [...new Set(allProduitData.map(item => item.Fournisseur).filter(Boolean))];
        uniqueCouleur = [...new Set(allProduitData.map(item => item.Couleur).filter(Boolean))];

        // Peuplement des filtres
        populateSelect('filterCategorie', uniqueCategorie);
        populateSelect('filterFournisseur', uniqueFournisseur);
        populateSelect('filterCouleur', uniqueCouleur);

        displayFilteredProduit(allProduitData);
        
    } catch (error) {
        console.error('Erreur:', error);
        showProduitMessage(`❌ Erreur: ${error.message || 'Chargement échoué'}`, 'error');
        produitData.innerHTML = '<tr><td colspan="11" class="text-center">Erreur de chargement</td></tr>';
    }
}

// Affichage des données filtrées
function displayFilteredProduit(data) {
    const produitData = document.getElementById('produitData');
    
    if (!data?.length) {
        produitData.innerHTML = '<tr><td colspan="11" class="text-center">Aucun produit trouvé</td></tr>';
        return;
    }
    
    let html = '';
    data.forEach(item => {
        const dateFormatee = new Date(item.Date).toLocaleDateString('fr-FR');
        html += `
            <tr>
                <td>${dateFormatee}</td>
                <td>${item.Categorie}</td>
                <td>${item.Reference}</td>
                <td>${item.Quantite}</td>
                <td>${item.Fournisseur}</td>
                <td>${item.Couleur}</td>
                <td>${item.Sphere}</td>
                <td>${item.Cylindre}</td>
                <td>${item.Add}</td>
                <td>${item.Diametre}</td>
                <td>${item.Informations}</td>
            </tr>
        `;
    });
    
    produitData.innerHTML = html;
}

// Application des filtres
function applyProduitFilter() {
    const categorie = document.getElementById('filterCategorie').value;
    const fournisseur = document.getElementById('filterFournisseur').value;
    const couleur = document.getElementById('filterCouleur').value;
    
    let filteredData = allProduitData.filter(item => {
        return (!categorie || item.Categorie === categorie) &&
               (!fournisseur || item.Fournisseur === fournisseur) &&
               (!couleur || item.Couleur === couleur);
    });
    
    displayFilteredProduit(filteredData);
    showProduitMessage(`🔎 ${filteredData.length} produits trouvés`, 'info');
}

// Réinitialisation des filtres
function resetProduitFilter() {
    document.getElementById('filterCategorie').value = '';
    document.getElementById('filterFournisseur').value = '';
    document.getElementById('filterCouleur').value = '';
    
    displayFilteredProduit(allProduitData);
    showProduitMessage(`↻ Affichage de tous les ${allProduitData.length} produits`, 'info');
}

// Affichage des messages
function showProduitMessage(message, type) {
    const messageDiv = document.getElementById('produit-message');
    messageDiv.textContent = message;
    messageDiv.className = `alert alert-${type}`;
    messageDiv.style.display = 'block';
}

// Fonction d'impression
function printProduitList() {
    const printWindow = window.open('', '_blank');
    const printContent = document.getElementById('produitTable').cloneNode(true);
    
    // Styles d'impression
    const styles = `
        <style>
            body { font-family: Arial, sans-serif; margin: 15px; }
            h1 { color: #333; text-align: center; margin-bottom: 10px; }
            table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.8em; }
            th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
            th { background-color: #f2f2f2; }
            @page { size: auto; margin: 5mm; orientation: landscape; }
            @media print {
                body { margin: 0; padding: 0; }
            }
        </style>
    `;

    printWindow.document.write(`
        <html>
            <head>
                <title>Liste des Produits</title>
                ${styles}
            </head>
            <body>
                <h1>Liste des Produits</h1>
                <p>Imprimé le ${new Date().toLocaleDateString('fr-FR')}</p>
                ${printContent.outerHTML}
            </body>
        </html>
    `);
    printWindow.document.close();
}

// Stockage des erreurs
const errorHistory = [];

// Fonction pour ajouter une erreur
function logError(errorMessage) {
    const error = {
        message: errorMessage,
        timestamp: new Date().toLocaleString()
    };
    
    errorHistory.unshift(error); // Ajoute au début du tableau
    
    // Mettre à jour le badge
    updateNotificationBadge();
    
    // Mettre à jour la liste
    updateNotificationList();
}

// Mettre à jour le badge
function updateNotificationBadge() {
    const badge = document.querySelector('.notification-badge');
    badge.textContent = errorHistory.length;
    badge.style.display = errorHistory.length > 0 ? 'block' : 'none';
}

// Mettre à jour la liste des erreurs
function updateNotificationList() {
    const listContainer = document.querySelector('.notifications-list');
    listContainer.innerHTML = '';
    
    errorHistory.forEach(error => {
        const errorItem = document.createElement('div');
        errorItem.className = 'notification-item';
        errorItem.innerHTML = `
            <div><strong>${error.timestamp}</strong></div>
            <div>${error.message}</div>
        `;
        listContainer.appendChild(errorItem);
    });
}

// Gestion du clic sur l'icône
document.querySelector('.notifications-icon').addEventListener('click', function() {
    const dropdown = document.querySelector('.notifications-dropdown');
    dropdown.classList.toggle('show');
});

// Fermer le dropdown quand on clique ailleurs
document.addEventListener('click', function(event) {
    if (!event.target.closest('.notifications-container')) {
        document.querySelector('.notifications-dropdown').classList.remove('show');
    }
});

// Exemple d'utilisation dans vos catch
try {
    // code qui peut échouer
} catch (error) {
    console.error(error);
    logError(error.message);
    // Affichez aussi à l'utilisateur si nécessaire
}
</script>
  <!-- Fin de la barre unique -->
            <section class="dashboard-section">
                <div class="dashboard-header">
                    <h1>Tableau de bord</h1>
                    <div class="dashboard-buttons">
                        <button class="btn btn-primary" onclick="openNewSale()">
                            <i class="fas fa-cash-register"></i> Nouvelle Vente
                        </button>
                    </div>
                </div>

                <div class="quick-actions">
                        <button class="quick-action-btn" onclick="openNewSale()">
                        <i class="fas fa-cash-register"></i>
                        <span class="btn-text">Nouvelle Vente</span>
                        <span class="btn-desc">Créer une nouvelle vente</span>
                    </button>
                    <button class="quick-action-btn" onclick="openDepense()">
                        <i class="fas fa-money-bill-wave"></i>
                        <span class="btn-text">Ajouter une Dépense</span>
                        <span class="btn-desc">Ajouter une Dépense Cash</span>
                    </button>
                    <button class="quick-action-btn" onclick="openDevis()">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <span class="btn-text">Proforma</span>
                        <span class="btn-desc">Créer un devis</span>
                    </button>
                        <button class="quick-action-btn" onclick="openDepensesJournal()">
                            <i class="fas fa-sign-out-alt"></i>
                            <span class="btn-text">Dépense</span>
                            <span class="btn-desc">Journal des Dépenses</span>
                        </button>
                    <button class="quick-action-btn" onclick="openEntreesJournal()">
                        <i class="fas fa-sign-in-alt"></i>
                        <span class="btn-text">Entrées</span>
                        <span class="btn-desc">Journal des Entrées</span>
                    </button>
                    <button class="quick-action-btn" onclick="openLooker()">
                        <i class="fas fa-chart-line"></i>
                        <span class="btn-text">Statistiques</span>
                        <span class="btn-desc">Voir les performances</span>
                    </button>

                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="section-title">
                            <i class="fas fa-users"></i>
                            Liste des Clients
                        </h2>
                        <div class="search-container">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchInput" placeholder="Rechercher par ID..." />
                        </div>
                    </div>

                    <div id="loading-indicator" class="loading-indicator">
                        <div class="loading-spinner"></div>
                        <p>Chargement des clients...</p>
                    </div>
                    
                    <div id="error-message" class="error-message"></div>
                        <div id="table-container">
                            <div class="table-responsive">
                                <table id="client-table">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            
                        </div>


                    <div class="pagination-controls">
                        <div class="pagination-info" id="page-info">
                            Affichage de 1 à 3 sur 25 clients
                        </div>
                        <div class="pagination-buttons">
                            <button class="pagination-btn" id="prevPage" disabled>
                                <i class="fas fa-chevron-left"></i> Précédent
                            </button>
                            <button class="pagination-btn">1</button>
                            <button class="pagination-btn">2</button>
                            <button class="pagination-btn">3</button>
                            <button class="pagination-btn" id="nextPage">
                                Suivant <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="items-per-page">
                            <span>Affichage :</span>
                            <select id="itemsPerPageSelect">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
<div id="modal-container"></div>

    <!-- Modale Proforma -->
    
    <div class="modal-overlay" id="proformaModal">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title">Facture Proforma</h3>
                <button class="modal-close" onclick="closeDevis()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-container">
                    <form id="client-form" method="POST"> 
                        <!-- Stepper Navigation -->
                        <div class="stepper">
                            <div class="step active" id="step1">
                                <div class="step-number">1</div>
                                <div class="step-label">Informations Client</div>
                            </div>
                            <div class="step" id="step2">
                                <div class="step-number">2</div>
                                <div class="step-label">Prescription</div>
                            </div>
                            <div class="step" id="step4">
                                <div class="step-number">3</div>
                                <div class="step-label">Paiement</div>
                            </div>
                        </div>
                        
                        <!-- Step 1: Client Information -->
                        <div class="form-section active" id="section1">
                            <h2 class="section-title">INFORMATION CLIENT</h2>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="nom_complet" class="required-field">Nom complet du client</label>
                                    <input type="text" name="nom_complet" id="nom_complet" required />
                                </div>

                                <div class="form-group">
                                    <label class="required-field">Contact</label>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <input type="text" name="indicatif" placeholder="+229" value="+229" style="width: 70px;" required/>

                                        <input type="tel" name="numero" placeholder="012345678" required />
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="date_naissance" class="required-field">Né le</label>
                                    <input type="date" name="date_naissance" id="date_naissance" required />
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="entreprise">Entreprise</label>
                                    <select name="entreprise" id="entreprise">
                                        <option value="">-- Entreprise --</option>
                                        <option value="CEI">CEI</option>
                                        <option value="SONEB">SONEB</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="civilite" class="required-field">Civilité</label>
                                    <select name="civilite" id="civilite" required>
                                        <option value="">-- Civilité --</option>
                                        <option value="Enfant">Enfant</option>
                                        <option value="M.">M.</option>
                                        <option value="Mme">Mme</option>
                                        <option value="Mlle">Mlle</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="agence" class="required-field">Agence</label>
                                    <select name="agence" id="agence" required>
                                        <option value="">-- Agence --</option>
                                        <option value="cotonou">Cotonou</option>
                                        <option value="calavi">Calavi</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-navigation">
                                <button type="button" class="btn btn-secondary" id="cancelButton">
                                    <i class="fas fa-times"></i> Annuler
                                </button>
                                <button type="button" class="btn btn-primary next-step" data-next="2">
                                    Suivant <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Step 2: Prescription -->
                        <div class="form-section" id="section2">
                            <h2 class="section-title">PRESCRIPTION ET COMMANDE</h2>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="type_verre" class="required-field">Type de Verre</label>
                                    <select name="type_verre" id="type_verre" required>
                                        <option value="">-- Type de Verre --</option>
                                        <option value="photo ar">Photo AR</option>
                                        <option value="photo max">Photo Max</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="gamme_verre" class="required-field">Gamme des Verres</label>
                                    <select name="gamme_verre" id="gamme_verre" required>
                                        <option value="">-- Gamme --</option>
                                        <option value="GA">Ga</option>
                                        <option value="GB">Gb</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="choix_monture" class="required-field">Choix de Monture</label>
                                    <select name="choix_monture" id="choix_monture" required>
                                        <option value="">-- Choix de Monture --</option>
                                    </select>
                                </div>
                            </div>

                            <div class="prescription-table-container">
                                <table class="prescription-table">
                                    <thead>
                                        <tr>
                                            <th>Œil</th>
                                            <th>Sphere</th>
                                            <th>Cylindre</th>
                                            <th>Axe</th>
                                            <th>ADD</th>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        <tr>
                                            <td>OD</td>
                                            <td>
                                                <select name="od_sphere" required>
                                                    <option value="">0.00</option>
                                                </select>
                                            </td>
                                            <td>
                                                <select name="od_cylindre">
                                                         <option value="">0.00</option>
                                                </select>
                                            </td>
                                            <td>
                                                <select name="od_axe">
                                                        <option value="">0</option>
                                                </select>
                                            </td>
                                            <td>
                                                <select name="od_add">
                                                         <option value="">0.00</option>
                                                </select>
                                            </td>
                                        </tr>

                                        <tr>
                                            <td>OG</td>
                                            <td>
                                                <select name="og_sphere" required>
                                                         <option value="">0.00</option>
                                                </select>
                                            </td>
                                            <td>
                                                <select name="og_cylindre">
                                                         <option value="">0.00</option>
                                                </select>
                                            </td>
                                            <td>
                                                <select name="og_axe">
                                                         <option value="">0</option>
                                                </select>
                                            </td>
                                            <td>
                                                <select name="og_add">
                                                         <option value="">0.00</option>
                                                </select>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="form-row" style="margin-top: 1rem;">
                                <div class="form-group">
                                    <label for="clinique">Clinique</label>
                                    <select name="clinique" id="clinique">
                                        <option value="">-- Choisir --</option>
                                    </select>
                                </div>
                            
                                <div class="form-group">
                                    <label for="ophtalmo">Ophtalmo</label>
                                    <select name="ophtalmo" id="ophtalmo">
                                        <option value="">-- Choisir --</option>
                                    </select>
                                </div>
                            
                                <div class="form-group">
                                    <label for="date_soin">Date de soin</label>
                                    <input type="date" name="date_soin" id="date_soin" />
                                </div>
                            </div>
                            
                            <div class="form-navigation">
                                <button type="button" class="btn btn-secondary prev-step" data-prev="1">
                                    <i class="fas fa-arrow-left"></i> Précédent
                                </button>
                                <button type="button" class="btn btn-primary next-step" data-next="4">
                                    Suivant <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Step 4: Payment -->
                        <div class="form-section" id="section4">
                            <h2 class="section-title">DÉTAILS DE PAIEMENT</h2>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="required-field">Montant Monture (FCFA)</label>
                                    <input type="number" name="montant_monture" id="montant_monture" required oninput="calculerTotalPro()" />
                                </div>
                                
                                <div class="form-group">
                                    <label class="required-field">Montant Verres (FCFA)</label>
                                    <input type="number" name="montant_verres" id="montant_verres" required oninput="calculerTotalPro()" />
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Total Brut (FCFA)</label>
                                    <input type="number" name="total_brut" id="total_brut" readonly />
                                </div>
                                
                                <div class="form-group">
                                    <label>Remise</label>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <input type="number" name="remise" id="remise" value="0" oninput="calculerTotalPro()" style="flex: 2;" />
                                        <select name="remise_type" id="remise_type" onchange="calculerTotalPro()" style="flex: 1;">
                                            <option value="FCFA">FCFA</option>
                                            <option value="%">%</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Net à payer (FCFA)</label>
                                    <input type="number" name="net_a_payer" id="net_a_payer" readonly />
                                </div>
                            </div>
                            
                            <div class="form-navigation">
                                <button type="button" class="btn btn-secondary prev-step" data-prev="2">
                                    <i class="fas fa-arrow-left"></i> Précédent
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Save and Print
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="loader-overlay" id="loaderOverlay">
    <div class="loader-content">
        <div class="loader-spinner"></div>
        <div class="loader-text">Chargement du formulaire...</div>
    </div>
</div>
<div id="submitLoader" class="submit-loader">
    <div class="submit-loader-content">
        <div class="submit-spinner"></div>
        <div class="submit-message">Enregistrement en cours</div>
        <div class="progress-bar">
            <div class="progress"></div>
        </div>
    </div>
</div>

<style>
.submit-loader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.submit-loader.active {
    display: flex;
}

.submit-loader-content {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    text-align: center;
    width: 90%;
    max-width: 400px;
}

.submit-spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #4361ee;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

.submit-message {
    font-weight: 600;
    margin-bottom: 1rem;
}

.progress-bar {
    height: 6px;
    background: #f0f0f0;
    border-radius: 3px;
    overflow: hidden;
}

.progress {
    height: 100%;
    width: 0;
    background: linear-gradient(90deg, #4361ee, #3a56d4);
    animation: progress 2s ease-in-out infinite;
}

@keyframes progress {
    0% { width: 0; }
    50% { width: 80%; }
    100% { width: 100%; }
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
   
    <script>
                // Fonctions pour gérer la modale
async function openDevis() {
    const modal = document.getElementById('proformaModal');
    
    // Afficher le loader
    document.getElementById('loaderOverlay').classList.add('active');
    
    try {
        // Charger les données si pas déjà en cache
        if (!appDataCache) {
            await loadDataFromSheet();
        }
        
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    } catch (error) {
        console.error("Erreur lors du chargement:", error);
        alert("Erreur lors du chargement des données");
    } finally {
        // Cacher le loader
        document.getElementById('loaderOverlay').classList.remove('active');
    }
}

    // Fonction pour afficher un loader pendant la génération du PDF
 async function generatePDFWithLoader() {
    const loader = document.getElementById('loaderOverlay');
    const loaderText = loader.querySelector('.loader-text');
    
    try {
        loaderText.textContent = 'Génération du PDF en cours...';
        loader.classList.add('active');
        
        // Attendre un court délai pour permettre l'affichage du loader
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Attendre la génération du PDF
        await generatePDF();
    } catch (error) {
        console.error("Erreur lors de la génération du PDF:", error);
        alert("Erreur lors de la génération du PDF: " + error.message);
    } finally {
        loader.classList.remove('active');
    }
}

document.getElementById('client-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Activer le loader d'envoi
    document.getElementById('submitLoader').classList.add('active');
    
    try {
        await generatePDF();
    } catch (error) {
        console.error("Erreur:", error);
        alert("Erreur lors de la génération du PDF");
    } finally {
        // Désactiver le loader d'envoi
        document.getElementById('submitLoader').classList.remove('active');
    }
});

        function closeDevis() {
            document.getElementById('proformaModal').classList.remove('active');
            document.body.style.overflow = ''; // Rétablit le défilement
        }

        // Calcul des totaux
document.addEventListener("DOMContentLoaded", function() {
    function calculerTotalPro() {
        const montantMonture = parseFloat(document.getElementById('montant_monture').value) || 0;
        const montantVerres = parseFloat(document.getElementById('montant_verres').value) || 0;
        const remise = parseFloat(document.getElementById('remise').value) || 0;
        const remiseType = document.getElementById('remise_type').value;

        const totalBrut = montantMonture + montantVerres;
        document.getElementById('total_brut').value = totalBrut.toFixed(2);

        let montantRemise = remiseType === '%' ? totalBrut * (remise / 100) : remise;
        const netAPayer = totalBrut - montantRemise;
        document.getElementById('net_a_payer').value = Math.max(0, netAPayer).toFixed(2);
    }

    // Rendre la fonction globale si nécessaire
    window.calculerTotalPro = calculerTotalPro;
});


function validateStep() {
    return true; // Valide toujours
}

        function updateStepper(activeStep) {
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active', 'completed');
                
                const stepNumber = parseInt(step.id.replace('step', ''));
                if (stepNumber < activeStep) {
                    step.classList.add('completed');
                } else if (stepNumber == activeStep) {
                    step.classList.add('active');
                }
            });
        }
    // Initialisation au chargement
document.addEventListener('DOMContentLoaded', async () => {
    // Charger les données au premier affichage de la modale
    document.getElementById('proformaModal').addEventListener('click', async function(e) {
        if (e.target === this && !appDataCache) {
            await loadDataPdf();
        }
    });

    // Gestion du formulaire
    document.getElementById('client-form').addEventListener('submit', function(e) {
        e.preventDefault();
        generatePDF();
    });
});


// URL de votre Web App Google Apps Script
const DATA_SOURCE_URL = 'https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=catalogue';

// Cache pour stocker les données chargées
let appDataCache = null;
async function loadDataPdf() {
    console.log('Début du chargement des données...'); // Debug
    try {
        console.log('Envoi de la requête à:', DATA_SOURCE_URL); // Debug
        const response = await fetch(DATA_SOURCE_URL);
        
        console.log('Réponse reçue, status:', response.status); // Debug
        if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
        
        const data = await response.json();
        console.log('Données reçues:', data); // Debug
        
        if (!data.success) throw new Error("Réponse invalide du serveur.");
        if (!data.data) throw new Error("Données manquantes dans la réponse");

        appDataCache = data.data;
        console.log('Données mises en cache:', appDataCache); // Debug
        populateData(data.data);
        
    } catch (error) {
        console.error('Erreur lors du chargement:', error);
        alert(`Erreur lors du chargement: ${error.message}`);
    } finally {
        console.log('Chargement terminé'); // Debug
    }
}

function populateData(data) {
    console.log('Début du remplissage des données'); // Debug
    if (!data) {
        console.error('Aucune donnée à remplir');
        return;
    }
    
    console.log('Données disponibles:', Object.keys(data)); // Debug
    
    // Liste des champs à remplir avec leurs données correspondantes
    const fieldsToPopulate = [
        { id: 'entreprise', data: data.entreprises },
        { id: 'agence', data: data.agences },
        { id: 'type_verre', data: data.typesVerre },
        { id: 'gamme_verre', data: data.gammesVerre },
        { id: 'choix_monture', data: data.montures },
        { id: 'clinique', data: data.cliniques },
        { id: 'ophtalmo', data: data.ophtalmos }
    ];

    console.log('Champs à remplir:', fieldsToPopulate); // Debug

    fieldsToPopulate.forEach(field => {
        console.log(`Traitement du champ ${field.id}`); // Debug
        if (Array.isArray(field.data)) {
            console.log(`Données pour ${field.id}:`, field.data); // Debug
            populateSelect(field.id, field.data);
        } else {
            console.warn(`Pas de données pour ${field.id}`); // Debug
        }
    });

    // Gestion des champs de prescription
    const prescriptionFields = [
        { name: 'od_sphere', data: data.sphere },
        { name: 'od_cylindre', data: data.sphere },
        { name: 'od_axe', data: data.axe },
        { name: 'od_add', data: data.add },
        { name: 'og_sphere', data: data.sphere },
        { name: 'og_cylindre', data: data.sphere },
        { name: 'og_axe', data: data.axe },
        { name: 'og_add', data: data.add }
    ];

    console.log('Champs de prescription:', prescriptionFields); // Debug

    prescriptionFields.forEach(field => {
        console.log(`Traitement du champ ${field.name}`); // Debug
        if (Array.isArray(field.data)) {
            console.log(`Données pour ${field.name}:`, field.data); // Debug
            populatePrescriptionOptions(field.name, field.data);
        } else {
            console.warn(`Pas de données pour ${field.name}`); // Debug
        }
    });
}

// Fonction utilitaire pour remplir un select
function populateSelect(id, options) {
    const select = document.getElementById(id);
    if (!select) return;
    
    // Sauvegarder la valeur sélectionnée actuelle
    const currentValue = select.value;
    
    // Vider le select sauf la première option
    while (select.options.length > 1) {
        select.remove(1);
    }
    
    // Ajouter les nouvelles options
    options.forEach(option => {
        const opt = document.createElement('option');
        opt.value = option;
        opt.textContent = option;
        select.appendChild(opt);
    });
    
    // Restaurer la valeur sélectionnée si elle existe toujours
    if (currentValue && options.includes(currentValue)) {
        select.value = currentValue;
    }
}

// Fonction utilitaire pour les champs de prescription
function populatePrescriptionOptions(selectName, values) {
    const selects = document.getElementsByName(selectName);
    if (!selects || selects.length === 0) return;
    
    const select = selects[0];
    const currentValue = select.value;
    
    // Vider le select sauf la première option
    while (select.options.length > 1) {
        select.remove(1);
    }
    
    // Ajouter les nouvelles options
    values.forEach(value => {
        const opt = document.createElement('option');
        opt.value = value;
        opt.textContent = value;
        select.appendChild(opt);
    });
    
    // Restaurer la valeur sélectionnée si elle existe toujours
    if (currentValue && values.includes(currentValue)) {
        select.value = currentValue;
    }
}

async function generatePDF() {
    // Vérifier si jsPDF est chargé
    if (typeof window.jspdf === 'undefined') {
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js');
    }

    // Utiliser jsPDF via window.jspdf
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

    // Récupérer les données du formulaire
    const formData = {
        nom_complet: document.getElementById('nom_complet').value,
        contact: document.querySelector('input[name="indicatif"]').value + ' ' + 
                document.querySelector('input[name="numero"]').value,
        date_naissance: document.getElementById('date_naissance').value,
        entreprise: document.getElementById('entreprise').value,
        civilite: document.getElementById('civilite').value,
        agence: document.getElementById('agence').value,
        type_verre: document.getElementById('type_verre').value,
        gamme_verre: document.getElementById('gamme_verre').value,
        choix_monture: document.getElementById('choix_monture').value,
        od_sphere: document.querySelector('select[name="od_sphere"]').value,
        od_cylindre: document.querySelector('select[name="od_cylindre"]').value,
        od_axe: document.querySelector('select[name="od_axe"]').value,
        od_add: document.querySelector('select[name="od_add"]').value,
        og_sphere: document.querySelector('select[name="og_sphere"]').value,
        og_cylindre: document.querySelector('select[name="og_cylindre"]').value,
        og_axe: document.querySelector('select[name="og_axe"]').value,
        og_add: document.querySelector('select[name="og_add"]').value,
        clinique: document.getElementById('clinique').value,
        ophtalmo: document.getElementById('ophtalmo').value,
        date_soin: document.getElementById('date_soin').value,
        montant_monture: document.getElementById('montant_monture').value,
        montant_verres: document.getElementById('montant_verres').value,
        total_brut: document.getElementById('total_brut').value,
        remise: document.getElementById('remise').value,
        remise_type: document.getElementById('remise_type').value,
        net_a_payer: document.getElementById('net_a_payer').value
    };

// === Barre colorée à gauche ===
pdf.setFillColor(50, 90, 160);
pdf.rect(15, 15, 5, 250, 'F'); // Barre verticale

// === En-tête simplifié, moderne ===
pdf.setFont('helvetica', 'normal');
pdf.setFontSize(24);
pdf.setTextColor(50, 90, 160);
pdf.text('Digital Optic Sarl', 30, 30);

pdf.setFontSize(10);
pdf.setTextColor(100, 100, 100);
pdf.text('Tel: +229 77 455 12 21', 30, 38);
pdf.text('info@optic.com', 30, 44);
pdf.text('Jet d\'eau - Dakar', 30, 50);

// Date et N° facture en haut à droite
pdf.setFont('helvetica', 'normal');
pdf.setFontSize(9);
pdf.setTextColor(120, 120, 120);
const today = new Date().toISOString().slice(0,10);
pdf.text(`Date: ${today}`, 180, 30, { align: 'right' });
pdf.text(`Facture Proforma`, 180, 40, { align: 'right', fontStyle: 'bold' });

pdf.setDrawColor(200);
pdf.setLineWidth(0.5);
pdf.line(30, 55, 185, 55);

// === Deux colonnes à partir d’ici ===
let startY = 65;
const colLeftX = 30;
const colRightX = 110;

// ==== Colonne gauche : Infos client ====
pdf.setFont('helvetica', 'bold');
pdf.setFontSize(11);
pdf.setTextColor(50, 90, 160);
pdf.text('Informations Client', colLeftX, startY);

pdf.setFont('helvetica', 'normal');
pdf.setFontSize(10);
pdf.setTextColor(70);

const leftLines = [
    `${formData.civilite} ${formData.nom_complet}`,
    `Téléphone : ${formData.contact}`,
    `Né le    : ${formData.date_naissance}`,
    `Entreprise: ${formData.entreprise}`,
    `Agence   : ${formData.agence}`
];

let lineY = startY + 8;
leftLines.forEach(line => {
    pdf.text(line, colLeftX, lineY);
    lineY += 6;
});

// ==== Colonne droite : Commande ====
pdf.setFont('helvetica', 'bold');
pdf.setFontSize(11);
pdf.setTextColor(50, 90, 160);
pdf.text('Commande', colRightX, startY);

pdf.setFont('helvetica', 'normal');
pdf.setFontSize(10);
pdf.setTextColor(70);

const rightLines = [
    `Type de verre : ${formData.type_verre}`,
    `Gamme        : ${formData.gamme_verre}`,
    `Monture     : ${formData.choix_monture}`,
    `Clinique    : ${formData.clinique}`,
    `Ophtalmo   : ${formData.ophtalmo}`,
    `Date soin  : ${formData.date_soin}`
];

let rightY = startY + 8;
rightLines.forEach(line => {
    pdf.text(line, colRightX, rightY);
    rightY += 6;
});

const maxY = Math.max(lineY, rightY) + 10;

// ==== Prescription en pleine largeur ====
pdf.setDrawColor(50, 90, 160);
pdf.setLineWidth(1);
pdf.rect(25, maxY, 160, 50);

pdf.setFont('helvetica', 'bold');
pdf.setFontSize(12);
pdf.setTextColor(50, 90, 160);
pdf.text('Prescription Verres', 30, maxY + 12);

pdf.setFont('helvetica', 'normal');
pdf.setFontSize(10);
pdf.setTextColor(0);

const prescriptionHead = ['Œil', 'Sphère', 'Cylindre', 'Axe', 'Add'];
const prescriptionBody = [
    ['OD', formData.od_sphere, formData.od_cylindre, formData.od_axe, formData.od_add],
    ['OG', formData.og_sphere, formData.og_cylindre, formData.og_axe, formData.og_add]
];

pdf.autoTable({
    startY: maxY + 16,
    head: [prescriptionHead],
    body: prescriptionBody,
    headStyles: {
        fillColor: [50, 90, 160],
        textColor: 255,
        fontStyle: 'bold',
        fontSize: 11
    },
    styles: {
        fontSize: 10,
        textColor: 30,
        cellPadding: 4
    },
    margin: { left: 30, right: 30 },
    tableWidth: 160
});

const paymentY = pdf.autoTable.previous.finalY + 15;

// --- Montants ---
let yPos = pdf.autoTable.previous.finalY + 10;
pdf.setFont('helvetica', 'bold');
pdf.text(`Brut : ${formData.total_brut} F`, 30, yPos);
yPos += 5;
pdf.text(`Remise : ${formData.remise} ${formData.remise_type}`, 30, yPos);
yPos += 5;
pdf.text(`Net à Payer : ${formData.net_a_payer} F`, 30, yPos);

// --- Montant en lettres ---
yPos += 10;
pdf.setFontSize(9);
pdf.setFont('helvetica', 'normal');
pdf.text(`ARRETÉE LA PRÉSENTE FACTURE PROFORMA À LA SOMME DE ${formData.net_a_payer} FRANCS CFA`, 30, yPos);

// ==== Pied de page minimaliste ====
const footerY = yPos + 50;
pdf.setDrawColor(50, 90, 160);
pdf.setLineWidth(0.8);
pdf.line(30, footerY, 185, footerY);

pdf.setFont('helvetica', 'italic');
pdf.setFontSize(9);
pdf.setTextColor(80);
pdf.text('Prenez soin de vos yeux avec Digital Optic.', 105, footerY + 10, { align: 'center' });
pdf.text('Contactez-nous: +229 77 183 73 33 | info@optic.com', 105, footerY + 18, { align: 'center' });

// === Enregistrer le PDF ===
const fileName = `Facture_${formData.nom_complet.replace(/ /g, '_')}_${today}.pdf`;
pdf.save(fileName);

    
    // Fermer la modale après génération
    closeDevis();
}

// Fonction utilitaire pour charger les scripts
function loadScript(src) {
    return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
    });
}
//fin proforma
</script>

    
<script>
    // Variables globales
    let allClientsData = [];
    let filteredClients = [];
    let currentPage = 1;
    let itemsPerPage = 10;
    let currentSortColumn = null;
    let currentSortDirection = 'asc';

    // Chargement des clients depuis l'API
async function loadClientsFromScript() {
    showLoading();

    const apiUrl = "https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=liste";

    try {
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);

        const responseData = await response.json();
        
        console.log("Réponse API:", responseData); // Pour débogage
        
        if (!responseData.success || !responseData.data) {
            throw new Error("Réponse inattendue de l'API");
        }

        const { headers, rows } = responseData.data;
        
        // Vérification des données reçues
        console.log("En-têtes reçus:", headers);
        console.log("Première ligne reçue:", rows.length > 0 ? rows[0] : "Aucune donnée");
        
        if (!Array.isArray(headers) || !Array.isArray(rows)) {
            throw new Error("Structure de données invalide");
        }

        allClientsData = rows;
        filteredClients = [...allClientsData];
        
        renderTableHeaders(headers);
        updateTableAndPagination();

    } catch (error) {
        console.error("Erreur de chargement:", error);
        displayError(error.message || "Erreur lors du chargement des clients");
    } finally {
        hideLoading();
    }
}

    // Affichage des en-têtes du tableau
    function renderTableHeaders(headers) {
        const thead = document.querySelector("#client-table thead");
        thead.innerHTML = "";

        const tr = document.createElement("tr");

        headers.forEach((header, index) => {
            const th = document.createElement("th");
            th.textContent = header;
            th.setAttribute('data-column', index);
            th.addEventListener('click', () => sortTable(index));
            tr.appendChild(th);
        });

        thead.appendChild(tr);
    }

    // Affichage des lignes du tableau
    function renderTableRows(rows) {
        const tbody = document.querySelector("#client-table tbody");
        tbody.innerHTML = "";

        if (!rows || rows.length === 0) {
            // Créez un message "Aucune donnée" si nécessaire
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = document.querySelector("#client-table thead th").length;
            td.textContent = "Aucun client trouvé";
            td.style.textAlign = "center";
            tr.appendChild(td);
            tbody.appendChild(tr);
            return;
        }

        rows.forEach((row, rowIndex) => {
            const tr = document.createElement("tr");

            row.forEach((cell, cellIndex) => {
                const td = document.createElement("td");

                if (cellIndex === 0) {
                    const link = document.createElement("a");
                    link.href = "#";
                    link.className = "client-link";
                    link.textContent = cell || "";
                    link.onclick = (e) => {
                        e.preventDefault();
                        selectClient(row);
                    };
                    td.appendChild(link);
                } else {
                    td.textContent = cell || "0";
                }

                tr.appendChild(td);
            });

            tbody.appendChild(tr);
        });
    }

    // Sélection d'un client
    function selectClient(clientData) {
        localStorage.setItem("selectedClient", JSON.stringify(clientData));
        window.location.href = "DetailClient.html";
    }

    // Filtrage des clients
    function applySearchFilter() {
        const searchTerm = document.getElementById("searchInput").value.toLowerCase();

        if (!searchTerm) {
            filteredClients = [...allClientsData];
        } else {
            filteredClients = allClientsData.filter(client => {
                return client[0]?.toLowerCase().includes(searchTerm);
            });
        }

        currentPage = 1;
        updateTableAndPagination();
    }

    // Tri du tableau
    function sortTable(columnIndex) {
        if (currentSortColumn === columnIndex) {
            currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            currentSortColumn = columnIndex;
            currentSortDirection = 'asc';
        }

        filteredClients.sort((a, b) => {
            const valA = a[columnIndex] ?? '';
            const valB = b[columnIndex] ?? '';

            if (currentSortDirection === 'asc') {
                return String(valA).localeCompare(String(valB));
            } else {
                return String(valB).localeCompare(String(valA));
            }
        });

        updateTableAndPagination();
    }

    // Mise à jour de la pagination
    function updateTableAndPagination() {
        const totalItems = filteredClients.length;
        const totalPages = Math.ceil(totalItems / itemsPerPage) || 1;
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
        const rowsToDisplay = filteredClients.slice(startIndex, endIndex);

        // Mise à jour des informations de pagination
        const paginationInfo = document.querySelector(".pagination-info");
        if (paginationInfo) {
            paginationInfo.textContent = `Affichage de ${startIndex + 1} à ${endIndex} sur ${totalItems} clients`;
        }

        // Mise à jour des boutons de navigation
        document.getElementById("prevPage").disabled = currentPage <= 1;
        document.getElementById("nextPage").disabled = currentPage >= totalPages;

        // Affichage des données
        renderTableRows(rowsToDisplay);
    }

    // Navigation entre les pages
    function goToPrevPage() {
        if (currentPage > 1) {
            currentPage--;
            updateTableAndPagination();
        }
    }

    function goToNextPage() {
        const totalPages = Math.ceil(filteredClients.length / itemsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            updateTableAndPagination();
        }
    }

    // Gestion des états de chargement
    function showLoading() {
        document.getElementById("loading-indicator").style.display = "block";
        document.getElementById("error-message").style.display = "none";
        document.getElementById("table-container").style.display = "none";
    }

    function hideLoading() {
        document.getElementById("loading-indicator").style.display = "none";
        document.getElementById("table-container").style.display = "block";
    }

    function displayError(message) {
        document.getElementById("error-message").textContent = message;
        document.getElementById("error-message").style.display = "block";
    }

    // Global function to close any active modal

async function fetchDataFromGoogleSheet() {
    try {
        const response = await fetch('https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=getconfigdata');

        if (!response.ok) {
            throw new Error(`Erreur HTTP! statut: ${response.status}`);
        }

        const responseData = await response.json();
        console.log("Réponse complète:", responseData); // Pour débogage
        
        // Modification ici: vérifier responseData.data au lieu de responseData
        if (!responseData.success || !responseData.data) {
            throw new Error(responseData.message || "Réponse inattendue de l'API");
        }

        // Modification ici: accéder aux données via responseData.data
        const { categories, agences } = responseData.data;
        
        // Vérification des données requises
        if (!categories || !agences) {
            throw new Error("Structure de données incomplète");
        }

        console.log("Catégories reçues:", categories);
        console.log("Agences reçues:", agences);

        return {
            success: true,
            categories: categories,
            agences: agences
        };

    } catch (error) {
        console.error("Erreur fetchDataFromGoogleSheet:", error);
        throw error;
    }
}
// Function to fetch categories from Google Sheets
window.openDepense = async function() {
    const modalContainer = document.getElementById('modal-container');

    // Afficher un loader pendant le chargement
    modalContainer.innerHTML = `
        <div class="modal-overlay active" id="loadingModal">
            <div class="modal-content" style="text-align: center; padding: 2rem;">
                <div class="loading-spinner"></div>
                <p>Chargement des données...</p>
            </div>
        </div>
    `;

    try {
        // Récupérer les données de configuration
        const { categories, agences } = await fetchDataFromGoogleSheet();

        const modalHTML = `
            <div class="modal-overlay" id="depenseModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Ajouter une Dépense</h3>
                        <button class="modal-close" onclick="closeModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="depenseForm">
                            <div class="form-group">
                                <label for="depenseDate">Date <span class="required">*</span></label>
                                <input type="date" id="depenseDate" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="depenseAgence">Agence <span class="required">*</span></label>
                                <select id="depenseAgence" class="form-control select-control" required>
                                    <option value="">Sélectionner une agence</option>
                                    ${agences.map(agence =>
                                        `<option value="${agence}">${agence}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="depenseDesignation">Désignation <span class="required">*</span></label>
                                <input type="text" id="depenseDesignation" class="form-control" placeholder="Description de la dépense" required>
                            </div>
                            <div class="form-group">
                                <label for="depenseCategorie">Catégorie <span class="required">*</span></label>
                                <select id="depenseCategorie" class="form-control select-control" required>
                                    <option value="">Sélectionner une catégorie</option>
                                    ${categories.map(cat =>
                                        `<option value="${cat.value}">${cat.label}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="depenseMontant">Montant (FCFA) <span class="required">*</span></label>
                                <input type="number" id="depenseMontant" class="form-control" placeholder="0" required>
                            </div>
                            
                            <div id="form-message" class="form-message"></div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                        <button type="button" class="btn btn-primary" onclick="submitDepense()">Enregistrer</button>
                    </div>
                </div>
            </div>
        `;

        modalContainer.innerHTML = modalHTML;

        // Afficher la modal
        setTimeout(() => {
            document.getElementById('depenseModal').classList.add('active');
            document.getElementById('depenseDate').value = new Date().toISOString().split('T')[0];
        }, 10);

    } catch (error) {
        console.error("Erreur:", error);
        modalContainer.innerHTML = `
            <div class="modal-overlay active" id="errorModal">
                <div class="modal-content" style="text-align: center; padding: 2rem;">
                    <i class="fas fa-exclamation-triangle" style="color: var(--danger-color); font-size: 2rem; margin-bottom: 1rem;"></i>
                    <h4>Erreur de chargement</h4>
                    <p>Impossible de charger les données nécessaires depuis le tableur.</p>
                    <p><strong>Détails :</strong> ${error.message}</p>
                    <button class="btn btn-danger" onclick="closeModal()">Fermer</button>
                </div>
            </div>
        `;
    }
};
    // Function to submit the expense
async function submitDepense() {
    const form = document.getElementById('depenseForm');
    const formMessage = document.getElementById('form-message');
    formMessage.textContent = '';
    formMessage.className = 'form-message';

    // Validation améliorée
    if (!form.checkValidity()) {
        form.reportValidity();
        formMessage.textContent = 'Veuillez remplir tous les champs obligatoires correctement.';
        formMessage.classList.add('error');
        
        // Highlight des champs invalides
        const invalidFields = form.querySelectorAll(':invalid');
        invalidFields.forEach(field => {
            field.classList.add('input-error');
            field.addEventListener('input', function() {
                if (this.checkValidity()) {
                    this.classList.remove('input-error');
                }
            });
        });
        
        return;
    }

    const depenseData = {
        date: document.getElementById('depenseDate').value,
        agence: document.getElementById('depenseAgence').value,
        designation: document.getElementById('depenseDesignation').value.trim(),
        categorie: document.getElementById('depenseCategorie').value,
        montant: parseFloat(document.getElementById('depenseMontant').value)
    };

    // Validation supplémentaire
if (isNaN(depenseData.montant)) {
    formMessage.textContent = 'Veuillez entrer un montant valide.';
    formMessage.classList.add('error');
    document.getElementById('depenseMontant').classList.add('input-error');
    return;
}

    const submitButton = document.querySelector('#depenseModal .btn-primary');
    submitButton.disabled = true;
    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enregistrement...';

    try {
        const apiUrl = "https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=addDepense";

            await fetch(apiUrl, {
              method: 'POST',
              mode: 'no-cors',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(depenseData)
            });

        // Succès
        formMessage.textContent = '✅ Dépense enregistrée avec succès!';
        formMessage.classList.add('success');
        
        // Réinitialiser le formulaire après succès
        form.reset();
        
        // Fermer après 1.5s
        setTimeout(() => {
            closeModal();
            // Rafraîchir les données si nécessaire
            if (typeof refreshExpenses === 'function') {
                refreshExpenses();
            }
        }, 1500);

    } catch (error) {
        console.error("Erreur:", error);
        formMessage.innerHTML = `❌ ${error.message || "Une erreur est survenue lors de l'enregistrement"}`;
        logError(`Dépense: ${errorMsg}`);
        formMessage.classList.add('error');
    } finally {
        submitButton.disabled = false;
        submitButton.textContent = 'Enregistrer';
    }
}

    // Close the modal when clicking outside
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal-overlay') && e.target.id !== 'loadingModal') {
            closeModal();
        }
        
    });


</script>

<script>
// URL pour soumettre les données
const SUBMIT_URL = "https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=addCommandeClient";

let currentStep = 1;
const totalSteps = 6;

// Fonction pour ouvrir la modal de nouvelle vente
function openNewSale() {
    // Vérifier si la modal existe déjà
    let modal = document.getElementById('newSaleModal');
    
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'newSaleModal';
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                            <h3 class="modal-title">Nouvelle Vente</h3>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="client-form" method="POST">
                                <input type="hidden" name="source" value="web_form">
                                
                                <!-- Indicateur d'étapes -->
                                <div class="step-indicator">
                                    <div class="step active" data-step="1">
                                        <div class="step-number">1</div>
                                        <div class="step-label">Informations Client</div>
                                    </div>
                                    <div class="step" data-step="2">
                                        <div class="step-number">2</div>
                                        <div class="step-label">Prescription</div>
                                    </div>
                                    <div class="step" data-step="3">
                                        <div class="step-number">3</div>
                                        <div class="step-label">Commande</div>
                                    </div>
                                    <div class="step" data-step="4">
                                        <div class="step-number">4</div>
                                        <div class="step-label">Assurance</div>
                                    </div>
                                    <div class="step" data-step="5">
                                        <div class="step-number">5</div>
                                        <div class="step-label">Paiement</div>
                                    </div>
                                    <div class="step" data-step="6">
                                        <div class="step-number">6</div>
                                        <div class="step-label">Livraison</div>
                                    </div>
                                    <div class="step-progress">
                                        <div class="step-progress-bar" id="stepProgressBar"></div>
                                    </div>
                                </div>

                                <!-- Étape 1: Informations Client -->
                                <div id="step-1" class="form-step active">
                                    <h2 class="section-title">Informations Client</h2>
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label for="nom_complet" class="required-field">Nom complet</label>
                                            <input type="text" name="nom_complet" id="nom_complet" class="form-control" required />
                                        </div>

                                        <div class="form-group">
                                            <label for="numero" class="required-field">Téléphone</label>
                                            <input type="tel" name="numero" id="numero" class="form-control" placeholder="229XXXXXXXX" required />
                                        </div>

                                        <div class="form-group">
                                            <label for="date_naissance" class="required-field">Date de naissance</label>
                                            <input type="date" name="date_naissance" id="date_naissance" class="form-control" required />
                                        </div>

                                        <div class="form-group">
                                            <label for="civilite" class="required-field">Civilité</label>
                                            <select name="civilite" id="civilite" class="form-control" required>
                                                <option value="M.">M.</option>
                                                <option value="Mme">Mme</option>
                                                <option value="Mlle">Mlle</option>
                                            </select>
                                        </div>

        <div class="form-group">
            <label for="entreprise">Entreprise</label>
            <div class="select-with-input">
                <select name="entreprise" id="entreprise" class="form-control">
                    <option value="">-- Choisir --</option>
                </select>
                <input type="text" id="entreprise_input" class="form-control" style="display: none; margin-top: 5px;" 
                       placeholder="Nouvelle entreprise">
            </div>
            <button type="button" class="btn btn-small" onclick="toggleInput('entreprise')" 
                    style="margin-top: 5px; padding: 0.25rem 0.5rem;">
                <i class="fas fa-plus"></i> Ajouter nouvelle
            </button>
        </div>

    

                                        <div class="form-group">
                                            <label for="agence" class="required-field">Agence</label>
                                            <select name="agence" id="agence" class="form-control" required>
                                                <option value="">-- Choisir --</option>
                                            </select>
                                        </div>



        <div class="form-group">
            <label for="commercial">Commercial</label>
            <div class="select-with-input">
                <select name="commercial" id="commercial" class="form-control">
                    <option value="">-- Choisir --</option>
                </select>
                <input type="text" id="commercial_input" class="form-control" style="display: none; margin-top: 5px;" 
                       placeholder="New commercial">
            </div>
            
            <button type="button" class="btn btn-small" onclick="toggleInput('commercial')" 
                    style="margin-top: 5px; padding: 0.25rem 0.5rem;">
                <i class="fas fa-plus"></i> Ajouter nouvelle
            </button>
        </div>
                                        <div class="form-group">
                                            <label for="current_user" class="required-field">Utilisateur</label>
                                            <input type="text" name="current_user" id="current_user" class="form-control" readonly 
                   style="background-color: #f0f0f0; cursor: not-allowed;">
                                        </div>
                                    </div>
                                </div>

                                <!-- Étape 2: Prescription -->
                                <div id="step-2" class="form-step">
                                    <h2 class="section-title">Prescription Médicale</h2>
                                    
                                    <table class="prescription-table">
                                        <thead>
                                            <tr>
                                                <th>Œil</th>
                                                <th>Sphere</th>
                                                <th>Cylindre</th>
                                                <th>Axe</th>
                                                <th>ADD</th>
                                                <th>DP</th>
                                                <th>Hauteur</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- OD -->
                                            <tr>
                                                <td>OD</td>
                                                <td>
                                                    <select name="od_sphere" required>
                                                        <option value="">-- Choisir --</option>
                                                    </select>
                                                </td>
                                                <td>
                                                    <select name="od_cylindre">
                                                        <option value="">-- Choisir --</option>
                                                    </select>
                                                </td>
                                                <td>
                                                    <select name="od_axe">
                                                        <option value="">-- Choisir --</option>
                                                    </select>
                                                </td>
                                                <td>
                                                    <select name="od_add">
                                                        <option value="">-- Choisir --</option>
                                                    </select>
                                                </td>
                                                <td>
                                                    <input type="number" name="od_dp" value="0" min="0">
                                                </td>
                                                <td>
                                                    <input type="number" name="od_hauteur" value="0" min="0">
                                                </td>
                                            </tr>

                                            <!-- OG -->
                                            <tr>
                                                <td>OG</td>
                                                <td>
                                                    <select name="og_sphere" required>
                                                        <option value="">-- Choisir --</option>
                                                    </select>
                                                </td>
                                                <td>
                                                    <select name="og_cylindre">
                                                        <option value="">-- Choisir --</option>
                                                    </select>
                                                </td>
                                                <td>
                                                    <select name="og_axe">
                                                        <option value="">-- Choisir --</option>
                                                    </select>
                                                </td>
                                                <td>
                                                    <select name="og_add">
                                                        <option value="">-- Choisir --</option>
                                                    </select>
                                                </td>
                                                <td>
                                                    <input type="number" name="og_dp" value="0" min="0">
                                                </td>
                                                <td>
                                                    <input type="number" name="og_hauteur" value="0" min="0">
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>

<div class="form-grid">
    <div class="form-group">
        <label for="clinique">Clinique</label>
        <div class="select-with-input">
            <select name="clinique" id="clinique" class="form-control">
                <option value="">-- Choisir --</option>
                <!-- Options existantes seront ajoutées dynamiquement -->
            </select>
            <input type="text" id="clinique_input" class="form-control" style="display: none; margin-top: 5px;" 
                   placeholder="Nouvelle clinique">
        </div>
        <button type="button" class="btn btn-small" onclick="toggleInput('clinique')" 
                style="margin-top: 5px; padding: 0.25rem 0.5rem;">
            <i class="fas fa-plus"></i> Ajouter nouvelle
        </button>
    </div>
    
    <div class="form-group">
        <label for="ophtalmo">Ophtalmologue</label>
        <div class="select-with-input">
            <select name="ophtalmo" id="ophtalmo" class="form-control">
                <option value="">-- Choisir --</option>
                <!-- Options existantes seront ajoutées dynamiquement -->
            </select>
            <input type="text" id="ophtalmo_input" class="form-control" style="display: none; margin-top: 5px;" 
                   placeholder="Nouvel ophtalmologue">
        </div>
        <button type="button" class="btn btn-small" onclick="toggleInput('ophtalmo')"
                style="margin-top: 5px; padding: 0.25rem 0.5rem;">
            <i class="fas fa-plus"></i> Ajouter nouveau
        </button>
    </div>
    
    <div class="form-group">
        <label for="date_soin">Date de soin</label>
        <input type="date" name="date_soin" id="date_soin" class="form-control" />
    </div>
</div>
                                </div>

                                <!-- Étape 3: Commande -->
                                <div id="step-3" class="form-step">
                                    <h2 class="section-title">Détails de la Commande</h2>
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label for="type_verre" class="required-field">Type de Verre</label>
                                            <select name="type_verre" id="type_verre" class="form-control" required>
                                                <option value="">-- Type de Verre --</option>
                                            </select>
                                        </div>

                                        <div class="form-group">
                                            <label for="gamme_verre" class="required-field">Gamme des Verres</label>
                                            <select name="gamme_verre" id="gamme_verre" class="form-control" required>
                                                <option value="">-- Gamme --</option>
                                            </select>
                                        </div>

                                        <div class="form-group">
                                            <label for="choix_monture" class="required-field">Choix de Monture</label>
                                            <select name="choix_monture" id="choix_monture" class="form-control" required>
                                                <option value="">-- Choix de Monture --</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

<!-- Étape 4: Assurance -->
<div id="step-4" class="form-step">
    <h2 class="section-title">Tier Payant</h2>
    <div class="form-grid">
        <div class="form-group">
            <label for="assurance">Assurance</label>
            <div class="select-with-input">
                <select name="assurance" id="assurance" class="form-control" style="display: none;">
                    <option value="">-- Choisir --</option>
                </select>
                <input type="text" id="assurance_input" class="form-control" 
                       placeholder="Nom de l'assurance">
            </div>
            <button type="button" class="btn btn-small" onclick="toggleInput('assurance')" 
                    style="margin-top: 5px; padding: 0.25rem 0.5rem;">
                <i class="fas fa-exchange-alt"></i> Choisir dans la liste
            </button>
        </div>
        
        <div class="form-group">
            <label for="compagnie">Compagnie</label>
            <div class="select-with-input">
                <select name="compagnie" id="compagnie" class="form-control" style="display: none;">
                    <option value="">-- Choisir --</option>
                </select>
                <input type="text" id="compagnie_input" class="form-control" 
                       placeholder="Nom de la compagnie">
            </div>
            <button type="button" class="btn btn-small" onclick="toggleInput('compagnie')"
                    style="margin-top: 5px; padding: 0.25rem 0.5rem;">
                <i class="fas fa-exchange-alt"></i> Choisir dans la liste
            </button>
        </div>
        
        <div class="form-group">
            <label for="numero_police">N° Police</label>
            <input type="text" name="numero_police" id="numero_police" class="form-control" placeholder="Numéro de police d'assurance" />
        </div>
        
        <div class="form-group">
            <label for="taux_couverture">Taux de couverture (%)</label>
            <input type="number" name="taux_couverture" id="taux_couverture" class="form-control" placeholder="Ex: 80" min="0" max="100" />
        </div>
        
        <div class="form-group">
            <label for="assure_principal">Assuré Principal</label>
            <select name="assure_principal" id="assure_principal" class="form-control">
                <option value="">-- Choisir --</option>
                <option value="oui">Oui</option>
                <option value="non">Non</option>
            </select>
        </div>

        <div class="form-group" id="assure_principal_nom_container" style="display: none;">
            <label class="required-field">Nom complet de l'assuré principal</label>
            <input type="text" name="assure_principal_nom" id="assure_principal_nom" class="form-control" />
        </div>
    </div>
</div>

                                <!-- Étape 5: Paiement -->
                                <div id="step-5" class="form-step">
                                    <h2 class="section-title">Détails de Paiement</h2>
                                    
                                    <div class="payment-card">
                                        <div class="payment-row">
                                            <div class="payment-group">
                                                <label class="payment-label required-field">Montant Monture (FCFA)</label>
                                                <input type="number" class="form-control" name="montant_monture" id="montant_monture" required oninput="calculerTotal()" />
                                            </div>
                                            
                                            <div class="payment-group">
                                                <label class="payment-label required-field">Montant Verres (FCFA)</label>
                                                <input type="number" class="form-control" name="montant_verres" id="montant_verres" required oninput="calculerTotal()" />
                                            </div>
                                            
                                            <div class="payment-group">
                                                <label class="payment-label">Frais de livraison (FCFA)</label>
                                                <input type="number" class="form-control" name="frais_livraison" id="frais_livraison" value="0" oninput="calculerTotal()" />
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="payment-card">
                                        <div class="payment-row">
                                            <div class="payment-group">
                                                <label class="payment-label">Total Brut (FCFA)</label>
                                                <div class="payment-value" id="total_brut_display">0</div>
                                                <input type="hidden" name="total_brut" id="total_brut" />
                                            </div>
                                            
                                            <div class="payment-group">
                                                <label class="payment-label">Remise</label>
                                                <div class="discount-selector">
                                                    <input type="number" class="form-control discount-amount" name="remise" id="remise" value="0" oninput="calculerTotal()" />
                                                    <select class="form-control discount-type" name="remise_type" id="remise_type" onchange="calculerTotal()">
                                                        <option value="FCFA">FCFA</option>
                                                        <option value="%">%</option>
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            <div class="payment-group">
                                                <label class="payment-label">Part Assurance (FCFA)</label>
                                                <input type="number" class="form-control" name="part_assurance" id="part_assurance" value="0" oninput="calculerTotal()" />
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="payment-card">
                                        <div class="payment-row">
                                            <div class="payment-group">
                                                <label class="payment-label">Net à payer (FCFA)</label>
                                                <div class="payment-value" id="net_a_payer_display">0</div>
                                                <input type="hidden" name="net_a_payer" id="net_a_payer" />
                                            </div>
                                            
                                            <div class="payment-group">
                                                <label class="payment-label">Acompte (FCFA)</label>
                                                <input type="number" class="form-control" name="acompte" id="acompte" value="0" oninput="calculerTotal()" />
                                            </div>
                                            
                                            <div class="payment-group">
                                                <label class="payment-label">Reste à payer (FCFA)</label>
                                                <div class="payment-value" id="reste_a_payer_display">0</div>
                                                <input type="hidden" name="reste_a_payer" id="reste_a_payer" />
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Étape 6: Livraison -->
                                <div id="step-6" class="form-step">
                                    <h2 class="section-title">Informations de Livraison</h2>
                                    
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label class="required-field">Date de livraison prévue</label>
                                            <input type="date" class="form-control" name="date_livraison" id="date_livraison" required />
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="required-field">Personne à contacter</label>
                                            <select class="form-control" name="contact_livraison_type" id="contact_livraison_type" required>
                                                <option value="">-- Choisir --</option>
                                                <option value="client">Lui-même</option>
                                                <option value="tiers">Tier Personne</option>
                                            </select>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="required-field">Téléphone du contact</label>
                                            <input type="tel" class="form-control" name="telephone_contact" id="telephone_contact" required />
                                        </div>
                                        
                                        <div class="form-group" style="grid-column: span 2">
                                            <label class="required-field">Adresse de livraison</label>
                                            <textarea class="form-control" name="adresse_livraison" id="adresse_livraison" rows="3" required></textarea>
                                        </div>
                                        
                                        <div class="form-group" style="grid-column: span 2">
                                            <label>Informations complémentaires</label>
                                            <textarea class="form-control" name="infos_complementaires" id="infos_complementaires" rows="3"></textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- Navigation entre les étapes -->
<div class="step-navigation">
    <div class="nav-group">
        <button type="button" class="btn btn-secondary" id="prevStepBtn" style="display: none;">
            <i class="fas fa-arrow-left"></i> Précédent
        </button>
    </div>
    
    <div class="nav-group">
        <button type="button" class="btn btn-outline" id="resetButton">
            <i class="fas fa-undo"></i> Réinitialiser
        </button>
        <button type="button" class="btn btn-outline" id="cancelButton">
            <i class="fas fa-times"></i> Annuler
        </button>
    </div>
    
    <div class="nav-group">
        <button type="button" class="btn btn-primary" id="nextStepBtn">
            Suivant <i class="fas fa-arrow-right"></i>
        </button>
        <button type="submit" class="btn btn-success" id="submitBtn" style="display: none;">
            <i class="fas fa-check"></i> Ajouter
        </button>
    </div>
</div>

<style>
.step-navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid #eee;
    flex-wrap: wrap;
}

.nav-group {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.btn-outline {
    background: white;
    border: 1px solid #ddd;
    color: #555;
}

.btn-outline:hover {
    background: #f5f5f5;
}

.btn-success {
    background-color: #4ade80;
}

.btn-success:hover {
    background-color: #3bc46d;
}

@media (max-width: 768px) {
    .step-navigation {
        flex-direction: column-reverse;
    }
    
    .nav-group {
        width: 100%;
        justify-content: space-between;
    }
}
</style>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    // Afficher la modal
    modal.classList.add('active');
    
    // Initialiser la modal
        initModal();
};

 
    // Initialisation de la modal
function initModal() {
    // Configurer les événements
    setupEventListeners();
    
    // Calcul initial
    calculerTotal();
    
    // Charger les données depuis Google Sheets
    loadDataFromSheet();
    
    // Mettre à jour l'affichage des étapes
    updateStepDisplay();
    setupCurrentUserField();
}

// Mettre à jour l'affichage des étapes
function updateStepDisplay() {
    const modal = document.getElementById('newSaleModal');
    if (!modal) return;
    
    // Masquer toutes les étapes
    modal.querySelectorAll('.form-step').forEach(step => {
        step.classList.remove('active');
    });
    
    // Afficher l'étape actuelle
    const currentStepElement = modal.querySelector(`#step-${currentStep}`);
    if (currentStepElement) {
        currentStepElement.classList.add('active');
    }
    
    // Mettre à jour l'indicateur d'étapes
    modal.querySelectorAll('.step').forEach(step => {
        step.classList.remove('active', 'completed');
        const stepNumber = parseInt(step.getAttribute('data-step'));
        
        if (stepNumber === currentStep) {
            step.classList.add('active');
        } else if (stepNumber < currentStep) {
            step.classList.add('completed');
        }
    });
    
    // Mettre à jour la barre de progression
    const progressPercentage = ((currentStep - 1) / (totalSteps - 1)) * 100;
    const progressBar = modal.querySelector('#stepProgressBar');
    if (progressBar) {
        progressBar.style.width = `${progressPercentage}%`;
    }
    
    // Gérer les boutons de navigation
    const prevBtn = modal.querySelector('#prevStepBtn');
    const nextBtn = modal.querySelector('#nextStepBtn');
    const submitBtn = modal.querySelector('#submitBtn');
    
    if (prevBtn) {
        prevBtn.style.display = currentStep > 1 ? 'block' : 'none';
    }
    
    if (nextBtn && submitBtn) {
        if (currentStep < totalSteps) {
            nextBtn.style.display = 'block';
            submitBtn.style.display = 'none';
        } else {
            nextBtn.style.display = 'none';
            submitBtn.style.display = 'block';
        }
    }
}

// Aller à l'étape suivante
function nextStep() {
    if (!validateStep(currentStep)) return;
    
    if (currentStep < totalSteps) {
        currentStep++;
        updateStepDisplay();
        const modal = document.getElementById('newSaleModal');
        if (modal) {
            modal.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }
}

// Revenir à l'étape précédente
function prevStep() {
    if (currentStep > 1) {
        currentStep--;
        updateStepDisplay();
        const modal = document.getElementById('newSaleModal');
        if (modal) {
            modal.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }
}

// Valider l'étape actuelle
function validateStep(step) {
    const modal = document.getElementById('newSaleModal');
    if (!modal) return false;
    
    let isValid = true;
    const highlightError = (element) => {
        if (element) {
            element.style.borderColor = 'var(--danger-color)';
            setTimeout(() => {
                element.style.borderColor = '';
            }, 2000);
        }
    };
    
    // Validation pour l'étape 1 (Informations Client)
    if (step === 1) {
        const requiredFields = [
            'nom_complet', 'numero', 'date_naissance', 
            'civilite', 'agence', 'commercial'
        ];
        
        for (const fieldId of requiredFields) {
            const field = modal.querySelector(`#${fieldId}`);
            if (field && !field.value) {
                highlightError(field);
                isValid = false;
            }
        }
        
        if (!isValid) {
            showError('Veuillez remplir tous les champs obligatoires');
        }
    }
    
    // Validation pour l'étape 2 (Prescription)
    if (step === 2) {
        const requiredFields = ['od_sphere', 'og_sphere'];
        
        for (const fieldName of requiredFields) {
            const field = modal.querySelector(`[name="${fieldName}"]`);
            if (field && !field.value) {
                highlightError(field);
                isValid = false;
            }
        }
        
        if (!isValid) {
            showError('Veuillez remplir les champs obligatoires de la prescription');
        }
    }
    
    // Validation pour l'étape 3 (Commande)
    if (step === 3) {
        const requiredFields = ['type_verre', 'gamme_verre', 'choix_monture'];
        
        for (const fieldId of requiredFields) {
            const field = modal.querySelector(`#${fieldId}`);
            if (field && !field.value) {
                highlightError(field);
                isValid = false;
            }
        }
        
        if (!isValid) {
            showError('Veuillez sélectionner le type de verre, la gamme et la monture');
        }
    }
    
    // Validation pour l'étape 6 (Livraison)
    if (step === 6) {
        const requiredFields = [
            'date_livraison', 'contact_livraison_type', 
            'telephone_contact', 'adresse_livraison'
        ];
        
        for (const fieldId of requiredFields) {
            const field = modal.querySelector(`#${fieldId}`);
            if (field && !field.value) {
                highlightError(field);
                isValid = false;
            }
        }
        
        if (!isValid) {
            showError('Veuillez remplir tous les champs obligatoires pour la livraison');
        }
    }
    
    return isValid;
}

// Configuration des événements
function setupEventListeners() {
    const modal = document.getElementById('newSaleModal');
    if (!modal) return;
    
    // Boutons de navigation
    const nextBtn = modal.querySelector('#nextStepBtn');
    const prevBtn = modal.querySelector('#prevStepBtn');
    
    if (nextBtn) nextBtn.addEventListener('click', nextStep);
    if (prevBtn) prevBtn.addEventListener('click', prevStep);
    
    // Boutons d'action
    const resetBtn = modal.querySelector('#resetButton');
    const cancelBtn = modal.querySelector('#cancelButton');
    const form = modal.querySelector('#client-form');
    
    if (resetBtn) {
        resetBtn.addEventListener('click', () => {
            if (confirm('Voulez-vous vraiment réinitialiser le formulaire ?')) {
                form.reset();
                const nomComplet = modal.querySelector('#nom_complet');
                if (nomComplet) nomComplet.focus();
                calculerTotal();
                showSuccess('Formulaire réinitialisé avec succès !');
            }
        });
    }
    
    if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
            if (confirm('Voulez-vous vraiment annuler et fermer le formulaire ?')) {
                closeModal();
            }
        });
    }
    
    // Calcul automatique pour tous les champs pertinents
    const calcFields = [
        'montant_monture', 'montant_verres', 'frais_livraison',
        'remise', 'part_assurance', 'acompte'
    ];
    calcFields.forEach(id => {
        const field = modal.querySelector(`#${id}`);
        if (field) field.addEventListener('input', calculerTotal);
    });
    
    // Écouteur pour le type de remise (FCFA ou %)
    const remiseType = modal.querySelector('#remise_type');
    if (remiseType) remiseType.addEventListener('change', calculerTotal);
    
    // Synchronisation automatique de l'ADD OD vers OG
    const odAdd = modal.querySelector('[name="od_add"]');
    if (odAdd) {
        odAdd.addEventListener('change', function() {
            const odAddValue = this.value;
            const ogAddSelect = modal.querySelector('[name="og_add"]');
            if (odAddValue && ogAddSelect) {
                ogAddSelect.value = odAddValue;
            }
        });
    }
    
    // Gestion de l'affichage conditionnel pour l'assuré principal
    const assurePrincipal = modal.querySelector('#assure_principal');
    if (assurePrincipal) {
        assurePrincipal.addEventListener('change', function() {
            const container = modal.querySelector('#assure_principal_nom_container');
            const input = modal.querySelector('#assure_principal_nom');
            const nomComplet = modal.querySelector('#nom_complet');
            
            if (!container || !input) return;
            
            if (this.value === 'oui') {
                container.style.display = 'block';
                input.value = nomComplet?.value || '';
                input.readOnly = true;
                input.style.backgroundColor = '#f0f0f0';
            } else if (this.value === 'non') {
                container.style.display = 'block';
                input.readOnly = false;
                input.style.backgroundColor = '';
                input.value = '';
            } else {
                container.style.display = 'none';
            }
        });
    }
    
    // Gestion du type de contact pour la livraison
    const contactLivraisonType = modal.querySelector('#contact_livraison_type');
    if (contactLivraisonType) {
        contactLivraisonType.addEventListener('change', function() {
            const telephoneContact = modal.querySelector('#telephone_contact');
            const adresseLivraison = modal.querySelector('#adresse_livraison');
            const clientTel = modal.querySelector('#numero')?.value || '';
            const agence = modal.querySelector('#agence')?.value || '';
            
            if (!telephoneContact || !adresseLivraison) return;
            
            if (this.value === 'client') {
                telephoneContact.value = clientTel;
                telephoneContact.readOnly = true;
                telephoneContact.style.backgroundColor = '#f0f0f0';
                
                if (agence) {
                    const adressesAgences = {
                        'cotonou': '123 Rue des Agences, Cotonou, Bénin',
                    };
                    
                    adresseLivraison.value = adressesAgences[agence] || agence;
                    adresseLivraison.readOnly = true;
                    adresseLivraison.style.backgroundColor = '#f0f0f0';
                    const fraisLivraison = modal.querySelector('#frais_livraison');
                    if (fraisLivraison) fraisLivraison.value = 0;
                    calculerTotal();
                }
            } else if (this.value === 'tiers') {
                telephoneContact.readOnly = false;
                telephoneContact.style.backgroundColor = '';
                if (telephoneContact.value === clientTel) {
                    telephoneContact.value = '';
                }
                
                adresseLivraison.readOnly = false;
                adresseLivraison.style.backgroundColor = '';
                adresseLivraison.value = '';
            }
        });
    }

    // Soumission du formulaire
    if (form) {
        showSubmitButton();
        console.log('Formulaire trouvé, ajout de l\'écouteur d\'événement submit');
        form.addEventListener('submit', async function(event) {
            event.preventDefault();

            // Validation rapide du formulaire
            if (!modal.querySelector('#nom_complet')?.value) {
                showError('Veuillez renseigner le nom complet du client');
                return;
            }
                // Afficher la boîte de confirmation
                const confirmation = await showConfirmation(
                    'Confirmer la vente',
                    'Êtes-vous sûr de vouloir enregistrer cette vente ?',
                    'Oui, enregistrer',
                    'Annuler'
                );
            
                if (!confirmation) {
                    return; // L'utilisateur a annulé
                }
            showStatusMessage('Enregistrement en cours', 'Veuillez patienter...');
            
            const cliniqueInput = modal.querySelector('#clinique_input')?.value;
            const ophtalmoInput = modal.querySelector('#ophtalmo_input')?.value;
            const assuranceInput = modal.querySelector('#assurance_input')?.value;
            const compagnieInput = modal.querySelector('#compagnie_input')?.value;

            const entrepriseInput = modal.querySelector('#entreprise_input')?.value;
            const commercialInput = modal.querySelector('#commercial_input')?.value;
            const formData = new FormData(form);
            if (!formData.get('clinique') && cliniqueInput) {
                formData.append('clinique_input', cliniqueInput);
            }
            if (!formData.get('ophtalmo') && ophtalmoInput) {
                formData.append('ophtalmo_input', ophtalmoInput);
            }
            if (!formData.get('assurance') && assuranceInput) {
                formData.append('assurance_input', assuranceInput);
            }
            if (!formData.get('compagnie') && compagnieInput) {
                formData.append('compagnie_input', compagnieInput);
            }
            if (!formData.get('entreprise') && entrepriseInput) {
                formData.append('entreprise_input', entrepriseInput);
            }if (!formData.get('commercial') && commercialInput) {
                formData.append('commercial_input', commercialInput);
            }
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }

            try {
                
                const response = await fetch(SUBMIT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });

                // Mais nous supposons que si la requête est partie, c'est bon
                showStatusMessage('Succès !', 'La vente a été enregistrée avec succès. Fermeture en cours...');
                console.log('fin');
                
                // Fermer la modal après un délai
                setTimeout(() => {
                   hideStatusMessage();
                    closeModal();
                    showSuccess('Vente enregistrée avec succès !');
                }, 2000);

            } catch (error) {
                console.error('Erreur lors de l\'envoi des données :', error);
                showError('Erreur lors de l\'envoi des données. Veuillez réessayer.');
            }
        });
    }
}

    function showConfirmation(title, message, confirmText = 'Confirmer', cancelText = 'Annuler') {
    return new Promise((resolve) => {
        // Créer l'overlay
        const overlay = document.createElement('div');
        overlay.className = 'confirmation-overlay';
        
        // Créer la boîte de confirmation
        const box = document.createElement('div');
        box.className = 'confirmation-box';
        box.innerHTML = `
            <h3>${title}</h3>
            <p>${message}</p>
            <div class="confirmation-buttons">
                <button class="btn btn-confirm">${confirmText}</button>
                <button class="btn btn-cancel">${cancelText}</button>
            </div>
        `;
        
        overlay.appendChild(box);
        document.body.appendChild(overlay);

        // Gérer les clics
        const confirmBtn = box.querySelector('.btn-confirm');
        const cancelBtn = box.querySelector('.btn-cancel');

        const cleanUp = () => {
            document.body.removeChild(overlay);
        };

        confirmBtn.addEventListener('click', () => {
            cleanUp();
            resolve(true);
        });

        cancelBtn.addEventListener('click', () => {
            cleanUp();
            resolve(false);
        });
    });
}
// Calculs financiers
function calculerTotal() {
    const modal = document.getElementById('newSaleModal');
    if (!modal) return;
    
    const getValue = id => {
        const element = modal.querySelector(`#${id}`);
        if (!element) return 0;
        const value = parseFloat(element.value);
        return isNaN(value) ? 0 : value;
    };

    const montantMonture = getValue('montant_monture');
    const montantVerres = getValue('montant_verres');
    const fraisLivraison = getValue('frais_livraison');
    const remise = getValue('remise');
    const remiseType = modal.querySelector('#remise_type')?.value || 'FCFA';
    const partAssurance = getValue('part_assurance');
    const acompte = getValue('acompte');
    
    // Calculs
    const totalBrut = montantMonture + montantVerres + fraisLivraison;
    let montantRemise = 0;
    if (remiseType === '%') {
        montantRemise = totalBrut * (remise / 100);
    } else {
        montantRemise = remise;
    }

    const netAPayer = Math.max(0, totalBrut - montantRemise - partAssurance);
    const resteAPayer = Math.max(0, netAPayer - acompte);
    
    // Affichage
    const totalBrutInput = modal.querySelector('#total_brut');
    const totalBrutDisplay = modal.querySelector('#total_brut_display');
    if (totalBrutInput && totalBrutDisplay) {
        totalBrutInput.value = Math.round(totalBrut);
        totalBrutDisplay.textContent = Math.round(totalBrut).toLocaleString();
    }
    
    const netAPayerInput = modal.querySelector('#net_a_payer');
    const netAPayerDisplay = modal.querySelector('#net_a_payer_display');
    if (netAPayerInput && netAPayerDisplay) {
        netAPayerInput.value = Math.round(netAPayer);
        netAPayerDisplay.textContent = Math.round(netAPayer).toLocaleString();
    }
    
    const resteAPayerInput = modal.querySelector('#reste_a_payer');
    const resteAPayerDisplay = modal.querySelector('#reste_a_payer_display');
    if (resteAPayerInput && resteAPayerDisplay) {
        resteAPayerInput.value = Math.round(resteAPayer);
        resteAPayerDisplay.textContent = Math.round(resteAPayer).toLocaleString();
    }
}

// Fonction pour remplir une liste déroulante
function populateSelect(id, options) {
    const modal = document.getElementById('newSaleModal');
    if (!modal) return;
    
    const select = modal.querySelector(`#${id}`);
    if (!select) return;
    
    // Sauvegarder la valeur sélectionnée actuelle
    const currentValue = select.value;
    
    // Vider le select sauf la première option
    while (select.options.length > 1) {
        select.remove(1);
    }
    
    // Ajouter les nouvelles options
    options.forEach(option => {
        const opt = document.createElement('option');
        opt.value = option;
        opt.textContent = option;
        select.appendChild(opt);
    });
    
    // Restaurer la valeur sélectionnée si elle existe toujours
    if (currentValue && options.includes(currentValue)) {
        select.value = currentValue;
    }
}

// Fonction pour remplir les options de prescription
function populatePrescriptionOptions(selectName, values) {
    const modal = document.getElementById('newSaleModal');
    if (!modal) return;
    
    const selects = modal.querySelectorAll(`[name="${selectName}"]`);
    if (!selects || selects.length === 0) return;
    
    const select = selects[0];
    const currentValue = select.value;
    
    // Vider le select sauf la première option
    while (select.options.length > 1) {
        select.remove(1);
    }
    
    // Ajouter les nouvelles options
    values.forEach(value => {
        const opt = document.createElement('option');
        opt.value = value;
        opt.textContent = value;
        select.appendChild(opt);
    });
    
    // Restaurer la valeur sélectionnée si elle existe toujours
    if (currentValue && values.includes(currentValue)) {
        select.value = currentValue;
    }
}

// Fonction principale de chargement des données
async function loadDataFromSheet() {
    showStatusMessage('Chargement des données...');
    
    try {
        const response = await fetch(DATA_SOURCE_URL);
        if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
        
        const data = await response.json();
        
        if (!data.success) throw new Error("Réponse invalide du serveur.");
        if (!data.data) throw new Error("Données manquantes dans la réponse");

        appDataCache = data.data;
        populateFormWithData(data.data);
        
    } catch (error) {
        console.error('Erreur lors du chargement:', error);
        showError(`Erreur lors du chargement: ${error.message}`);
    } finally {
        hideStatusMessage();
    }
}

// Fonction pour remplir le formulaire avec les données
function populateFormWithData(data) {
    if (!data) return;
    
    // Liste des champs à remplir avec leurs données correspondantes
    const fieldsToPopulate = [
        { id: 'entreprise', data: data.entreprises },
        { id: 'agence', data: data.agences },
        { id: 'commercial', data: data.commerciaux },
        { id: 'type_verre', data: data.typesVerre },
        { id: 'gamme_verre', data: data.gammesVerre },
        { id: 'choix_monture', data: data.montures },
        { id: 'clinique', data: data.cliniques },
        { id: 'ophtalmo', data: data.ophtalmos },
        { id: 'assurance', data: data.assurances },
        { id: 'compagnie', data: data.compagnies }
    ];

    fieldsToPopulate.forEach(field => {
        if (Array.isArray(field.data)) {
            populateSelect(field.id, field.data);
        }
    });

    // Gestion des champs de prescription
    const prescriptionFields = [
        { name: 'od_sphere', data: data.sphere },
        { name: 'od_cylindre', data: data.sphere },
        { name: 'od_axe', data: data.axe },
        { name: 'od_add', data: data.add },
        { name: 'og_sphere', data: data.sphere },
        { name: 'og_cylindre', data: data.sphere },
        { name: 'og_axe', data: data.axe },
        { name: 'og_add', data: data.add }
    ];

    prescriptionFields.forEach(field => {
        if (Array.isArray(field.data)) {
            populatePrescriptionOptions(field.name, field.data);
        }
    });
}

// Fonction pour basculer entre select et input
function toggleInput(fieldName) {
    const select = document.getElementById(fieldName);
    const input = document.getElementById(`${fieldName}_input`);
    const button = event.currentTarget;
    
    if (input.style.display === 'none') {
        // Passer en mode saisie libre
        select.style.display = 'none';
        input.style.display = 'block';
        input.value = '';
        button.innerHTML = '<i class="fas fa-list"></i> Choisir existant';
        
        // Si une valeur était sélectionnée, la mettre dans l'input
        if (select.value && !select.options[select.selectedIndex].disabled) {
            input.value = select.options[select.selectedIndex].text;
        }
    } else {
        // Revenir en mode sélection
        select.style.display = 'block';
        input.style.display = 'none';
        button.innerHTML = '<i class="fas fa-plus"></i> Ajouter nouveau';
        
        // Si l'input contient une valeur, l'ajouter aux options
        if (input.value.trim()) {
            addOptionIfNotExists(select, input.value.trim());
        }
    }
}

// Ajouter une option si elle n'existe pas déjà
function addOptionIfNotExists(selectElement, value) {
    // Vérifier si la valeur existe déjà
    for (let i = 0; i < selectElement.options.length; i++) {
        if (selectElement.options[i].text === value) {
            selectElement.value = value;
            return;
        }
    }
    
    // Ajouter la nouvelle option
    const option = document.createElement('option');
    option.value = value;
    option.text = value;
    selectElement.add(option);
    selectElement.value = value;
}

// Fonctions utilitaires
function showStatusMessage(title = 'Chargement', message = 'Veuillez patienter...', isSuccess = false) {
    let statusBox = document.getElementById('statusMessageBox');
    
    if (!statusBox) {
        statusBox = document.createElement('div');
        statusBox.id = 'statusMessageBox';
        statusBox.className = 'status-overlay';
        statusBox.innerHTML = `
            <div class="status-content ${isSuccess ? 'success' : ''}">
                ${!isSuccess ? '<div class="status-spinner"></div>' : ''}
                ${isSuccess ? '<i class="fas fa-check-circle status-icon"></i>' : ''}
                <h3>${title}</h3>
                <p>${message}</p>
            </div>
        `;
        document.body.appendChild(statusBox);
    } else {
        // Mise à jour dynamique
        const content = statusBox.querySelector('.status-content');
        const spinner = statusBox.querySelector('.status-spinner');
        const icon = statusBox.querySelector('.status-icon');
        
        content.className = `status-content ${isSuccess ? 'success' : ''}`;
        
        if (isSuccess) {
            if (spinner) spinner.remove();
            if (!icon) {
                content.insertAdjacentHTML('afterbegin', '<i class="fas fa-check-circle status-icon"></i>');
            }
        } else {
            if (icon) icon.remove();
            if (!spinner) {
                content.insertAdjacentHTML('afterbegin', '<div class="status-spinner"></div>');
            }
        }
        
        statusBox.querySelector('h3').textContent = title;
        statusBox.querySelector('p').textContent = message;
    }
}

function hideStatusMessage() {
    const statusBox = document.getElementById('statusMessageBox');
    if (statusBox) {
        statusBox.remove();
    }
}

function showSuccess(message) {
hideStatusMessage();
    
    const successDiv = document.createElement('div');
    successDiv.className = 'success-message';
    successDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
    document.body.appendChild(successDiv);
    successDiv.style.display = 'block';
    
    setTimeout(() => {
        successDiv.style.display = 'none';
        setTimeout(() => {
            document.body.removeChild(successDiv);
        }, 500);
    }, 3000);
}

function showError(message) {
   hideStatusMessage();
    
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
    document.body.appendChild(errorDiv);
    errorDiv.style.display = 'block';
    
    setTimeout(() => {
        errorDiv.style.display = 'none';
        setTimeout(() => {
            document.body.removeChild(errorDiv);
        }, 500);
    }, 5000);
}

// Initialiser la modal lorsque le DOM est chargé
document.addEventListener('DOMContentLoaded', function() {
    // Si la modal existe déjà dans le DOM, l'initialiser
    if (document.getElementById('newSaleModal')) {
        initModal();
    }
});


// Pour afficher le bouton avec l'animation
function showSubmitButton() {
  const submitBtn = document.getElementById('submitBtn');
  submitBtn.style.display = 'inline-block';
  submitBtn.classList.add('highlight');
  
  // Retirer la classe après l'animation pour pouvoir la réutiliser
  setTimeout(() => {
    submitBtn.classList.remove('highlight');
  }, 3000);
}


</script>
    
<script>
    document.addEventListener('DOMContentLoaded', function() {
    // 1. Gestion de l'utilisateur et authentification
    handleUserSession();

    // 2. Initialisation des données et interface
    initializeDataAndUI();

    // 3. Gestion de la navigation par étapes (formulaire proforma)
    setupFormStepNavigation();
});

// ==================== Fonctions séparées pour plus de clarté ====================

// 1. Gestion de la session utilisateur
function handleUserSession() {
    const username = sessionStorage.getItem("utilisateur") || localStorage.getItem("utilisateur");

    if (!username) {
        window.location.href = "code.html";
        return;
    }

    // Afficher le nom d'utilisateur
    const usernameDisplay = document.getElementById("username-display");
    if (usernameDisplay) {
        usernameDisplay.textContent = username;
    }

    // Mettre à jour l'image de profil
    const profileImg = document.querySelector('.profile-img');
    if (profileImg) {
        profileImg.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=4361ee&color=fff`;
    }

    // Gestion de la déconnexion
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', function(e) {
            e.preventDefault();
            sessionStorage.removeItem("utilisateur");
            localStorage.removeItem("utilisateur");
            window.location.href = 'code.html';
        });
    }
}

// 2. Initialisation des données et interface
function initializeDataAndUI() {
    // Chargement des clients
    loadClientsFromScript();

    // Configuration de la recherche
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', applySearchFilter);
    }

    // Configuration de la pagination
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    
    if (prevPageBtn) prevPageBtn.addEventListener('click', goToPrevPage);
    if (nextPageBtn) nextPageBtn.addEventListener('click', goToNextPage);
}

// 3. Navigation par étapes du formulaire
function setupFormStepNavigation() {
    // Bouton Suivant - sans validation
    document.querySelectorAll('.next-step').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const currentSection = this.closest('.form-section');
            const nextStep = this.dataset.next;
            
            currentSection.classList.remove('active');
            document.getElementById(`section${nextStep}`).classList.add('active');
            updateStepper(nextStep);
        });
    });
    
    // Bouton Précédent (inchangé)
    document.querySelectorAll('.prev-step').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const currentSection = this.closest('.form-section');
            const prevStep = this.dataset.prev;
            currentSection.classList.remove('active');
            document.getElementById(`section${prevStep}`).classList.add('active');
            updateStepper(prevStep);
        });
    });

    // Bouton Annuler
    const cancelButton = document.getElementById('cancelButton');
    if (cancelButton) {
        cancelButton.addEventListener('click', closeDevis);
    }
}
    
document.addEventListener('DOMContentLoaded', function() {
    console.log("Initialisation de la navigation par étapes");
    setupFormStepNavigation();
    
    // Debug : Affiche tous les champs requis
    document.querySelectorAll('[required]').forEach(field => {
        field.addEventListener('change', function() {
            console.log(`Champ ${this.name} modifié :`, this.value);
        });
    });
});

// Fonction utilitaire pour changer de section
function switchSection(currentSection, targetStep) {
    currentSection.classList.remove('active');
    const nextSection = document.getElementById(`section${targetStep}`);
    if (nextSection) {
        nextSection.classList.add('active');
        updateStepper(targetStep);
        
        // Scroll vers le haut pour une meilleure UX
        nextSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}
function closeModal() {
    // Sélectionne toutes les boîtes de dialogue avec la classe 'active'
    const openModals = document.querySelectorAll('.dialog-overlay.active, .modal-overlay.active, [id$="Modal"].active');
    
    // Parcourt toutes les boîtes de dialogue ouvertes et les ferme
    openModals.forEach(modal => {
        modal.classList.remove('active');
        
        // Déclenche un événement personnalisé pour notifier la fermeture
        const event = new CustomEvent('modalClosed', {
            detail: { modalId: modal.id || 'unknown' }
        });
        modal.dispatchEvent(event);
    });
    
    // Optionnel: Empêche le défilement du body quand aucun modal n'est ouvert
    document.body.style.overflow = 'auto';

    // Recharge la page Accueil.html uniquement si on est dessus (ou alors redirige)
    if (window.location.pathname.endsWith('Accueil.html')) {
        window.location.reload();
    }
}

function setupCurrentUserField() {
    // 1. Récupère l'utilisateur stocké
    const currentUser = sessionStorage.getItem("utilisateur") || localStorage.getItem("utilisateur");
    
    // 2. Trouve le champ utilisateur dans le formulaire
    const userField = document.getElementById('current_user');
    
    // 3. Si le champ existe et qu'on a un utilisateur
    if (userField && currentUser) {
        // a. Affiche le nom dans le champ visible
        userField.value = currentUser;
        
        // b. Crée un champ caché pour l'envoi au serveur
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'utilisateur';
        hiddenInput.value = currentUser;
        hiddenInput.id = 'hidden_utilisateur';
        
        // c. Ajoute le champ caché au formulaire (s'il n'existe pas déjà)
        if (!document.getElementById('hidden_utilisateur')) {
            document.getElementById('client-form').appendChild(hiddenInput);
        }
    }
}

</script>
</body>
</html>