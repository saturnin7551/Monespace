<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>DigitalOpti - Nouvelle Vente</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <style>
  /* General debut */
    :root {
            --primary-color: #4361ee;
            --primary-dark: #3a56d4;
            --secondary-color: #3f37c9;
            --accent-color: #4895ef;
            --light-accent: #4cc9f0;
            --success-color: #4ade80;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-color: #1e293b;
            --light-color: #f8fafc;
            --gray-color: #94a3b8;
            --sidebar-bg: #1e293b;
            --sidebar-text: #e2e8f0;
            --sidebar-hover: #334155;
            --sidebar-active: #4361ee;
            --card-bg: #ffffff;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --border-radius: 8px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Montserrat', sans-serif;
        }

        body {
            background-color: #f1f5f9;
            color: #334155;
        }

        .dashboard {
            display: flex;
            min-height: 100vh;
        }

        /* Main Content */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
              
        /* Dashboard Content */
        .dashboard-section {
            padding: 1.5rem;
            flex: 1;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .dashboard-header h1 {
            font-size: 1.75rem;
            color: var(--dark-color);
            font-weight: 600;
        }

        .dashboard-buttons {
            display: flex;
            gap: 0.75rem;
        }

        .btn {
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: white;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .btn-secondary:hover {
            background-color: #f8fafc;
        }

        /* Header */
        .header {
            background-color: var(--card-bg);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: var(--dark-color);
            font-size: 1.25rem;
            margin-right: 1rem;
            cursor: pointer;
        }

        .page-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .notifications {
            position: relative;
            cursor: pointer;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: bold;
        }

        .profile-dropdown {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .profile-name {
            font-weight: 500;
        }

        .profile-img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent-color);
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--card-bg);
            min-width: 200px;
            box-shadow: var(--card-shadow);
            border-radius: var(--border-radius);
            z-index: 10;
            padding: 0.5rem 0;
        }

        .dropdown-menu a {
            color: var(--dark-color);
            padding: 0.75rem 1.5rem;
            text-decoration: none;
            display: flex;
            align-items: center;
            transition: var(--transition);
        }

        .dropdown-menu a:hover {
            background-color: #f1f5f9;
            color: var(--primary-color);
        }

        .dropdown-menu a i {
            margin-right: 0.75rem;
            width: 20px;
            text-align: center;
        }

        .profile-dropdown:hover .dropdown-menu {
            display: block;
        }


        
        /* Sidebar */
        .sidebar {
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            width: 280px;
            padding: 1.5rem 1rem;
            transition: var(--transition);
            position: relative;
            z-index: 10;
        }

        .logo-container {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
            padding: 0 0.5rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
        }

        .logo i {
            margin-right: 0.75rem;
            color: var(--accent-color);
            font-size: 1.8rem;
        }

        .menu {
            margin-top: 1rem;
        }

        .menu-item {
            margin-bottom: 0.25rem;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .menu-link {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 0.75rem 1rem;
            color: var(--sidebar-text);
            text-decoration: none;
            transition: var(--transition);
            font-weight: 500;
        }

        .menu-link:hover {
            background-color: var(--sidebar-hover);
            color: white;
        }

        .menu-link i:first-child {
            margin-right: 0.75rem;
            width: 20px;
            text-align: center;
        }

        .menu-link .chevron {
            transition: transform 0.3s;
            font-size: 0.8rem;
        }

        .submenu {
            display: none;
            flex-direction: column;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }

        .submenu a {
            font-size: 0.9rem;
            padding: 0.65rem 1rem 0.65rem 2.5rem;
            color: var(--sidebar-text);
            text-decoration: none;
            transition: var(--transition);
            display: flex;
            align-items: center;
        }

        .submenu a i {
            margin-right: 0.75rem;
            font-size: 0.7rem;
            opacity: 0.7;
        }

        .submenu a:hover {
            background-color: var(--sidebar-hover);
            color: white;
            padding-left: 2.75rem;
        }

        .menu-item.active .submenu {
            display: flex;
        }

        .menu-item.active .menu-link .chevron {
            transform: rotate(180deg);
        }

        .menu-item.active .menu-link {
            background-color: var(--sidebar-active);
            color: white;
        }

  /* General fin */

        /* Main Content */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
              
        /* Dashboard Content */
        .dashboard-section {
            padding: 1.5rem;
            flex: 1;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .dashboard-header h1 {
            font-size: 1.75rem;
            color: var(--dark-color);
            font-weight: 600;
        }

        /* Styles spécifiques au formulaire de vente */
        .sale-form-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Indicateur d'étapes */
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            position: relative;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--gray-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 0.5rem;
            transition: var(--transition);
        }

        .step.active .step-number {
            background-color: var(--primary-color);
        }

        .step.completed .step-number {
            background-color: var(--success-color);
        }

        .step-label {
            font-size: 0.85rem;
            color: var(--gray-color);
            text-align: center;
            transition: var(--transition);
        }

        .step.active .step-label {
            color: var(--primary-color);
            font-weight: 500;
        }

        .step.completed .step-label {
            color: var(--success-color);
        }

        .step-progress {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 4px;
            background-color: #e2e8f0;
            z-index: 1;
        }

        .step-progress-bar {
            height: 100%;
            background-color: var(--success-color);
            width: 0%;
            transition: var(--transition);
        }

        /* Contenu des étapes */
        .form-step {
            display: none;
            background-color: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            margin-bottom: 1.5rem;
        }

        .form-step.active {
            display: block;
        }

        /* Grille de formulaire */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark-color);
        }

        .required-field::after {
            content: ' *';
            color: var(--danger-color);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-control:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(72, 149, 239, 0.2);
        }

        /* Tableau de prescription */
        .prescription-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            background-color: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }

        .prescription-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: 600;
        }

        .prescription-table td {
            padding: 1rem;
            border: 1px solid #e2e8f0;
            text-align: center;
        }

        .prescription-table select,
        .prescription-table input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            background-color: white;
        }

        /* Section paiement */
        .payment-card {
            background-color: #f8fafc;
            padding: 1rem;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
            margin-bottom: 1rem;
        }

        .payment-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .payment-group {
            flex: 1;
            min-width: 200px;
        }

        .payment-label {
            font-size: 0.85rem;
            color: var(--gray-color);
            margin-bottom: 0.25rem;
        }

        .payment-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .discount-selector {
            display: flex;
            gap: 0.5rem;
        }

        .discount-selector input {
            flex: 2;
        }

        .discount-selector select {
            flex: 1;
        }

        /* Navigation entre les étapes */
        .step-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e2e8f0;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
            border: none;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: white;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .btn-secondary:hover {
            background-color: #f8fafc;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .payment-row {
                flex-direction: column;
            }
            
            .step-navigation {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .step-navigation .btn {
                width: 100%;
            }
        }
        .loader-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.loader {
    width: 50px;
    height: 50px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loader-message {
    color: white;
    margin-top: 20px;
    text-align: center;
    font-size: 1.2rem;
}

.loader-content {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.loader-visible {
    opacity: 1;
    visibility: visible;
}

.success-message {
    background-color: var(--success-color);
    color: white;
    padding: 15px;
    border-radius: var(--border-radius);
    margin-top: 15px;
    display: none;
    animation: fadeIn 0.5s ease;
}

.error-message {
    background-color: var(--danger-color);
    color: white;
    padding: 15px;
    border-radius: var(--border-radius);
    margin-top: 15px;
    display: none;
    animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

    </style>
</head>
<body>
    <div class="dashboard">

        <aside class="sidebar">
            <div class="logo-container">
                <div class="logo">
                    <i class="fas fa-glasses"></i>
                    <span>DIGITAL OPTIC</span>
                </div>
            </div>

            <nav class="menu">
                <div class="menu-item">
                    <a class="menu-link">
                        <i class="fas fa-home"></i>
                        <span>Tableau de bord</span>
                        <i class="fas fa-chevron-down chevron"></i>
                    </a>
                    <div class="submenu">
                        <a href="#" onclick="openVueGlobale()"><i class="fas fa-chart-line"></i> Vue Globale</a>
                        <a href="#"><i class="fas fa-chart-pie"></i> Statistiques</a>
                    </div>
                </div>

                <div class="menu-item">
                    <a class="menu-link">
                        <i class="fas fa-bolt"></i>
                        <span>Accès Rapides</span>
                        <i class="fas fa-chevron-down chevron"></i>
                    </a>
                    <div class="submenu">
                        <a href="#"><i class="fas fa-search"></i> Recherche</a>
                        <a href="#"><i class="fas fa-history"></i> Historique</a>
                    </div>
                </div>

                <div class="menu-item active">
                    <a class="menu-link">
                        <i class="fas fa-shopping-cart"></i>
                        <span>Gestion des Ventes</span>
                        <i class="fas fa-chevron-down chevron"></i>
                    </a>
                    <div class="submenu">
                        <a href="#" onclick="openNewSale()"><i class="fas fa-plus-circle"></i> Nouvelle Vente</a>
                        <a href="#" onclick="openClientList()"><i class="fas fa-users"></i> Liste Clients</a>
                        <a href="#" onclick="openDevis()"><i class="fas fa-file-invoice"></i> Proforma</a>
                        <a href="#"><i class="fas fa-exchange-alt"></i> Retours</a>
                    </div>
                </div>

                <div class="menu-item">
                    <a class="menu-link">
                        <i class="fas fa-boxes"></i>
                        <span>Gestion Stock</span>
                        <i class="fas fa-chevron-down chevron"></i>
                    </a>
                    <div class="submenu">
                        <a href="#"><i class="fas fa-plus"></i> Entrée Produit</a>
                        <a href="#"><i class="fas fa-minus"></i> Destockage</a>
                        <a href="#"><i class="fas fa-glasses"></i> Montures</a>
                        <a href="#"><i class="fas fa-eye"></i> Verres</a>
                        <a href="#"><i class="fas fa-briefcase"></i> Etuis</a>
                        <a href="#"><i class="fas fa-spray-can"></i> Nettoyants</a>
                        <a href="#"><i class="fas fa-ellipsis-h"></i> Autres</a>
                    </div>
                </div>

                <div class="menu-item">
                    <a class="menu-link">
                        <i class="fas fa-shield-alt"></i>
                        <span>Assurances</span>
                        <i class="fas fa-chevron-down chevron"></i>
                    </a>
                    <div class="submenu">
                        <a href="#"><i class="fas fa-building"></i> Deals Assurance</a>
                        <a href="#"><i class="fas fa-truck"></i> Facturation</a>
                        <a href="#"><i class="fas fa-file-contract"></i> Contrats</a>
                    </div>
                </div>

                <div class="menu-item">
                    <a class="menu-link">
                        <i class="fas fa-bullhorn"></i>
                        <span>Marketing</span>
                        <i class="fas fa-chevron-down chevron"></i>
                    </a>
                    <div class="submenu">
                        <a href="#"><i class="fas fa-envelope"></i> Campagnes</a>
                        <a href="#"><i class="fas fa-chart-bar"></i> Analytique</a>
                        <a href="#"><i class="fas fa-gift"></i> Promotions</a>
                    </div>
                </div>

                <div class="menu-item">
                    <a class="menu-link">
                        <i class="fas fa-cog"></i>
                        <span>Paramètres</span>
                        <i class="fas fa-chevron-down chevron"></i>
                    </a>
                    <div class="submenu">
                        <a href="#"><i class="fas fa-user-cog"></i> Compte</a>
                        <a href="#"><i class="fas fa-sliders-h"></i> Préférences</a>
                    </div>
                </div>

                <div class="menu-item">
                    <a class="menu-link">
                        <i class="fas fa-users-cog"></i>
                        <span>Administration</span>
                        <i class="fas fa-chevron-down chevron"></i>
                    </a>
                    <div class="submenu">
                        <a href="#"><i class="fas fa-user-plus"></i> Utilisateurs</a>
                        <a href="#"><i class="fas fa-user-tag"></i> Rôles</a>
                        <a href="#"><i class="fas fa-clipboard-list"></i> Audit</a>
                    </div>
                </div>
            </nav>
        </aside>

        <div class="main">
            <header class="header">
                <div class="header-left">
                    <button class="mobile-menu-btn" id="mobileMenuBtn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title">Tableau de bord</h1>
                </div>
                
                <div class="user-info">
                    <div class="notifications">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge">3</span>
                    </div>
                    
                    <div class="profile-dropdown">
                        <span class="profile-name" id="username-display"></span>
                        <img src="https://ui-avatars.com/api/?name=John+Doe&background=4361ee&color=fff" alt="Profile" class="profile-img">
                        <div class="dropdown-menu">
                            <a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Déconnexion</a>
                        </div>
                    </div>
                </div>
            </header>
<script>
    // Vérification de la connexion et affichage du nom d'utilisateur
    document.addEventListener('DOMContentLoaded', function() {
        // Récupère le nom d'utilisateur depuis sessionStorage
        const username = sessionStorage.getItem("utilisateur") || localStorage.getItem("utilisateur");

        if (username) {
            // Affiche le nom d'utilisateur
            document.getElementById("username-display").textContent = username;

            // Met à jour l'image de profil avec les initiales
            const profileImg = document.querySelector('.profile-img');
            if (profileImg) {
                profileImg.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=4361ee&color=fff`;
            }
        } else {
            // Redirige vers la page de connexion si aucun utilisateur n'est connecté
            window.location.href = "code.html";
        }

        // Gestion de la déconnexion
        document.getElementById('logout-btn').addEventListener('click', function(e) {
            e.preventDefault();
            sessionStorage.removeItem("utilisateur");
            localStorage.removeItem("utilisateur");
            window.location.href = 'code.html';
        });
    });
    // Fonction combinée pour la gestion des menus et l'ouverture de nouvelle vente
    (function() {
        // Gestion des menus déroulants
        document.querySelectorAll('.menu-link').forEach(link => {
            link.addEventListener('click', function(e) {
                // Empêche le comportement par default si c'est un lien
                if (e.target.href) e.preventDefault();

                const currentItem = this.parentElement;

                // Fermer toutes les autres sections
                document.querySelectorAll('.menu-item').forEach(item => {
                    if (item !== currentItem) item.classList.remove('active');
                });

                // Basculer l'état de la section cliquée
                currentItem.classList.toggle('active');
            });
        });

        // Fonction pour ouvrir Acceuil
        window.openVueGlobale = function() {
            try {
                const salePath = 'Accueil.html';
                window.location.href = salePath;
            } catch (error) {
                console.error("Erreur d'ouverture:", error);
                alert("Impossible d'ouvrir la page. Contactez l'administrateur.");
            }
        };
        // Fonction pour ouvrir la nouvelle vente
        window.openNewSale = function() {
            try {
                const salePath = 'Ajout.html';
                window.location.href = salePath;
            } catch (error) {
                console.error("Erreur d'ouverture:", error);
                alert("Impossible d'ouvrir la page . Contactez l'administrateur.");
            }
        };

        // Fonction pour ouvrir la liste des clients
        window.openClientList = function() {
            try {
                const clientListPath = 'listeContact.html';
                window.location.href = clientListPath;
            } catch (error) {
                console.error("Erreur d'ouverture:", error);
                alert("Impossible d'ouvrir la page de la liste des clients. Contactez l'administrateur.");
            }
        };

        // Fonction pour ouvrir profoma
        window.openDevis = function() {
            try {
                const salePath = 'Proforma.html';
                window.location.href = salePath;
            } catch (error) {
                console.error("Erreur d'ouverture:", error);
                alert("Impossible d'ouvrir la page. Contactez l'administrateur.");
            }
        };
    })();

</script>

 <!-- Fin de la barre lateral et des element identique -->


            <section class="dashboard-section">
                <div class="dashboard-header">
                    <h1>Nouvelle Vente</h1>
                    <div class="dashboard-buttons">
                        <button class="btn btn-secondary" onclick="window.history.back()">
                            <i class="fas fa-arrow-left"></i> Retour
                        </button>
                    </div>
                </div>

                <div class="sale-form-container">
                    <form id="client-form" method="POST">
                        <input type="hidden" name="source" value="web_form">
                        
                        <!-- Indicateur d'étapes -->
                        <div class="step-indicator">
                            <div class="step active" data-step="1">
                                <div class="step-number">1</div>
                                <div class="step-label">Informations Client</div>
                            </div>
                            <div class="step" data-step="2">
                                <div class="step-number">2</div>
                                <div class="step-label">Prescription</div>
                            </div>
                            <div class="step" data-step="3">
                                <div class="step-number">3</div>
                                <div class="step-label">Commande</div>
                            </div>
                            <div class="step" data-step="4">
                                <div class="step-number">4</div>
                                <div class="step-label">Assurance</div>
                            </div>
                            <div class="step" data-step="5">
                                <div class="step-number">5</div>
                                <div class="step-label">Paiement</div>
                            </div>
                            <div class="step" data-step="6">
                                <div class="step-number">6</div>
                                <div class="step-label">Livraison</div>
                            </div>
                            <div class="step-progress">
                                <div class="step-progress-bar" id="stepProgressBar"></div>
                            </div>
                        </div>

                        <!-- Étape 1: Informations Client -->
                        <div id="step-1" class="form-step active">
                            <h2 class="section-title">Informations Client</h2>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="nom_complet" class="required-field">Nom complet</label>
                                    <input type="text" name="nom_complet" id="nom_complet" class="form-control" required />
                                </div>

                                <div class="form-group">
                                    <label for="numero" class="required-field">Téléphone</label>
                                    <input type="tel" name="numero" id="numero" class="form-control" placeholder="2290163333964" required />
                                </div>

                                <div class="form-group">
                                    <label for="date_naissance" class="required-field">Date de naissance</label>
                                    <input type="date" name="date_naissance" id="date_naissance" class="form-control" required />
                                </div>

                                <div class="form-group">
                                    <label for="civilite" class="required-field">Civilité</label>
                                    <select name="civilite" id="civilite" class="form-control" required>
                                        <option value="M.">M.</option>
                                        <option value="Mme">Mme</option>
                                        <option value="Mlle">Mlle</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="entreprise">Entreprise</label>
                                    <select name="entreprise" id="entreprise" class="form-control">
                                        <option value="">-- Choisir --</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="agence" class="required-field">Agence</label>
                                    <select name="agence" id="agence" class="form-control" required>
                                        <option value="">-- Choisir --</option>
                                        <option value="cotonou">Cotonou</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="commercial" class="required-field">Commercial</label>
                                    <select name="commercial" id="commercial" class="form-control" required>
                                        <option value="">-- Commercial --</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Étape 2: Prescription -->
                        <div id="step-2" class="form-step">
                            <h2 class="section-title">Prescription Médicale</h2>
                            
                            <table class="prescription-table">
                                <thead>
                                    <tr>
                                        <th>Œil</th>
                                        <th>Sphere</th>
                                        <th>Cylindre</th>
                                        <th>Axe</th>
                                        <th>ADD</th>
                                        <th>DP</th>
                                        <th>Hauteur</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- OD -->
                                    <tr>
                                        <td>OD</td>
                                        <td>
                                            <select name="od_sphere" required>
                                                <option value="">-- Choisir --</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select name="od_cylindre">
                                                <option value="">-- Choisir --</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select name="od_axe">
                                                <option value="">-- Choisir --</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select name="od_add">
                                                <option value="">-- Choisir --</option>
                                            </select>
                                        </td>
                                        <td>
                                            <input type="number" name="od_dp" value="0" min="0">
                                        </td>
                                        <td>
                                            <input type="number" name="od_hauteur" value="0" min="0">
                                        </td>
                                    </tr>

                                    <!-- OG -->
                                    <tr>
                                        <td>OG</td>
                                        <td>
                                            <select name="og_sphere" required>
                                                <option value="">-- Choisir --</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select name="og_cylindre">
                                                <option value="">-- Choisir --</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select name="og_axe">
                                                <option value="">-- Choisir --</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select name="og_add">
                                                <option value="">-- Choisir --</option>
                                            </select>
                                        </td>
                                        <td>
                                            <input type="number" name="og_dp" value="0" min="0">
                                        </td>
                                        <td>
                                            <input type="number" name="og_hauteur" value="0" min="0">
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="clinique">Clinique</label>
                                    <select name="clinique" id="clinique" class="form-control">
                                        <option value="">-- Choisir --</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="ophtalmo">Ophtalmologue</label>
                                    <select name="ophtalmo" id="ophtalmo" class="form-control">
                                        <option value="">-- Choisir --</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="date_soin">Date de soin</label>
                                    <input type="date" name="date_soin" id="date_soin" class="form-control" />
                                </div>
                            </div>
                        </div>

                        <!-- Étape 3: Commande -->
                        <div id="step-3" class="form-step">
                            <h2 class="section-title">Détails de la Commande</h2>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="type_verre" class="required-field">Type de Verre</label>
                                    <select name="type_verre" id="type_verre" class="form-control" required>
                                        <option value="">-- Type de Verre --</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="gamme_verre" class="required-field">Gamme des Verres</label>
                                    <select name="gamme_verre" id="gamme_verre" class="form-control" required>
                                        <option value="">-- Gamme --</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="choix_monture" class="required-field">Choix de Monture</label>
                                    <select name="choix_monture" id="choix_monture" class="form-control" required>
                                        <option value="">-- Choix de Monture --</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Étape 4: Assurance -->
                        <div id="step-4" class="form-step">
                            <h2 class="section-title">Tier Payant</h2>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="assurance">Assurance</label>
                                    <select name="assurance" id="assurance" class="form-control">
                                        <option value="">-- Choisir --</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="compagnie">Compagnie</label>
                                    <select name="compagnie" id="compagnie" class="form-control">
                                        <option value="">-- Choisir --</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="numero_police">N° Police</label>
                                    <input type="text" name="numero_police" id="numero_police" class="form-control" placeholder="Numéro de police d'assurance" />
                                </div>
                                
                                <div class="form-group">
                                    <label for="taux_couverture">Taux de couverture (%)</label>
                                    <input type="number" name="taux_couverture" id="taux_couverture" class="form-control" placeholder="Ex: 80" min="0" max="100" />
                                </div>
                                
                                <div class="form-group">
                                    <label for="assure_principal">Assuré Principal</label>
                                    <select name="assure_principal" id="assure_principal" class="form-control">
                                        <option value="">-- Choisir --</option>
                                        <option value="oui">Oui</option>
                                        <option value="non">Non</option>
                                    </select>
                                </div>

                                <div class="form-group" id="assure_principal_nom_container" style="display: none;">
                                    <label class="required-field">Nom complet de l'assuré principal</label>
                                    <input type="text" name="assure_principal_nom" id="assure_principal_nom" class="form-control" />
                                </div>
                            </div>
                        </div>

                        <!-- Étape 5: Paiement -->
                        <div id="step-5" class="form-step">
                            <h2 class="section-title">Détails de Paiement</h2>
                            
                            <div class="payment-card">
                                <div class="payment-row">
                                    <div class="payment-group">
                                        <label class="payment-label required-field">Montant Monture (FCFA)</label>
                                        <input type="number" class="form-control" name="montant_monture" id="montant_monture" required oninput="calculerTotal()" />
                                    </div>
                                    
                                    <div class="payment-group">
                                        <label class="payment-label required-field">Montant Verres (FCFA)</label>
                                        <input type="number" class="form-control" name="montant_verres" id="montant_verres" required oninput="calculerTotal()" />
                                    </div>
                                    
                                    <div class="payment-group">
                                        <label class="payment-label">Frais de livraison (FCFA)</label>
                                        <input type="number" class="form-control" name="frais_livraison" id="frais_livraison" value="0" oninput="calculerTotal()" />
                                    </div>
                                </div>
                            </div>
                            
                            <div class="payment-card">
                                <div class="payment-row">
                                    <div class="payment-group">
                                        <label class="payment-label">Total Brut (FCFA)</label>
                                        <div class="payment-value" id="total_brut_display">0</div>
                                        <input type="hidden" name="total_brut" id="total_brut" />
                                    </div>
                                    
                                    <div class="payment-group">
                                        <label class="payment-label">Remise</label>
                                        <div class="discount-selector">
                                            <input type="number" class="form-control discount-amount" name="remise" id="remise" value="0" oninput="calculerTotal()" />
                                            <select class="form-control discount-type" name="remise_type" id="remise_type" onchange="calculerTotal()">
                                                <option value="FCFA">FCFA</option>
                                                <option value="%">%</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="payment-group">
                                        <label class="payment-label">Part Assurance (FCFA)</label>
                                        <input type="number" class="form-control" name="part_assurance" id="part_assurance" value="0" oninput="calculerTotal()" />
                                    </div>
                                </div>
                            </div>
                            
                            <div class="payment-card">
                                <div class="payment-row">
                                    <div class="payment-group">
                                        <label class="payment-label">Net à payer (FCFA)</label>
                                        <div class="payment-value" id="net_a_payer_display">0</div>
                                        <input type="hidden" name="net_a_payer" id="net_a_payer" />
                                    </div>
                                    
                                    <div class="payment-group">
                                        <label class="payment-label">Acompte (FCFA)</label>
                                        <input type="number" class="form-control" name="acompte" id="acompte" value="0" oninput="calculerTotal()" />
                                    </div>
                                    
                                    <div class="payment-group">
                                        <label class="payment-label">Reste à payer (FCFA)</label>
                                        <div class="payment-value" id="reste_a_payer_display">0</div>
                                        <input type="hidden" name="reste_a_payer" id="reste_a_payer" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Étape 6: Livraison -->
                        <div id="step-6" class="form-step">
                            <h2 class="section-title">Informations de Livraison</h2>
                            
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="required-field">Date de livraison prévue</label>
                                    <input type="date" class="form-control" name="date_livraison" id="date_livraison" required />
                                </div>
                                
                                <div class="form-group">
                                    <label class="required-field">Personne à contacter</label>
                                    <select class="form-control" name="contact_livraison_type" id="contact_livraison_type" required>
                                        <option value="">-- Choisir --</option>
                                        <option value="client">Lui-même</option>
                                        <option value="tiers">Tier Personne</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="required-field">Téléphone du contact</label>
                                    <input type="tel" class="form-control" name="telephone_contact" id="telephone_contact" required />
                                </div>
                                
                                <div class="form-group" style="grid-column: span 2">
                                    <label class="required-field">Adresse de livraison</label>
                                    <textarea class="form-control" name="adresse_livraison" id="adresse_livraison" rows="3" required></textarea>
                                </div>
                                
                                <div class="form-group" style="grid-column: span 2">
                                    <label>Informations complémentaires</label>
                                    <textarea class="form-control" name="infos_complementaires" id="infos_complementaires" rows="3"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Navigation entre les étapes -->
                        <div class="step-navigation">
                            <button type="button" class="btn btn-secondary" id="prevStepBtn" style="display: none;">
                                <i class="fas fa-arrow-left"></i> Précédent
                            </button>
                            
                            <div style="flex: 1;"></div> <!-- Espaceur -->
                            
                            <button type="button" class="btn btn-danger" id="resetButton">
                                <i class="fas fa-undo"></i> Réinitialiser
                            </button>
                            
                            <button type="button" class="btn btn-secondary" id="cancelButton">
                                <i class="fas fa-times"></i> Annuler
                            </button>
                            
                            <button type="button" class="btn btn-primary" id="nextStepBtn">
                                Suivant <i class="fas fa-arrow-right"></i>
                            </button>
                            
                            <button type="submit" class="btn btn-primary" id="submitBtn" style="display: none;">
                                <i class="fas fa-save"></i> Enregistrer
                            </button>
                        </div>
                    </form>
                </div>
            </section>
        </div>
    </div>
<div class="loader-container" id="loaderContainer">
    <div class="loader-content">
        <div class="loader"></div>
        <div class="loader-message" id="loaderMessage">Chargement en cours...</div>
    </div>
</div>
    <script>
        // URL de votre Web App Google Apps Script
        const DATA_SOURCE_URL = 'https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=catalogue';
        const SUBMIT_URL = "https://script.google.com/macros/s/AKfycbysh1x1-9a-sf2fu3Dn83sa1EbG6CpjLlVmbW0Fhkhxfkc2GC1uD55YCf-34CK8QGIv/exec?action=addCommandeClient";

        // Cache pour stocker les données chargées
        let appDataCache = null;
        let currentStep = 1;
        const totalSteps = 6;

        // Initialisation au chargement
        document.addEventListener('DOMContentLoaded', async () => {
            // Configurer les événements
            setupEventListeners();
            
            // Calcul initial
            calculerTotal();
            
            // Charger les données depuis Google Sheets
            await loadDataFromSheet();
            
            // Mettre à jour l'affichage des étapes
            updateStepDisplay();
        });

        // Mettre à jour l'affichage des étapes
        function updateStepDisplay() {
            // Masquer toutes les étapes
            document.querySelectorAll('.form-step').forEach(step => {
                step.classList.remove('active');
            });
            
            // Afficher l'étape actuelle
            document.getElementById(`step-${currentStep}`).classList.add('active');
            
            // Mettre à jour l'indicateur d'étapes
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active', 'completed');
                const stepNumber = parseInt(step.getAttribute('data-step'));
                
                if (stepNumber === currentStep) {
                    step.classList.add('active');
                } else if (stepNumber < currentStep) {
                    step.classList.add('completed');
                }
            });
            
            // Mettre à jour la barre de progression
            const progressPercentage = ((currentStep - 1) / (totalSteps - 1)) * 100;
            document.getElementById('stepProgressBar').style.width = `${progressPercentage}%`;
            
            // Gérer les boutons de navigation
            document.getElementById('prevStepBtn').style.display = currentStep > 1 ? 'block' : 'none';
            
            if (currentStep < totalSteps) {
                document.getElementById('nextStepBtn').style.display = 'block';
                document.getElementById('submitBtn').style.display = 'none';
            } else {
                document.getElementById('nextStepBtn').style.display = 'none';
                document.getElementById('submitBtn').style.display = 'block';
            }
        }

        // Aller à l'étape suivante
        function nextStep() {
            // Validation de l'étape actuelle
            if (!validateStep(currentStep)) {
                return;
            }
            
            if (currentStep < totalSteps) {
                currentStep++;
                updateStepDisplay();
                
                // Faire défiler vers le haut de la page
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Revenir à l'étape précédente
        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepDisplay();
                
                // Faire défiler vers le haut de la page
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Valider l'étape actuelle
        function validateStep(step) {
            let isValid = true;
            
            // Validation pour l'étape 1 (Informations Client)
            if (step === 1) {
                const requiredFields = [
                    'nom_complet', 'numero', 'date_naissance', 
                    'civilite', 'agence', 'commercial'
                ];
                
                for (const fieldId of requiredFields) {
                    const field = document.getElementById(fieldId);
                    if (field && !field.value) {
                        field.style.borderColor = 'var(--danger-color)';
                        isValid = false;
                    } else if (field) {
                        field.style.borderColor = '';
                    }
                }
                
                if (!isValid) {
                    alert('Veuillez remplir tous les champs obligatoires');
                }
            }
            
            // Validation pour l'étape 2 (Prescription)
            if (step === 2) {
                const requiredFields = ['od_sphere', 'og_sphere'];
                
                for (const fieldName of requiredFields) {
                    const field = document.getElementsByName(fieldName)[0];
                    if (field && !field.value) {
                        field.style.borderColor = 'var(--danger-color)';
                        isValid = false;
                    } else if (field) {
                        field.style.borderColor = '';
                    }
                }
                
                if (!isValid) {
                    alert('Veuillez remplir les champs obligatoires de la prescription');
                }
            }
            
            // Validation pour l'étape 3 (Commande)
            if (step === 3) {
                const requiredFields = ['type_verre', 'gamme_verre', 'choix_monture'];
                
                for (const fieldId of requiredFields) {
                    const field = document.getElementById(fieldId);
                    if (field && !field.value) {
                        field.style.borderColor = 'var(--danger-color)';
                        isValid = false;
                    } else if (field) {
                        field.style.borderColor = '';
                    }
                }
                
                if (!isValid) {
                    alert('Veuillez sélectionner le type de verre, la gamme et la monture');
                }
            }
            
            // Validation pour l'étape 6 (Livraison)
            if (step === 6) {
                const requiredFields = [
                    'date_livraison', 'contact_livraison_type', 
                    'telephone_contact', 'adresse_livraison'
                ];
                
                for (const fieldId of requiredFields) {
                    const field = document.getElementById(fieldId);
                    if (field && !field.value) {
                        field.style.borderColor = 'var(--danger-color)';
                        isValid = false;
                    } else if (field) {
                        field.style.borderColor = '';
                    }
                }
                
                if (!isValid) {
                    alert('Veuillez remplir tous les champs obligatoires pour la livraison');
                }
            }
            
            return isValid;
        }

        // Configuration des événements
        function setupEventListeners() {
            // Boutons de navigation
            document.getElementById('nextStepBtn').addEventListener('click', nextStep);
            document.getElementById('prevStepBtn').addEventListener('click', prevStep);
            
            // Boutons d'action
            document.getElementById('cancelButton').addEventListener('click', () => {
                if (confirm('Voulez-vous vraiment annuler et réinitialiser le formulaire ?')) {
                    document.getElementById('client-form').reset();
                    calculerTotal();
                    window.location.href = 'Accueil.html';
                }
            });

            document.getElementById('resetButton').addEventListener('click', () => {
                if (confirm('Voulez-vous vraiment réinitialiser le formulaire ?')) {
                    document.getElementById('client-form').reset();
                    document.getElementById('nom_complet').focus();
                    calculerTotal();
                    alert('Formulaire réinitialisé avec succès !');
                }
            });
            // Calcul automatique pour tous les champs pertinents
            const calcFields = [
                'montant_monture', 'montant_verres', 'frais_livraison',
                'remise', 'part_assurance', 'acompte'
            ];
            calcFields.forEach(id => {
                document.getElementById(id)?.addEventListener('input', calculerTotal);
            });
            
            // Écouteur pour le type de remise (FCFA ou %)
            document.getElementById('remise_type')?.addEventListener('change', calculerTotal);
            
            // Synchronisation automatique de l'ADD OD vers OG
            document.getElementsByName('od_add')[0]?.addEventListener('change', function() {
                const odAddValue = this.value;
                const ogAddSelect = document.getElementsByName('og_add')[0];
                if (odAddValue && ogAddSelect) {
                    ogAddSelect.value = odAddValue;
                }
            });
            
            // Gestion de l'affichage conditionnel pour l'assuré principal
            document.getElementById('assure_principal')?.addEventListener('change', function() {
                const container = document.getElementById('assure_principal_nom_container');
                const input = document.getElementById('assure_principal_nom');
                
                if (!container || !input) return;
                
                if (this.value === 'oui') {
                    container.style.display = 'block';
                    input.value = document.getElementById('nom_complet')?.value || '';
                    input.readOnly = true;
                    input.style.backgroundColor = '#f0f0f0';
                } else if (this.value === 'non') {
                    container.style.display = 'block';
                    input.readOnly = false;
                    input.style.backgroundColor = '';
                    input.value = '';
                } else {
                    container.style.display = 'none';
                }
            });
            
            // Gestion du type de contact pour la livraison
            document.getElementById('contact_livraison_type')?.addEventListener('change', function() {
                const telephoneContact = document.getElementById('telephone_contact');
                const adresseLivraison = document.getElementById('adresse_livraison');
                const clientTel = document.getElementById('numero')?.value || '';
                const agence = document.getElementById('agence')?.value || '';
                
                if (!telephoneContact || !adresseLivraison) return;
                
                if (this.value === 'client') {
                    telephoneContact.value = clientTel;
                    telephoneContact.readOnly = true;
                    telephoneContact.style.backgroundColor = '#f0f0f0';
                    
                    if (agence) {
                        const adressesAgences = {
                            'cotonou': '123 Rue des Agences, Cotonou, Bénin',
                            // Ajouter d'autres agences si nécessaire
                        };
                        
                        adresseLivraison.value = adressesAgences[agence] || agence;
                        adresseLivraison.readOnly = true;
                        adresseLivraison.style.backgroundColor = '#f0f0f0';
                        document.getElementById('frais_livraison').value = 0;
                        calculerTotal();
                    }
                } else if (this.value === 'tiers') {
                    telephoneContact.readOnly = false;
                    telephoneContact.style.backgroundColor = '';
                    if (telephoneContact.value === clientTel) {
                        telephoneContact.value = '';
                    }
                    
                    adresseLivraison.readOnly = false;
                    adresseLivraison.style.backgroundColor = '';
                    adresseLivraison.value = '';
                } else {
                    telephoneContact.readOnly = false;
                    telephoneContact.style.backgroundColor = '';
                    telephoneContact.value = '';
                    
                    adresseLivraison.readOnly = false;
                    adresseLivraison.style.backgroundColor = '';
                    adresseLivraison.value = '';
                }
            });

            // Ajouter un écouteur pour l'agence
            document.getElementById('agence')?.addEventListener('change', function() {
                const contactType = document.getElementById('contact_livraison_type');
                if (contactType && contactType.value === 'client') {
                    const adresseLivraison = document.getElementById('adresse_livraison');
                    const agence = this.value;
                    
                    const adressesAgences = {
                        'cotonou': '123 Rue des Agences, Cotonou, Bénin',
                        // Ajouter d'autres agences si nécessaire
                    };
                    
                    if (adresseLivraison) {
                        adresseLivraison.value = adressesAgences[agence] || agence;
                    }
                }
            });
        }

        // Calculs financiers
        function calculerTotal() {
            const getValue = id => {
                const element = document.getElementById(id);
                if (!element) return 0;
                const value = parseFloat(element.value);
                return isNaN(value) ? 0 : value;
            };

            const montantMonture = getValue('montant_monture');
            const montantVerres = getValue('montant_verres');
            const fraisLivraison = getValue('frais_livraison');
            const remise = getValue('remise');
            const remiseType = document.getElementById('remise_type')?.value || 'FCFA';
            const partAssurance = getValue('part_assurance');
            const acompte = getValue('acompte');
            
            // Calculs
            const totalBrut = montantMonture + montantVerres + fraisLivraison;
            let montantRemise = 0;
            if (remiseType === '%') {
                montantRemise = totalBrut * (remise / 100);
            } else {
                montantRemise = remise;
            }

            const netAPayer = Math.max(0, totalBrut - montantRemise - partAssurance);
            const resteAPayer = Math.max(0, netAPayer - acompte);
            
            // Affichage
            document.getElementById('total_brut').value = Math.round(totalBrut);
            document.getElementById('total_brut_display').textContent = Math.round(totalBrut).toLocaleString();
            
            document.getElementById('net_a_payer').value = Math.round(netAPayer);
            document.getElementById('net_a_payer_display').textContent = Math.round(netAPayer).toLocaleString();
            
            document.getElementById('reste_a_payer').value = Math.round(resteAPayer);
            document.getElementById('reste_a_payer_display').textContent = Math.round(resteAPayer).toLocaleString();
        }

        // Fonction pour remplir une liste déroulante
        function populateSelect(id, options) {
            const select = document.getElementById(id);
            if (!select) return;
            
            // Sauvegarder la valeur sélectionnée actuelle
            const currentValue = select.value;
            
            // Vider le select sauf la première option
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // Ajouter les nouvelles options
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                select.appendChild(opt);
            });
            
            // Restaurer la valeur sélectionnée si elle existe toujours
            if (currentValue && options.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        // Fonction pour remplir les options de prescription
        function populatePrescriptionOptions(selectName, values) {
            const selects = document.getElementsByName(selectName);
            if (!selects || selects.length === 0) return;
            
            const select = selects[0];
            const currentValue = select.value;
            
            // Vider le select sauf la première option
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // Ajouter les nouvelles options
            values.forEach(value => {
                const opt = document.createElement('option');
                opt.value = value;
                opt.textContent = value;
                select.appendChild(opt);
            });
            
            // Restaurer la valeur sélectionnée si elle existe toujours
            if (currentValue && values.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        // Fonction principale de chargement des données
async function loadDataFromSheet() {
    // Afficher le loader
    showLoader('Chargement des données...');
    
    // Si les données sont déjà en cache, les utiliser
    if (appDataCache) {
        populateFormWithData(appDataCache);
        hideLoader();
        return;
    }

    try {
        const response = await fetch(DATA_SOURCE_URL);
        if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
        
        const data = await response.json();

        if (!data.success) throw new Error("Réponse invalide du serveur.");

        // Mettre en cache les données
        appDataCache = data;
        
        // Remplir le formulaire avec les données
        populateFormWithData(data);
        
        hideLoader();

    } catch (error) {
        console.error('Erreur lors du chargement des données:', error);
        hideLoader();
        showError('Erreur lors du chargement des données. Veuillez recharger la page.');
    }
}

<!-- Ajoutez ces fonctions utilitaires dans le script -->
function showLoader(message = 'Chargement en cours...') {
    const loaderContainer = document.getElementById('loaderContainer');
    const loaderMessage = document.getElementById('loaderMessage');
    
    if (loaderContainer && loaderMessage) {
        loaderMessage.textContent = message;
        loaderContainer.classList.add('loader-visible');
    }
}

function hideLoader() {
    const loaderContainer = document.getElementById('loaderContainer');
    if (loaderContainer) {
        loaderContainer.classList.remove('loader-visible');
    }
}

function showSuccess(message) {
    hideLoader();
    
    const successDiv = document.createElement('div');
    successDiv.className = 'success-message';
    successDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
    document.body.appendChild(successDiv);
    successDiv.style.display = 'block';
    
    setTimeout(() => {
        successDiv.style.display = 'none';
        setTimeout(() => {
            document.body.removeChild(successDiv);
        }, 500);
    }, 3000);
}

function showError(message) {
    hideLoader();
    
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
    document.body.appendChild(errorDiv);
    errorDiv.style.display = 'block';
    
    setTimeout(() => {
        errorDiv.style.display = 'none';
        setTimeout(() => {
            document.body.removeChild(errorDiv);
        }, 500);
    }, 5000);
}

        // Fonction pour remplir le formulaire avec les données
        function populateFormWithData(data) {
            populateSelect('entreprise', data.entreprises || []);
            populateSelect('agence', data.agences || []);
            populateSelect('commercial', data.commerciaux || []);
            populateSelect('type_verre', data.typesVerre || []);
            populateSelect('gamme_verre', data.gammesVerre || []);
            populateSelect('choix_monture', data.montures || []);
            populateSelect('clinique', data.cliniques || []);
            populateSelect('ophtalmo', data.ophtalmos || []);
            populateSelect('assurance', data.assurances || []);
            populateSelect('compagnie', data.compagnies || []);

            // OD
            populatePrescriptionOptions('od_sphere', data.sphere || []);
            populatePrescriptionOptions('od_cylindre', data.sphere || []);
            populatePrescriptionOptions('od_axe', data.axe || []);
            populatePrescriptionOptions('od_add', data.add || []);

            // OG
            populatePrescriptionOptions('og_sphere', data.sphere || []);
            populatePrescriptionOptions('og_cylindre', data.sphere || []);
            populatePrescriptionOptions('og_axe', data.axe || []);
            populatePrescriptionOptions('og_add', data.add || []);
        }

        // Soumission du formulaire
document.getElementById('client-form').addEventListener('submit', async function(event) {
    event.preventDefault();

    // Validation rapide du formulaire
    if (!document.getElementById('nom_complet').value) {
        showError('Veuillez renseigner le nom complet du client');
        return;
    }

    const form = event.target;
    const formData = new FormData(form);
    const data = {};
    for (let [key, value] of formData.entries()) {
        data[key] = value;
    }

    showLoader('Envoi des données en cours...');

    try {
        const response = await fetch(SUBMIT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        });

        // Comme nous utilisons no-cors, nous ne pouvons pas vérifier la réponse
        // Mais nous supposons que si la requête est partie, c'est bon
        showSuccess('Données envoyées avec succès ! Redirection en cours...');
        
        // Réinitialiser le formulaire après un délai
        setTimeout(() => {
            form.reset();
            calculerTotal();
            window.location.href = 'Accueil.html';
        }, 2000);

    } catch (error) {
        console.error('Erreur lors de l\'envoi des données :', error);
        showError('Erreur lors de l\'envoi des données. Veuillez réessayer.');
    }
});
    </script>
</body>
</html>
